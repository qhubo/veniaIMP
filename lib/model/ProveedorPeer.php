<?php



/**
 * Skeleton subclass for performing query and update operations on the 'proveedor' table.
 *
 *
 *
 * This class was autogenerated by Propel 1.6.7 on:
 *
 * 03/21/21 04:53:31
 *
 * You should add additional methods to this class to meet the
 * application requirements.  This class will only be generated as
 * long as it does not already exist in the output directory.
 *
 * @package    propel.generator.lib.model
 */
class ProveedorPeer extends BaseProveedorPeer
{
    
      static public function limpiatil($subject) {
        $subject = str_replace("á", 'a', $subject);
        $subject = str_replace("é", 'e', $subject);
        $subject = str_replace("í", 'i', $subject);
        $subject = str_replace("ó", 'o', $subject);
        $subject = str_replace("ú", 'u', $subject);
        $subject = str_replace("Á", 'A', $subject);
        $subject = str_replace("É", 'E', $subject);
        $subject = str_replace("Í", 'I', $subject);
        $subject = str_replace("Ó", 'O', $subject);
        $subject = str_replace("Ú", 'U', $subject);
        return $subject;
    }

    static public function pobladatos($id, $empresaId = null) {
       
        $usuarioId = sfContext::getInstance()->getUser()->getAttribute('usuario', null, 'seguridad');
        $usuarioQue = UsuarioQuery::create()->findOneById($usuarioId);
        $empresaId = $usuarioQue->getEmpresaId();
                $lineaInicial = 2;
//        $carga = PlantillaCargaQuery::create()->findOneByNombreEmpresa($empresaId);
//        if ($carga) {
//            $lineaInicial =$carga->getNumeroLinea();
//        }
                        $lineaInicial=2;
//        echo $lineaInicial;
//        die();
   //     header('Content-type: text/plain; charset=utf-8');
        $bitacora = BitacoraArchivoQuery::create()->findOneById($id);
        sfContext::getInstance()->getUser()->setAttribute('muestrabusqueda', 0, 'busqueda');
        $filename = $bitacora->getNombre();
 
        $inputFileName = sfConfig::get("sf_upload_dir") . DIRECTORY_SEPARATOR . 'cargas' . DIRECTORY_SEPARATOR . $filename;
     
        $objReader = new PHPExcel_Reader_Excel5();
        $objPHPExcel = $objReader->load($inputFileName);
        $sheetData = $objPHPExcel->getActiveSheet()->toArray(null, true, true, true);
  
        $contador = 0;
        $colCODIGO = null;
        $colCODIGOANTERIOR = null;
        $colCodGrupo = null;
        $colGRUPO = null;
        $colCodSUBGRUPO = null;
        $colSUBGRUPO = null;
        $colCodCATEGORIA = null;
        $colCATEGORIA = null;
        $colNOMBRE = null;
        $colDESCRIPCION = null;
        $colPrecio = null;
        $colCosto = null;
        $colperecedero = null;
        $colCodProveedor = null;
        $colProveedor = null;

$colUnidadCosto=null;
        $colPROMOCIONAL = null;
        $colTRASLADO = null;
        $colTOP_VENTA = null;
        $colSALIDA = null;
        $colAFECTO_INVENTARIO = null;
        $colF=null;
        $datos = null;
        $NUMERO = 0;

        foreach ($sheetData as $registro) {
            $lista = null;
            $UnidadCosto=null;
            $CODIGO = '';
            $CODIGOANTERIOR = '';
            $CODIGO_GRUPO = '';
            $GRUPO = '';
            $CODIGO_SUBGRUPO = '';
            $SUBGRUPO = '';
            $CODIGO_CATEGORIA = '';
            $CATEGORIA = '';
            $NOMBRE = '';
            $COSTO = 0;
            $perecedero= '';
            $COD_PROVEEDOR = '';
            $PROVEEDOR = '';
            $DESCRIPCION = '';
            $PROMOCIONAL = 'SI';
            $TRASLADO = 'SI';
            $TOP_VENTA = 'SI';
            $SALIDA = 'SI';
            $CANTIDAD=0;
            $AFECTO_INVENTARIO = 'SI';
            $precio = 0;
            $valido = true;
            $contador++;
            $textoPendiente = '';
            $pendientes = null;
            $lin=$lineaInicial;
            /// encabezado
        //   echo  'codigo_sku');
            if ($contador == $lineaInicial) {
                
       
                for ($i = 0; $i <= 16; $i++) {
                    $letra = CorrelativoCodigoQuery::numeroletra($i); //sfContext::getInstance()->getUser()->numeroletra($i);
                    $campo = trim(strtoupper(($registro[$letra])));
                    $campo = ($campo);
//                    $campo = ProveedorPeer::limpiatil($campo);
                    $campo = trim(strtoupper($campo));
                    $campo = str_replace(" ", "", $campo); //                  
//                         echo $campo;
//                        echo " ------------- ";
                    switch ($campo) {

                        case   trim(strtoupper(('codigo_sku'))):
                            $colCODIGO = $letra;
                            break;
                        case  trim(strtoupper(('codigo_barras'))):
                            $colCODIGOANTERIOR = $letra;
                            break;
                        case  trim(strtoupper(('codigo_grupo'))):
                            $colCodGrupo = $letra;
                            break;
                        case  trim(strtoupper(('grupo'))):
                            $colGRUPO = $letra;
                            break;
                        case  trim(strtoupper(('codigo_subgrupo'))):
                            $colCodSUBGRUPO = $letra;
                            break;
                        case  trim(strtoupper(('subgrupo'))):
                            $colSUBGRUPO = $letra;
                            break;
                        case  trim(strtoupper(('codigo_categoria'))):
                            $colCodCATEGORIA = $letra;
                            break;
                        case  trim(strtoupper(('categoria'))):
                            $colCATEGORIA = $letra;
                            break;
                        case  trim(strtoupper(('nombre'))):
                            $colNOMBRE = $letra;
                            break;
                        case  trim(strtoupper(('descripcion'))):
                            $colDESCRIPCION = $letra;
                            break;
                        case  trim(strtoupper(('precio'))):
                            $colPrecio = $letra;
                            break;
                        case  trim(strtoupper(('costo'))):
                            $colCosto = $letra;
                            break;
                        case  trim(strtoupper(('perecedero'))):
                            $colperecedero = $letra;
                            break;
                        case  trim(strtoupper(('codigo_proveedor'))):
                            $colCodProveedor = $letra;
                            break;
                        case  trim(strtoupper(('proveedor'))):
                            $colProveedor = $letra;
                            break;
                        case  trim(strtoupper(('proveedor'))):
                            $colProveedor = $letra;
                            break;
                        case  trim(strtoupper(('cantidad'))):
                            $colCANTIDAD = $letra;
                            break;                        
//                        case  trim(strtoupper(('unidad_costo'))):
//                            $colUnidadCosto = $letra;
//                            break;
                        
//                        case "PROMOCIONAL":
//                            $colPROMOCIONAL = $letra;
//                            break;
//                        case "TRASLADO":
//                            $colTRASLADO = $letra;
//                            break;
//                        case "TOP_VENTA":
//                            $colTOP_VENTA = $letra;
//                            break;
//                        case "SALIDA":
//                            $colSALIDA = $letra;
//                            break;
//                        case "AFECTO_INVENTARIO":
//                            $colAFECTO_INVENTARIO = $letra;
//                            break;
                    }
                }
                //     die();
            }

            if ($contador > $lineaInicial) {
              
              //  die();
                $NUMERO++;
                if (array_key_exists($colCODIGO, $registro)) {
                    $CODIGO = $registro[$colCODIGO];
                } else {
                    $valido = false;
                    $pendientes[] =  'codigo_sku';
                }
                if (array_key_exists($colCODIGOANTERIOR, $registro)) {
                    $CODIGOANTERIOR = ($registro[$colCODIGOANTERIOR]);
                } else {
                    $valido = false;
                    $pendientes[] =  'codigo_barras';
                }
                if (array_key_exists($colCodGrupo, $registro)) {
                    $CODIGO_GRUPO = ($registro[$colCodGrupo]);
                } else {
                    $valido = false;
                    $pendientes[] =  'codigo_grupo';
                }
                if (array_key_exists($colGRUPO, $registro)) {
                    $GRUPO = ($registro[$colGRUPO]);
                } else {
                    $valido = false;
                    $pendientes[] =  'grupo';
                }
                if (array_key_exists($colCodSUBGRUPO, $registro)) {
                    $CODIGO_SUBGRUPO = ($registro[$colCodSUBGRUPO]);
                } else {
                    $valido = false;
                    $pendientes[] =  'codigo_subgrupo';
                }
                if (array_key_exists($colSUBGRUPO, $registro)) {
                    $SUBGRUPO = ($registro[$colSUBGRUPO]);
                } else {
                    $valido = false;
                    $pendientes[] =  'subgrupo';
                }
                if (array_key_exists($colCodCATEGORIA, $registro)) {
                    $CODIGO_CATEGORIA = ($registro[$colCodCATEGORIA]);
                } else {
                    $valido = false;
                    $pendientes[] =  'codigo_categoria';
                }
                if (array_key_exists($colCATEGORIA, $registro)) {
                    $CATEGORIA = ($registro[$colCATEGORIA]);
                } else {
                    $valido = false;
                    $pendientes[] =  'categoria';
                }

                if (array_key_exists($colNOMBRE, $registro)) {
                    $NOMBRE = ($registro[$colNOMBRE]);
                } else {
                    $valido = false;
                    $pendientes[] =  'nombre';
                }
                if (array_key_exists($colDESCRIPCION, $registro)) {
                    $DESCRIPCION = ($registro[$colDESCRIPCION]);
                } else {
                 //   $valido = false;
                  //  $pendientes[] =  'descripcion';
                }
                if (array_key_exists($colPrecio, $registro)) {
                    $precio = strtoupper($registro[$colPrecio]);
                    $precio = str_replace(",", "", $precio);
                    $precio = (double) $precio;
                    $precio = round($precio,2);
                } else {
                    $valido = false;
                    $pendientes[] =  'precio';
                }
                if (array_key_exists($colCosto, $registro)) {
                    $COSTO = strtoupper($registro[$colCosto]);
                    $COSTO = str_replace(",", "", $COSTO);
                    
                    $COSTO = (double) $COSTO;
                    $COSTO = round($COSTO,2);
                } else {

                    $pendientes[] =  'costo';
                }
                if (array_key_exists($colperecedero, $registro)) {
                    $perecedero = ($registro[$colperecedero]);
                } else {

                  //  $pendientes[] =  'perecedero';
                }
                if (array_key_exists($colCodProveedor, $registro)) {
                    $COD_PROVEEDOR = ($registro[$colCodProveedor]);
                } else {

                    $pendientes[] =  'codigo_proveedor';
                }
                if (array_key_exists($colProveedor, $registro)) {
                    $PROVEEDOR = ($registro[$colProveedor]);
                } else {
                   // $valido = false;
                    $pendientes[] =  'proveedor';
                }
                if (array_key_exists($colPROMOCIONAL, $registro)) {
                    $PROMOCIONAL = ($registro[$colPROMOCIONAL]);
                }
                if (array_key_exists($colTRASLADO, $registro)) {
                    $TRASLADO = ($registro[$colTRASLADO]);
                }
                if (array_key_exists($colTOP_VENTA, $registro)) {
                    $TOP_VENTA = ($registro[$colTOP_VENTA]);
                }
                if (array_key_exists($colSALIDA, $registro)) {
                    $SALIDA = ($registro[$colSALIDA]);
                }
                if (array_key_exists($colAFECTO_INVENTARIO, $registro)) {
                    $AFECTO_INVENTARIO = ($registro[$colAFECTO_INVENTARIO]);
                }
                   if (array_key_exists($colCANTIDAD, $registro)) {
                    $CANTIDAD = ($registro[$colCANTIDAD]);
                }
                IF (is_numeric($CANTIDAD)) {
                } else {
                    $CANTIDAD=0;
                }
                
                
//                  if (array_key_exists($colUnidadCosto, $registro)) {
//                    $UnidadCosto = ($registro[$colUnidadCosto]);
//                }

//                if ($PROMOCIONAL <> "SI") {
//                    $PROMOCIONAL = 'NO';
//                }
//                if ($TRASLADO <> "SI") {
//                    $TRASLADO = 'NO';
//                }
//                if ($TOP_VENTA <> "SI") {
//                    $TOP_VENTA = 'NO';
//                }
//                if ($SALIDA <> "SI") {
//                    $SALIDA = 'NO';
//                }
                $perecedero= TRIM($perecedero);
                $perecedero= strtoupper($perecedero);
                if ($perecedero <> "SI") {
                    $perecedero = 'NO';
                }

                $CODIGO=TRIM($CODIGO);
                $CODIGOANTERIOR=TRIM($CODIGOANTERIOR);
                $CODIGO= substr($CODIGO, 0,30);
             
                $CODIGOANTERIOR=substr($CODIGOANTERIOR, 0,30);
                
                IF ($CODIGO_GRUPO=="") {
                    $CODIGO_GRUPO= substr($GRUPO, 0,4)."-".substr($GRUPO, -4);
                }
                if ($GRUPO==""){
                    $GRUPO='N/A';
                    $CODIGO_GRUPO='NA';
                }
                if ($SUBGRUPO==""){
                    $SUBGRUPO='N/A';
                    $CODIGO_SUBGRUPO='NA';
                }                
                $lista['LINEA']=$contador;
                $lista['CODIGO'] = $CODIGO;
                $lista['CODIGOBARRAS'] = $CODIGOANTERIOR;
                $lista['COD_GRUPO'] = $CODIGO_GRUPO;
                $lista['GRUPO'] = $GRUPO;
                $lista['COD_SUBGRUPO'] = $CODIGO_SUBGRUPO;
                $lista['SUBGRUPO'] = $SUBGRUPO;
                $lista['COD_CATEGORIA'] = $CODIGO_CATEGORIA;
                $lista['CATEGORIA'] = $CATEGORIA;
                $lista['NOMBRE'] = $NOMBRE;
                $lista['DESCRIPCION'] = $DESCRIPCION;
                $lista['PRECIO'] = $precio;
                $lista['COSTO'] = $COSTO;
                $lista['PERECEDERO'] = $perecedero;
                $lista['COD_PROVEEDOR'] = $COD_PROVEEDOR;
                $lista['PROVEEDOR'] = $PROVEEDOR;
                $lista['CANTIDAD']=$CANTIDAD;
//                $lista['PROMOCIONAL'] = $PROMOCIONAL;
//                $lista['TOP_VENTA'] = $TOP_VENTA;
//                $lista['TRASLADO'] = $TRASLADO;
//                $lista['SALIDA'] = $SALIDA;
                $lista['UNIDAD_COSTO'] = $UnidadCosto;
//                $lista['AFECTO_INVENTARIO'] = $AFECTO_INVENTARIO;
if (($NOMBRE <> "")  && ($GRUPO <> "") ){
                $datos[] = $lista;
}
            }
        }
        $resultado['datos']=$datos;
        $resultado['valido']=$valido;
        $resultado['pendiente']=$pendientes;
//        echo "<pre>";
//        print_r($resultado);
//        die();
        return $resultado;
    }
    
    
}
