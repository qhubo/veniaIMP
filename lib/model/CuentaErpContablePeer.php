<?php



/**
 * Skeleton subclass for performing query and update operations on the 'cuenta_erp_contable' table.
 *
 *
 *
 * This class was autogenerated by Propel 1.6.7 on:
 *
 * 01/15/22 19:49:47
 *
 * You should add additional methods to this class to meet the
 * application requirements.  This class will only be generated as
 * long as it does not already exist in the output directory.
 *
 * @package    propel.generator.lib.model
 */
class CuentaErpContablePeer extends BaseCuentaErpContablePeer
{
    
     static public function saldo($fechaInicio, $fechafin, $cuenta) {


        $Partidas = PartidaDetalleQuery::create()
                ->usePartidaQuery()
                ->endUse()
                ->filterByCuentaContable($cuenta)
                ->withColumn('sum(PartidaDetalle.Haber)', 'TotalHaber')
                ->withColumn('sum(PartidaDetalle.Debe)', 'TotalDebe')
//                ->where("(Partida.Mes) < '" . $mesl . "'")
//                ->where("(Partida.Ano) = '" . $ano . "'")
                ->where("Partida.FechaContable >= '". $fechaInicio. "'")
                ->where("Partida.FechaContable <= '". $fechafin ."'")
                ->findOne();

        $retorna = 0;
        if ($Partidas) {
            $debe = $Partidas->getTotalDebe();
            $haber = $Partidas->getTotalHaber();
            $retorna = $debe - $haber;
        }

        return $retorna;
    }

    
    
    
    static public function procesa($data) {
        $cantida = 0;
        $tipo = $data['TIPO']; //=> 1
        $grupo = $data['GRUPO']; ////=> 1.1
        $cuenta = $data['CUENTA']; ///=> 1.
        $nombre = $data['NOMBRE']; /// => ACTIVO
        $valid = $data['VALIDO'];
        $cantida++;
        $cuentasEr = CuentaErpContableQuery::create()->findOneByCuentaContable($cuenta);
        if (!$cuentasEr) {
            $cuentasEr = New CuentaErpContable();
        }
        $cuentasEr->setTipo($tipo);
        $cuentasEr->setNombre($nombre);
        $cuentasEr->setCuentaContable($cuenta);
        $cuentasEr->setCampo($grupo);
        $cuentasEr->save();
//        echo "<pre>";
//        print_r($cuentasEr);
//        die();
    }

    static public function pobladatos($id, $empresaId = null) {

        $usuarioId = sfContext::getInstance()->getUser()->getAttribute('usuario', null, 'seguridad');
        $usuarioQue = UsuarioQuery::create()->findOneById($usuarioId);
        $empresaId = $usuarioQue->getEmpresaId();
        $lineaInicial = 2;

        header('Content-type: text/plain; charset=utf-8');
        $bitacora = BitacoraArchivoQuery::create()->findOneById($id);
        sfContext::getInstance()->getUser()->setAttribute('muestrabusqueda', 0, 'busqueda');
        $filename = $bitacora->getNombre();
        $inputFileName = sfConfig::get("sf_upload_dir") . DIRECTORY_SEPARATOR . 'cargas' . DIRECTORY_SEPARATOR . $filename;
        $objReader = new PHPExcel_Reader_Excel5();
        $objPHPExcel = $objReader->load($inputFileName);
        $sheetData = $objPHPExcel->getActiveSheet()->toArray(null, true, true, true);
        $contador = 0;

        $colTIPO = null;
        $colCUENTA = null;
        $colGRUPO = null;
        $colNOMBRE = null;

        $NUMERO = 0;
        foreach ($sheetData as $registro) {
            $lista = null;
            $TIPO = null;
            $CUENTA = null;
            $GRUPO = null;
            $NOMBRE = null;

            $valido = true;
            $contador++;
            $textoPendiente = '';
            $pendientes = null;
            $lin = $lineaInicial;
            /// encabezado
            //   echo PlantillaCampoQuery::campo($empresaId, 'codigo_sku');
            if ($contador == $lineaInicial) {
                for ($i = 0; $i <= 7; $i++) {
                    $letra = CorrelativoCodigoQuery::numeroletra($i); //sfContext::getInstance()->getUser()->numeroletra($i);
                    $campo = trim(strtoupper(($registro[$letra])));
                    $campo = ($campo);
//                    $campo = ProveedorPeer::limpiatil($campo);
                    $campo = trim(strtoupper($campo));
                    $campo = str_replace(" ", "", $campo); //                  
//                         echo $campo;
//                        echo " ------------- ";
                    switch ($campo) {
                        case 'TIPO':
                            $colTIPO = $letra;
                            break;
                        case 'CUENTA':
                            $colCUENTA = $letra;
                            break;
                        case 'GRUPO':
                            $colGRUPO = $letra;
                            break;
                        case 'NOMBRE':
                            $colNOMBRE = $letra;
                            break;
                    }
                }
                //     die();
            }

            $mensaje = '';
            if ($contador > $lineaInicial) {
                $NUMERO++;
                $CuentaID = null;
                if (array_key_exists($colTIPO, $registro)) {
                    $TIPO = trim($registro[$colTIPO]);
                } else {
                    $valido = false;

                    $pendientes[] = 'TIPO';
                }

                if (array_key_exists($colGRUPO, $registro)) {
                    $GRUPO = trim(($registro[$colGRUPO]));
                } else {
                    $valido = false;
                    $pendientes[] = 'GRUPO';
                }

                if (array_key_exists($colCUENTA, $registro)) {
                    $CUENTA = trim(($registro[$colCUENTA]));
                } else {
                    $valido = false;
                    $pendientes[] = 'CUENTA';
                }
                if (array_key_exists($colNOMBRE, $registro)) {
                    $NOMBRE = trim(($registro[$colNOMBRE]));
                } else {
                    $valido = false;
                    $pendientes[] = 'NOMBRE';
                }
                if ($valido == true) {
                    $validolI = TRUE;
                    $mensaje = "Ingreso Nuevo ";
                    if ( ($NOMBRE <> "") && ($TIPO <> "")) {
                        
                    } else {
                        $validolI = false;
                        $mensaje = "Datos Incompletos Tipo, Cuenta, Nombre";
                    }

                    $lista['LINEA'] = $contador;
                    if ($CUENTA <> "") {
                        $cuentaErp = CuentaErpContableQuery::create()->findOneByCuentaContable($CUENTA);
                        if ($cuentaErp) {
                            $mensaje = "Actualizaci√≥n";
                        }
                    }
                    $lista['TIPO'] = $TIPO;
                    $lista['GRUPO'] = $GRUPO;
                    $lista['CUENTA'] = $CUENTA;
                    $lista['NOMBRE'] = $NOMBRE;
                    $lista['MENSAJE'] = $mensaje;
                    $lista['VALIDO'] = $validolI;
                    $datos[] = $lista;
                }
            }
        }
        $resultado['datos'] = $datos;
        $resultado['valido'] = $valido;
        $resultado['pendiente'] = $pendientes;
//   echo "<pre>";
//   print_r($datos);
//   die();
        return $resultado;
    }

    static public function pobladatosPartida($id, $empresaId = null) {

        $usuarioId = sfContext::getInstance()->getUser()->getAttribute('usuario', null, 'seguridad');
        $usuarioQue = UsuarioQuery::create()->findOneById($usuarioId);
        $empresaId = $usuarioQue->getEmpresaId();
        $lineaInicial = 2;

        header('Content-type: text/plain; charset=utf-8');
        $bitacora = BitacoraArchivoQuery::create()->findOneById($id);
        sfContext::getInstance()->getUser()->setAttribute('muestrabusqueda', 0, 'busqueda');
        $filename = $bitacora->getNombre();
        $inputFileName = sfConfig::get("sf_upload_dir") . DIRECTORY_SEPARATOR . 'cargas' . DIRECTORY_SEPARATOR . $filename;
        $objReader = new PHPExcel_Reader_Excel5();
        $objPHPExcel = $objReader->load($inputFileName);
        $sheetData = $objPHPExcel->getActiveSheet()->toArray(null, true, true, true);
        $contador = 0;

        $colTIPO = null;
        $colCUENTA = null;
        $colNOMBRE = null;
        $colDEBE = null;
        $colHABER = null;
//        echo "<pre>";
//        print_r($sheetData);
//        die();

        $NUMERO = 0;
        foreach ($sheetData as $registro) {
            $lista = null;
            $TIPO = null;
            $CUENTA = null;
            $NOMBRE = null;
            $DEBE = null;
            $HABER = null;

            $valido = true;
            $contador++;
            $textoPendiente = '';
            $pendientes = null;
            $lin = $lineaInicial;
            /// encabezado
            //   echo PlantillaCampoQuery::campo($empresaId, 'codigo_sku');
            if ($contador == $lineaInicial) {
                for ($i = 0; $i <= 5; $i++) {
                    $letra = CorrelativoCodigoQuery::numeroletra($i); //sfContext::getInstance()->getUser()->numeroletra($i);
                    $campo = trim(strtoupper(($registro[$letra])));
                    $campo = ($campo);
//                    $campo = ProveedorPeer::limpiatil($campo);
                    $campo = trim(strtoupper($campo));
                    $campo = str_replace(" ", "", $campo); //                  
//                         echo $campo;
//                        echo " ------------- ";
                    switch ($campo) {
                        case 'TIPO':
                            $colTIPO = $letra;
                            break;
                        case 'CUENTA':
                            $colCUENTA = $letra;
                            break;
                        case 'DEBE':
                            $colDEBE = $letra;
                            break;
                        case 'NOMBRE':
                            $colNOMBRE = $letra;
                            break;
                        case 'HABER':
                            $colHABER = $letra;
                            break;
                    }
                }
                //     die();
            }

            $mensaje = '';
    
            if ($contador > $lineaInicial) {
                $NUMERO++;
                $CuentaID = null;
                if (array_key_exists($colTIPO, $registro)) {
                    $TIPO = trim($registro[$colTIPO]);
                } else {
                    $valido = false;

                    $pendientes[] = 'TIPO';
                }

             
                if (array_key_exists($colDEBE, $registro)) {
                    $DEBE = trim(($registro[$colDEBE]));
                } else {
                    $valido = false;
                    $pendientes[] = 'DEBE';
                }

                if (array_key_exists($colCUENTA, $registro)) {
                    $CUENTA = trim(($registro[$colCUENTA]));
                } else {
                    $valido = false;
                    $pendientes[] = 'CUENTA';
                }
                if (array_key_exists($colNOMBRE, $registro)) {
                    $NOMBRE = trim($registro[$colNOMBRE]);
                } else {
                    $valido = false;
                    $pendientes[] = 'NOMBRE';
                }
                if (array_key_exists($colHABER, $registro)) {
                    $HABER = trim(($registro[$colHABER]));
                } else {
                    $valido = false;
                    $pendientes[] = 'NOMBRE';
                }

         
                if ($valido == true) {
                 
                    $validolI = TRUE;
                    $mensaje = " ";
                    $cuentaErp = CuentaErpContableQuery::create()->findOneByCuentaContable($CUENTA);

          //        echo $CUENTA."<br>";
                    $lista['LINEA'] = $contador;
                    if ($cuentaErp) {
          
                 $DEBE= str_replace(",", "", $DEBE);
                 $HABER= str_replace(",", "", $HABER);
                        $saldo = $DEBE+$HABER;
                       if ($saldo>0) {
                              $listaId[] = $cuentaErp->getId();
                        $lista['TIPO'] = $TIPO;
                        $lista['CUENTA'] = $CUENTA;
                        $lista['NOMBRE'] = $NOMBRE;
                        $lista['ID']=$cuentaErp->getId();
                        $lista['DEBE'] = $DEBE;
                        $lista['HABER'] = $HABER;
                        $lista['MENSAJE'] = $mensaje;
                        $lista['VALIDO'] = $validolI;
                        $datos[] = $lista;
                    }
                    }
                }
            }
        }
        $resultado['lista']=$listaId;
        $resultado['datos'] = $datos;
        $resultado['valido'] = $valido;
        $resultado['pendiente'] = $pendientes;
//echo "<pre>";
//print_r($resultado);
//die();
        
        return $resultado;
    }

        static public function getSaldoFecha ($fecha, $cuenta,  $resta=true) {
            if ($resta) {
           $fecha= date("Y-m-d",strtotime($fecha."- 1 days"));
            }
                   $Partidas = PartidaDetalleQuery::create()
                        ->filterByCuentaContable($cuenta)
                          ->usePartidaQuery()
                    //     ->filterByConfirmada(true)
                        ->endUse()
                        ->withColumn('sum(PartidaDetalle.Haber)', 'TotalHaber')
                        ->withColumn('sum(PartidaDetalle.Debe)', 'TotalDebe')
                        ->where("Partida.FechaContable < '" . $fecha . " 23:59:00" . "'")
                        ->findOne();
                 $valor = 0;
                 if ($Partidas) {
                     $valor= $Partidas->getTotalDebe()-$Partidas->getTotalHaber();
                 }
                 return $valor;
            
        }
        
}
