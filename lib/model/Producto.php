<?php

/**
 * Skeleton subclass for representing a row from the 'producto' table.
 *
 *
 *
 * This class was autogenerated by Propel 1.6.7 on:
 *
 * 01/11/22 01:11:39
 *
 * You should add additional methods to this class to meet the
 * application requirements.  This class will only be generated as
 * long as it does not already exist in the output directory.
 *
 * @package    propel.generator.lib.model
 */
class Producto extends BaseProducto {

    static public function Traslado($productoID,$cantidad,$bodegaOrigen, $bodegaDestino,$codigo) {
        ProductoMovimientoQuery::Salida($productoID, $cantidad, 'TRASLADO SALIDA', $bodegaOrigen, $codigo, null, null);
        ProductoExistenciaQuery::Resta($productoID, $cantidad, $bodegaOrigen);
        ProductoMovimientoQuery::Ingreso($productoID, $cantidad, $codigo, 'TRASLADO INGRESO', date('Y-m-d'), $bodegaDestino);
        ProductoExistenciaQuery::Resta($productoID, $cantidad * -1, $bodegaDestino);
    
    }

    public function getFechaPrecio($tipo =null) {
        date_default_timezone_set("America/Guatemala");
        $precio = PrecioProductoDetalleQuery::create()
                ->usePrecioProductoQuery()
                ->filterByTipoNo($tipo)
                ->endUse()
                ->filterByProductoId($this->getId())
                ->orderById('Desc')
                ->findOne();
        $retorna = '';
        if ($precio) {
            $retorna = $precio->getPrecioProducto()->getFecha('d/m/Y H:i:s') . "<br>" . $precio->getPrecioProducto()->getUsuario();
        }
        return $retorna;
    }

        public function getExistenciaTransito($bodegaId) {
        $exitencia = 0;
        $detalle = ProductoExistenciaQuery::create()
                ->filterByTiendaId($bodegaId)
                ->filterByProductoId($this->getId())
                ->findOne();
        if ($detalle) {
            $exitencia = $detalle->getTransito();
        }

        return $exitencia;
    }

    
    
    public function getExistenciaBodega($bodegaId) {
        $exitencia = 0;
//        $detalle = ProductoExistenciaQuery::create()
//                ->filterByTiendaId($bodegaId)
//                ->filterByProductoId($this->getId())
//                ->findOne();
//        if ($detalle) {
//            $exitencia = $detalle->getCantidad();
//        }
        $query="select cantidad from producto_existencia  where tienda_id=".$bodegaId." and producto_id=".$this->getId();
        $con = Propel::getConnection();
        $stmt = $con->prepare($query);
        $resource = $stmt->execute();
        $result = $stmt->fetchAll(PDO::FETCH_ASSOC);
        if ($result) {
            $exitencia = $result[0]['cantidad'];
        }
        return $exitencia;
    }

        public function getTransito() {
        $exitencia = 0;
        $empresaId = sfContext::getInstance()->getUser()->getAttribute("usuario", null, 'empresa');
        $detalle = ProductoExistenciaQuery::create()
                ->filterByTransito(0, Criteria::NOT_EQUAL)
                ->withColumn('sum(ProductoExistencia.Transito)', 'TotalGeneral')
                ->useTiendaQuery()
                ->filterByEmpresaId($empresaId)
                ->endUse()
                ->filterByProductoId($this->getId())
                ->findOne();
        if ($detalle) {
            $exitencia = $detalle->getTotalGeneral();
        }
        return $exitencia;
    }

    
    public function getExistencia() {
        $exitencia = 0;
        $empresaId = sfContext::getInstance()->getUser()->getAttribute("usuario", null, 'empresa');
        $detalle = ProductoExistenciaQuery::create()
                ->withColumn('sum(ProductoExistencia.Cantidad)', 'TotalGeneral')
                ->useTiendaQuery()
                ->filterByEmpresaId($empresaId)
                ->endUse()
                ->filterByProductoId($this->getId())
                ->findOne();
        if ($detalle) {
            $exitencia = $detalle->getTotalGeneral();
        }
        return $exitencia;
    }

    public function save(PropelPDO $con = null) {
        $empresaId = UsuarioQuery::getEmpresaSeleccionada('Producto');

        if ($this->isNew()) {
            if ($empresaId) {
                $this->setEmpresaId($empresaId);
            }

            if (!$this->getCodigoSku()) {
                $pretipo = '000';
                $premarca = '000';
                $premodelo = '000';
                if ($this->getTipoAparatoId()) {
                    $pretipo = $this->getTipoAparato()->getCodigo();
                }
                if ($this->getMarcaId()) {
                    $premarca = $this->getMarca()->getCodigo();
                }
                if ($this->getModeloId()) {
                    $premodelo = $this->getModelo()->getCodigo();
                }
                $pre = $pretipo . $premarca . $premodelo;
                $numero = 1;
                $busca = CorrelativoCodigoQuery::create()
                        ->filterByPrefijo($pre)
                        ->filterByTipo('Producto')
                        ->findOne();
                if (!$busca) {
                    $busca = New CorrelativoCodigo();
                    $busca->setTipo('Producto');
                    $busca->setPrefijo($pre);
                    $busca->setNumeroAsginar($numero);
                    $busca->save();
                }
                $numero = $busca->getNumeroAsginar();
                $prefijo = $pre . $numero;
                if (strlen($numero) == 1) {
                    $fin = '000' . $numero;
                }
                if (strlen($numero) == 2) {
                    $fin = '00' . $numero;
                }
                if (strlen($numero) == 3) {
                    $fin = '0' . $numero;
                }
                // si es de tercero
                $c = 'P';
                if ($this->getTercero()) {
                    $c = 'T';
                }
                $prefijo = $pre . $c . $fin;
//                echo $prefijo;
//                die();
                $this->setCodigoSku($prefijo);
                $busca->setNumeroAsginar($numero + 1);
                $busca->save();
            }
        }
        if ($this->getComboProductoId()) {
            $combo = $this->getComboProducto();
            $combo->setPrecio($this->getPrecio());
            $combo->save();
            $this->setAfectoInventario(false);
        }
        if ($this->getRecetaProductoId()) {
            $combo = $this->getRecetaProducto();
            $combo->setPrecio($this->getPrecio());
            $combo->save();
            $this->setAfectoInventario(false);
        }
        $triger = sfContext::getInstance()->getUser()->getAttribute('activa', null, 'triger');
        if ($triger <> 3) {
            $this->setStatus(0);
        }
        parent::save($con);
    }

    public function getOnHand($bodegaId, $fechaInicio, $fechaFin) {
        $ingresos = 0;
        $registro = IngresoProductoDetalleProQuery::create()
                ->filterByProductoId($this->getId())
                ->useIngresoProductoProQuery()
                ->filterByTiendaId($bodegaId)
                ->endUse()
                ->where("IngresoProductoPro.CreatedAt >= '" . $fechaInicio . " 00:00:00" . "'")
                ->where("IngresoProductoPro.CreatedAt <= '" . $fechaFin . " 23:59:00" . "'")
                ->withColumn('sum(IngresoProductoDetallePro.Cantidad)', 'TotalGeneral')
                ->findOne();

        if ($registro) {
            if ($registro->getTotalGeneral()) {
                $ingresos = $registro->getTotalGeneral();
            }
        }
        return $ingresos;
    }

    public function getCostoPromedio($bodegaId, $fechaInicio, $fechaFin) {
        $ingresos = 0;
        $registro = IngresoProductoDetalleProQuery::create()
                ->filterByProductoId($this->getId())
                ->useIngresoProductoProQuery()
                ->filterByTiendaId($bodegaId)
                ->endUse()
                ->where("IngresoProductoPro.CreatedAt >= '" . $fechaInicio . " 00:00:00" . "'")
                ->where("IngresoProductoPro.CreatedAt <= '" . $fechaFin . " 23:59:00" . "'")
                ->withColumn('sum(IngresoProductoDetallePro.ValorTotal)', 'TotalMonto')
                ->withColumn('sum(IngresoProductoDetallePro.Cantidad)', 'TotalCantidad')
                ->findOne();

        if ($registro) {
            if ($registro->getTotalMonto()) {
                $ingresos = $registro->getTotalMonto() / $registro->getTotalCantidad();
            }
        }
        return $ingresos;
    }

    public function getPromedioVenta($bodegaId, $fechaInicio, $fechaFin) {
        $ingresos = $this->getPrecio();
        $registro = OperacionDetalleQuery::create()
                ->filterByProductoId($this->getId())
                ->useOperacionQuery()
                ->filterByTiendaId($bodegaId)
                ->endUse()
                ->where("Operacion.Fecha >= '" . $fechaInicio . " 00:00:00" . "'")
                ->where("Operacion.Fecha <= '" . $fechaFin . " 23:59:00" . "'")
                ->withColumn('avg(OperacionDetalle.ValorTotal)', 'TotalGeneral')
                ->findOne();

        if ($registro) {
            if ($registro->getTotalGeneral()) {
                $ingresos = $registro->getTotalGeneral();
            }
        }
        return $ingresos;
    }

}
