<?php

/**
 * Skeleton subclass for performing query and update operations on the 'producto_movimiento' table.
 *
 *
 *
 * This class was autogenerated by Propel 1.6.7 on:
 *
 * 01/28/22 05:24:50
 *
 * You should add additional methods to this class to meet the
 * application requirements.  This class will only be generated as
 * long as it does not already exist in the output directory.
 *
 * @package    propel.generator.lib.model
 */
class ProductoMovimientoQuery extends BaseProductoMovimientoQuery {

    static public function Ingreso($productoId, $cantidad, $prefijo, $motivo, $fecha = null, $bodegaDestino = null, $valores = null) {
        $bodegaID = sfContext::getInstance()->getUser()->getAttribute("usuario", null, 'bodega');
        if ($bodegaDestino) {
            $bodegaID = $bodegaDestino;
        }
              if (!$bodegaID) {
                        $BodegaQ = TiendaQuery::create()->findOne();
                        $bodegaID=$BodegaQ->getId();
                    }
              
        $empresaId = sfContext::getInstance()->getUser()->getAttribute("usuario", null, 'empresa');

        date_default_timezone_set("America/Guatemala");
        $movimienoto = ProductoMovimientoQuery::create()
                ->filterByTipo('INGRESO')
                ->filterByProductoId($productoId)
                ->filterByIdentificador($prefijo)
                ->findOne();
        if (!$movimienoto) {
            $movimienoto = new ProductoMovimiento();
        }

        $producto = ProductoQuery::create()->findOneById($productoId);

        if ($producto) {
            $inicial = $producto->getExistenciaBodega($bodegaID);
            $nuevoValor = $inicial + $cantidad;
            if ($motivo == 'ReinicioInventario') {
                $motivo = 'Reinicio Inventario';
            }
            $movimienoto->setMotivo($motivo);
            $movimienoto->setTiendaId($bodegaID);
            $movimienoto->setProductoId($productoId);
            $movimienoto->setCantidad($cantidad);
            $movimienoto->setIdentificador($prefijo);
            $movimienoto->setInicio($inicial);
            $movimienoto->setFin($nuevoValor);
            $movimienoto->setTipo('INGRESO');
            $movimienoto->setEmpresaId($empresaId);
            $movimienoto->setFecha(date('Y-m-d H:i:s'));
            if ($fecha) {
                $movimienoto->setFecha($fecha);
            }
            if ($valores) {
                $movimienoto->setValorTotal($valores['VALOR_TOTAL']);
                $movimienoto->setSubTotal($valores['VALOR_SIN_IVA']);
                $movimienoto->setIva($valores['IVA']);
            }
            $movimienoto->save();
            return $movimienoto->getId();
        }
        
    }

    static public function Salida($productoId, $cantidad, $motivo, $bodegaID, $prefijo, $fecha = null, $valores = null,$lineaNo =null) {
        date_default_timezone_set("America/Guatemala");
        if (!$bodegaID) {
            $bodegaID = sfContext::getInstance()->getUser()->getAttribute("usuario", null, 'bodega');
        }
        $empresaId = sfContext::getInstance()->getUser()->getAttribute("usuario", null, 'empresa');
        $movimienoto = NULL;
        if ($motivo <> 'VENTA') {
            $movimienoto = ProductoMovimientoQuery::create()
                    ->filterByTipo('SALIDA')
                    ->filterByIdentificador($prefijo)
                    ->filterByProductoId($productoId)
                    ->findOne();
        }
        if (!$movimienoto) {
            $movimienoto = new ProductoMovimiento();
        }
        $producto = ProductoQuery::create()->findOneById($productoId);
        $inicial = $producto->getExistenciaBodega($bodegaID);
        $nuevoValor = $inicial - $cantidad;
        $movimienoto->setTiendaId($bodegaID);
        $movimienoto->setProductoId($productoId);
        $movimienoto->setCantidad($cantidad);
        $movimienoto->setIdentificador($prefijo);
        $movimienoto->setTipo('SALIDA');
        $movimienoto->setFecha(date('Y-m-d H:i:s'));
        $movimienoto->setMotivo($motivo);
        $movimienoto->setInicio($inicial);
        $movimienoto->setEmpresaId($empresaId);
        $movimienoto->setFin($nuevoValor);
        if ($fecha) {
            $movimienoto->setFecha($fecha);
            //    echo $fecha;
        }
         if ($lineaNo) {
           $movimienoto->setLineaNo($lineaNo);
        }
         $movimientoID =null;
        
        if ($valores) {
            $movimienoto->setValorTotal($valores['VALOR_TOTAL']);
            $movimienoto->setSubTotal($valores['VALOR_SIN_IVA']);
            $movimienoto->setIva($valores['IVA']);
        }
            $con = Propel::getConnection();
        $con->beginTransaction();
        try {
            $movimienoto->save();
            $movimientoID = $movimienoto->getId();
            $con->commit();
        } catch (Exception $ex) {
            $mensaje = $ex->getMessage();
            $texto =date('Y-m-d H:i:s'). "  linea   ".$movimientoID."        ".$mensaje;
        $ruta = sfConfig::get("sf_upload_dir") . DIRECTORY_SEPARATOR . "erores.txt";
        $fh = fopen($ruta, 'a');
        fwrite($fh, $texto);
        fclose($fh);
        
            $con->rollback();
        }
        return $movimientoID;
    }

    static public function TRANSITO($productoId, $cantidad, $motivo, $bodegaID, $prefijo, $fecha = null, $valores = null) {
        date_default_timezone_set("America/Guatemala");
        $movimientoID = null;
        if (!$bodegaID) {
            $bodegaID = sfContext::getInstance()->getUser()->getAttribute("usuario", null, 'bodega');
        }
        $empresaId = sfContext::getInstance()->getUser()->getAttribute("usuario", null, 'empresa');
        $movimienoto = NULL;
        if ($motivo <> 'VENTA') {
            $movimienoto = ProductoMovimientoQuery::create()
                    ->filterByTipo('TRANSITO')
                    ->filterByIdentificador($prefijo)
                    ->filterByProductoId($productoId)
                    ->findOne();
        }
        if (!$movimienoto) {
            $movimienoto = new ProductoMovimiento();
        }
        $producto = ProductoQuery::create()->findOneById($productoId);
        $inicial = $producto->getExistencia($bodegaID);
        $nuevoValor = $inicial - $cantidad;
        $movimienoto->setTiendaId($bodegaID);
        $movimienoto->setProductoId($productoId);
        $movimienoto->setCantidad($cantidad);
        $movimienoto->setIdentificador($prefijo);
        $movimienoto->setTipo('TRANSITO');
        $movimienoto->setFecha(date('Y-m-d H:i:s'));
        $movimienoto->setMotivo($motivo);
        $movimienoto->setInicio($inicial);
        $movimienoto->setEmpresaId($empresaId);
        $movimienoto->setFin($nuevoValor);
        if ($fecha) {
            $movimienoto->setFecha($fecha);
        }
        if ($valores) {
            $movimienoto->setValorTotal($valores['VALOR_TOTAL']);
            $movimienoto->setSubTotal($valores['VALOR_SIN_IVA']);
            $movimienoto->setIva($valores['IVA']);
        }
       
        $con = Propel::getConnection();
        $con->beginTransaction();
        try {
            $movimienoto->save();
            $movimientoID = $movimienoto->getId();
            $con->commit();
        } catch (Exception $ex) {
            $mensaje = $ex->getMessage();
            $texto =date('Y-m-d H:i:s'). "  transito ".$mensaje;
        $ruta = sfConfig::get("sf_upload_dir") . DIRECTORY_SEPARATOR . "erores.txt";
        $fh = fopen($ruta, 'a');
        fwrite($fh, $texto);
        fclose($fh);
        
            $con->rollback();
        }

        return $movimientoID;
    }

}
