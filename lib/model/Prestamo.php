<?php

/**
 * Skeleton subclass for representing a row from the 'prestamo' table.
 *
 *
 *
 * This class was autogenerated by Propel 1.6.7 on:
 *
 * 07/13/23 17:35:59
 *
 * You should add additional methods to this class to meet the
 * application requirements.  This class will only be generated as
 * long as it does not already exist in the output directory.
 *
 * @package    propel.generator.lib.model
 */
class Prestamo extends BasePrestamo {

    public function getDetalleInteres($fechaInico, $fechaFin) {
        $date1 = new DateTime($fechaInico);
        $date2 = new DateTime($fechaFin);
        $diff = $date1->diff($date2);
        $dias = $diff->days;
        $lista = null;
        for ($i = 0; $i <= $dias; $i++) {
            //sumo 1 dÃ­a
            $fechaFormato = date("d/m/Y", strtotime($fechaInico . "+ " . $i . " days"));
            $fechaCalculo = date("Y-m-d", strtotime($fechaInico . "+ " . $i . " days"));
            $prestamoDetalle = PrestamoDetalleQuery::create()
                    ->filterByPrestamoId($this->getId())
                    ->where("PrestamoDetalle.FechaFin <= '" . $fechaCalculo . "'")
                    ->orderByFechaInicio("Desc")
                    ->findOne();
            
            $data = null;
             $montoActual =0;
         $TasaInteres =0;
//            
            if (!$prestamoDetalle)  {
              $prestamoDetalle = PrestamoDetalleQuery::create()
                    ->filterByPrestamoId($this->getId())
                    ->orderById("Desc")
                    ->findOne();
                
            }
                        $data['id'] = 0;
            $data['fecha'] = $fechaFormato;
            $data['monto_actual'] =  $this->getValor();
            
            if ($prestamoDetalle) {
            $montoActual = $prestamoDetalle->getValor();
            $TasaInteres = $prestamoDetalle->getPrestamo()->getTasaInteres();
                        $data['id'] = $prestamoDetalle->getId();
            $data['monto_actual'] =  $prestamoDetalle->getValor();
            }
            $VALOR = ($montoActual * $TasaInteres / 365 * 1) / 100;
            $VALOR = round($VALOR, 2);
            

            $data['fecha'] = $fechaFormato;

            $data['interes'] = $VALOR;
            $lista[] = $data;
        }
        return $lista;
    }

    public function getCalculoInteres($fechaInicio, $fechaFin) {
 
        $retorna= $this->getDetalleInteres($fechaInicio, $fechaFin);
        $VALOR=0;
        foreach ($retorna as $data) {
$VALOR=$VALOR+ $data['interes'];
            }
        $VALOR = round($VALOR, 2);
        return $VALOR;
    }

    public function getDias( $fecha) {
        $retorna = '';
        $fechaINI = '';
        $presamDetall = PrestamoDetalleQuery::create()
                ->filterByTipo('CALCULO INTERES')
                ->orderByFechaFin("Desc")
                ->filterByPrestamoId($this->getId())
                ->findOne();
        if ($presamDetall) {
            $fechaINI = $presamDetall->getFechaFin('Y-m-d');
        }

        if ($fechaINI) {
            $date1 = new DateTime($fechaINI);
            $date2 = new DateTime($fecha);
            $diff = $date1->diff($date2);
// will output 2 days
            $retorna = $diff->days;
        }
        return $retorna;
    }

    public function getValorActual() {
        $retorna = $this->getValor();
        $presamDetall = PrestamoDetalleQuery::create()
                ->orderByFechaFin("Desc")
                ->filterByPrestamoId($this->getId())
                ->findOne();
        if ($presamDetall) {
            $retorna = $presamDetall->getValor();
        }
        return $retorna;
    }

    public function getFechaUlticalculo() {
        $retorna = $this->getFechaInicio('d/m/Y');
        $presamDetall = PrestamoDetalleQuery::create()
                ->filterByTipo('CALCULO INTERES')
                ->orderByFechaFin("Desc")
                ->filterByPrestamoId($this->getId())
                ->findOne();
        if ($presamDetall) {
            $retorna = $presamDetall->getFechaFin('Y-m-d');

            $retorna = date("d/m/Y", strtotime($retorna . "+ 1 days"));
        }
        return $retorna;
    }

    public function getFechaUlti() {
        $retorna = $this->getFechaInicio('Y-m-d');
        $presamDetall = PrestamoDetalleQuery::create()
                ->orderByFechaFin("Desc")
                ->filterByPrestamoId($this->getId())
                ->findOne();
        if ($presamDetall) {
            $retorna = $presamDetall->getFechaFin('Y-m-d');
        }
        return $retorna;
    }

    public function getUltimo() {
        $retorna = $this->getFechaInicio('d/m/Y');
        $presamDetall = PrestamoDetalleQuery::create()
                ->orderByFechaFin("Desc")
                ->filterByPrestamoId($this->getId())
                ->findOne();
        if ($presamDetall) {
            $retorna = $presamDetall->getFechaFin('d/m/Y');
        }
        return $retorna;
    }

    public function save(PropelPDO $con = null) {
        $empresaId = UsuarioQuery::getEmpresaSeleccionada('Prestamo');

        if ($this->isNew()) {
            if ($empresaId) {
                $this->setEmpresaId($empresaId);
            }
            if (trim($this->getCodigo()) == "") {
                $tipo = $empresaId . 'PREST';
                $pre = 'PREST';
                $numero = 1;
                $busca = CorrelativoCodigoQuery::create()
                        ->filterByTipo($tipo)
                        ->findOne();
                if (!$busca) {
                    $busca = New CorrelativoCodigo();
                    $busca->setTipo($tipo);
                    $busca->setPrefijo($pre);
                    $busca->setNumeroAsginar($numero);
                    $busca->save();
                }
                $numero = $busca->getNumeroAsginar();
                $numero = $busca->getNumeroAsginar();
                $prefijo = $pre . $numero;
                if (strlen($numero) == 1) {
                    $prefijo = $pre . '0' . $numero;
                }
                if ($numero > 99) {
                    $prefijo = $pre . $numero;
                }
                $this->setCodigo($prefijo);
                $busca->setNumeroAsginar($numero + 1);
                $busca->save();
            }
        }


        parent::save($con);
    }

}
