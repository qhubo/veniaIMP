<?php

/**
 * Skeleton subclass for representing a row from the 'ventas_vendedor' table.
 *
 *
 *
 * This class was autogenerated by Propel 1.6.7 on:
 *
 * 08/30/23 05:01:15
 *
 * You should add additional methods to this class to meet the
 * application requirements.  This class will only be generated as
 * long as it does not already exist in the output directory.
 *
 * @package    propel.generator.lib.model
 */
class VentasVendedor extends BaseVentasVendedor {

    
    
     public function getValorComision($valor) {
        $retorna=0;
        $tiendaComision = TiendaComisionQuery::create()
                ->filterByNombreTienda($this->getNombreTienda())
                ->where("TiendaComision.Minimo <=".$valor)
                ->where("TiendaComision.Maximo >=".$valor)
                ->findOne();
        if ($tiendaComision) {
            $retorna= $tiendaComision->getTipo()." ".$tiendaComision->getValor();
            
            if ($tiendaComision->getTipo()=='fijo') {
                $retorna=$tiendaComision->getValor();
            }
               if ($tiendaComision->getTipo()=='porcentaje') {
                   $retorna= $valor *$tiendaComision->getValor();
               }
        }

        return $retorna;
    }
    public function getNombreTienda(){
        $retorna='';
        $vendedorQ = VendedorQuery::create()->findOneByNombre($this->getNombreVendedor());
        if ($vendedorQ) {
            $retorna = $vendedorQ->getTiendaComision();
        }
        if (!$vendedorQ) {
        $vendedorQ = VendedorQuery::create()->findOneByCodigo($this->getCodigoVendedor());
        if ($vendedorQ) {
            $retorna = $vendedorQ->getTiendaComision();
        }
            
        }

        return $retorna;
    }
    
    
     public function getEncargado(){
        $retorna='';
        $vendedorQ = VendedorQuery::create()->findOneByNombre($this->getNombreVendedor());
        if ($vendedorQ) {
            $retorna = $vendedorQ->getEncargadoTienda();
        }
        if (!$vendedorQ) {
        $vendedorQ = VendedorQuery::create()->findOneByCodigo($this->getCodigoVendedor());
        if ($vendedorQ) {
            $retorna = $vendedorQ->getEncargadoTienda();
        }
            
        }

        return $retorna;
    }
    
    
    public function getNoNotas($mes, $ano) {
        $mesDe = $mes;
        if ($mes < 10) {
            $mesDe = "0" . $mes;
        }
        $notIn[] = 'ANULADO';
        $notIn[] = 'Nuevo';
        $notIn[] = 'Rechazado';

        $fecha = $ano . "-" . $mesDe . "-01";
//sumo 1 mes
        $nuevaFecha = date("Y-m-d", strtotime($fecha . "+ 1 month"));
        $ano = date("Y", strtotime($fecha . "+ 1 month"));
        $mes = date("m", strtotime($fecha . "+ 1 month"));
        $mes = (int) $mes;
                $fecha = date("Y-m-d", strtotime($fecha . "+ 1 month"));
        $fecha = date("Y-m-d", strtotime($fecha . "- 1 day"));
        $nombreVendedor=trim($this->getNombreVendedor());
        $nombreVendedor= str_replace(" ", "%",$nombreVendedor);
//        echo $nombreVendedor;
//        echo "<br>";
//        print_r($notIn);
//        echo "fecha confirmo ".$mes." - ".$ano;
//        echo "<br>";
//        echo "fecha factura ".$fecha;
 

        $solictud = OrdenDevolucionQuery::create()
            ->filterByPagoMedio('CHEQUE')
                ->where("trim(OrdenDevolucion.Vendedor) like '".$nombreVendedor."'")
                ->filterByEstatus($notIn, Criteria::NOT_IN)
                ->withColumn('count(OrdenDevolucion.Id)', 'CantidadTotal')
                ->withColumn('sum(OrdenDevolucion.Valor)', 'ValorTotal')
                ->where("Month(OrdenDevolucion.FechaConfirmo)=" . $mes)
                ->where("year(OrdenDevolucion.FechaConfirmo)=" . $ano)
                ->where("OrdenDevolucion.FechaFactura <= '" . $fecha . "'")
                ->findOne();
        return $solictud;
    }

    static public function Valores($lista) {
        $ListaDev = null;
        foreach ($lista as $query) {
            $referencia = $query['Id'];
            $tiendaId = $query['Store'];
            $tiendaQ = TiendaQuery::create()->findOneByCodigo($tiendaId);
            $nombre='';
            if ($tiendaQ) {
                $nombre=$tiendaQ->getNombre();
            }
            $tipo='';
            if ((array_key_exists('tipo', $query))) {
                          $tipo=$query['tipo'];
  
            }
            $refre = OrdenDevolucionQuery::create()
                    ->filterByReferenciaNota($referencia)
                    ->useTiendaQuery()
                    ->filterByCodigo($tiendaId)
                    ->endUse()
                    ->findOne();
            $tip = 0;
            if (!$refre) {
                $refre = OrdenDevolucionQuery::create()->filterByReferenciaNota($referencia)->findOne();
                $tip = 1;
            }

            $dev = null;
            $dev['TIPO']=$tipo;
            $dev['NOMBRE_TIENDA']=$nombre;
            $dev['REFERENCIA'] = $referencia;
            $dev['TIENDA'] = $tiendaId;
            $dev['TIPO_BUSQUEDA'] = $tip;
            $dev['DEVOLUCION'] = '';
            $dev['MEDIO_PAGO'] = '';
            $dev['VALOR'] = '';
            $dev['FECHA'] = '';
            $dev['MOTIVO'] = '';
            $dev['FIRMA'] = '';
            if ($refre) {
                if ($refre->getSolicitudDevolucionId()) {
                    $dev['DEVOLUCION'] = $refre->getSolicitudDevolucion()->getCodigo();
                }
                $dev['MEDIO_PAGO'] = $refre->getPagoMedio();
                $dev['VALOR'] = Parametro::formato($refre->getValor(), FALSE);
                $dev['FECHA'] = $refre->getFecha('d/m/Y');
                $dev['MOTIVO'] = $refre->getDetalleMotivo();
            }
            $FACT = FacturasQuery::create()
                    ->filterByReferencia($referencia)
                    ->filterByTienda($tiendaId)
                    ->orderById("Desc")
                    ->findOne();
            if ($FACT) {
                $dev['FIRMA'] = $FACT->getFirma();
            }
            $ListaDev[] = $dev;
        }
        return $ListaDev;
    }

}
