<?php

/**
 * Skeleton subclass for representing a row from the 'cuenta_erp_contable' table.
 *
 *
 *
 * This class was autogenerated by Propel 1.6.7 on:
 *
 * 01/15/22 19:49:47
 *
 * You should add additional methods to this class to meet the
 * application requirements.  This class will only be generated as
 * long as it does not already exist in the output directory.
 *
 * @package    propel.generator.lib.model
 */
class CuentaErpContable extends BaseCuentaErpContable {

    public function save(PropelPDO $con = null) {
        $empresaId = UsuarioQuery::getEmpresaSeleccionada('CuentaErpContable');
        if ($empresaId) {
            $this->setEmpresaId($empresaId);
        }
        parent::save($con);
    }
    public function getValorInicial($periodo) {
                
        $partidaAperturas[]='202300001';
        $partidaAperturas[]='2022000001';
        $partidaAperturas[]='202300001';
        $partidaAperturas[]=date('Y').'0101';
        
        $ano = substr($periodo, 0, 4);
        $mes = (int) substr($periodo, -2);
        $mesl =(int)$mes;
        $fecha_actual = $ano . "-" . $mes . "-01";
// $fecha_actual =date("Y-m-d",strtotime($fecha_actual."+ 1 month")); 
       
//echo $fecha;
//die();
         $fecha= date("Y-m-d",strtotime($fecha_actual)); 
        $fecha_actual = date("Y-m-d", strtotime($fecha_actual . "- 1 days"));
        
        
        $fecha_actual = $fecha_actual . ' 23:59:00';
        $retonra = 0;
        $Partidas = PartidaDetalleQuery::create()
                ->usePartidaQuery()
                 ->filterByCodigo($partidaAperturas, Criteria::NOT_IN)
                ->filterByConfirmada(true)
                ->endUse()
               
                ->filterByCuentaContable(trim($this->getCuentaContable()))
                ->withColumn('sum(PartidaDetalle.Haber)', 'TotalHaber')
                ->withColumn('sum(PartidaDetalle.Debe)', 'TotalDebe')
//                ->where("(Partida.Mes) < '" . $mesl . "'")
//                ->where("(Partida.Ano) = '" . $ano . "'")
                    ->where("Partida.FechaContable < '" . $fecha . " 23:59:00" . "'")
                ->findOne();
        if ($Partidas) {
            $retonra = $Partidas->getTotalDebe() - $Partidas->getTotalHaber();
        }
         $fecha= date("Y-m-d",strtotime($fecha_actual."- 1 days")); 
        $retonraINicial = 0;
        $Partidas = PartidaDetalleQuery::create()
                ->usePartidaQuery()
                ->filterByConfirmada(true)
                ->filterByCodigo($partidaAperturas, Criteria::IN)
                ->endUse()
                ->filterByCuentaContable($this->getCuentaContable())
                ->withColumn('sum(PartidaDetalle.Haber)', 'TotalHaber')
                ->withColumn('sum(PartidaDetalle.Debe)', 'TotalDebe')
                ->findOne();
        if ($Partidas) {
            $retonraINicial = $Partidas->getTotalDebe() - $Partidas->getTotalHaber();
        }
        $total = $retonra + $retonraINicial;
        $total = round($total, 2);

        return $total;
    }
    public function getValorPeriodo($periodo) {
        $ano = substr($periodo, 0, 4);
        $mes = (int) substr($periodo, -2);
        $retonra = 0;
                $partidaAperturas[]='202300001';
        $partidaAperturas[]='2022000001';
        
        $Partidas = PartidaDetalleQuery::create()
                ->usePartidaQuery()
                ->filterByConfirmada(true)
                ->filterByCodigo($partidaAperturas, Criteria::NOT_IN)
                ->endUse()
                ->filterByCuentaContable($this->getCuentaContable())
                ->withColumn('sum(PartidaDetalle.Haber)', 'TotalHaber')
                ->withColumn('sum(PartidaDetalle.Debe)', 'TotalDebe')
                ->where("(Partida.Mes) = " . $mes)
                  ->where("(Partida.Ano) = " . $ano)
                ->findOne();
        if ($Partidas) {
            $retonra = $Partidas->getTotalDebe() - $Partidas->getTotalHaber();
            $retonra = round($retonra, 2);
        }

        return $retonra;
    }
    public function getMovimientos($periodo) {
        $ano = substr($periodo, 0, 4);
        $mes = (int) substr($periodo, -2);
        $Partidas = PartidaDetalleQuery::create()
                ->usePartidaQuery()
                ->filterByConfirmada(true)
                ->endUse()
                ->filterByCuentaContable($this->getCuentaContable())
                ->where("(Partida.Mes) = " . $mes)
                ->where("(Partida.Ano) = " . $ano)
                ->count();
        return $Partidas;
    }

    public function getValorPeriodoTipo($periodo, $tipo) {
        $ano = substr($periodo, 0, 4);
        $mes = (int) substr($periodo, -2);
        $retonra = 0;
                $partidaAperturas[]='202300001';
        $partidaAperturas[]='2022000001';
        
        $Partidas = PartidaDetalleQuery::create()
                ->usePartidaQuery()
                ->filterByConfirmada(true)
                ->filterByCodigo($partidaAperturas, Criteria::NOT_IN)
                ->endUse()
                ->filterByCuentaContable($this->getCuentaContable())
                ->withColumn('sum(PartidaDetalle.Haber)', 'TotalHaber')
                ->withColumn('sum(PartidaDetalle.Debe)', 'TotalDebe')
                ->where("(Partida.Mes) = " . $mes)
                  ->where("(Partida.Ano) = " . $ano)
                ->findOne();
//        if ($Partidas) {
//            $retonra = $Partidas->getTotalDebe() - $Partidas->getTotalHaber();
//            $retonra = round($retonra, 2);
//        }
        if ($Partidas) {
            if ($tipo==1) {
                $retonra= $Partidas->getTotalDebe();
                $retonra = round($retonra, 2);
            }
            if ($tipo==2) {
                $retonra= $Partidas->getTotalHaber();
$retonra = round($retonra, 2);                
            }
            
        }

        return $retonra;
    }
    
    
}
