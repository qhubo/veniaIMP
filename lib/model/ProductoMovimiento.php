<?php

/**
 * Skeleton subclass for representing a row from the 'producto_movimiento' table.
 *
 *
 *
 * This class was autogenerated by Propel 1.6.7 on:
 *
 * 01/28/22 05:24:50
 *
 * You should add additional methods to this class to meet the
 * application requirements.  This class will only be generated as
 * long as it does not already exist in the output directory.
 *
 * @package    propel.generator.lib.model
 */
class ProductoMovimiento extends BaseProductoMovimiento {

    public function getTipoDocumento() {
        $tipo = strtoupper(trim($this->getTipo()));
        $motivo = strtoupper(trim($this->getMotivo()));
        $motivo = str_replace(" ", "", $motivo);
        $motivo = trim($motivo);
        $identificador = $this->getIdentificador();
        $PREFI = substr($identificador, 0, 3);


        if ($tipo == "INGRESO") {
            switch ($motivo) {
                case "ANULAFACTURA":
                    $retorna = 'FACTURA';
                    break;
                case "DEVOULCION":
                    $retorna = 'DEVOLUCION';
                    break;
                case "INGRESOINVENTARIO":
                    $retorna = 'CARGA INVENTARIO';
                    break;
                case "REINICIOINVENTARIO":
                    $retorna = "REINICIO INVENTARIO";
                    break;
            }
        }
        if ($tipo == "SALIDA") {
            switch ($motivo) {
                case "SALIDA":
                    $retorna = 'SALIDA INVENTARIO';
                    break;
                case "VENTA":
                    $retorna = 'FACTURA';
                    break;
            }
        }
        if ($tipo == "TRANSITO") {
            $retorna = 'PEDIDO VENDEDOR';
        }
        if ($PREFI == 'ANU') {
            $retorna = 'ANULACION FACTURA';
        }

        return $retorna;
    }

    public function getDocumento() {
        $tipo = strtoupper(trim($this->getTipo()));
        $motivo = strtoupper(trim($this->getMotivo()));
        $motivo = str_replace(" ", "", $motivo);
        $motivo = trim($motivo);
        $identificador = $this->getIdentificador();
        $valores = explode("-", $identificador);
        $documento = $valores[0];
        $documento = str_replace("ANU", "", $documento);
        if ($tipo == "INGRESOINVENTARIO") {
            $documento = str_replace("INGRESO", "", $documento);
            $documento = str_replace("IN", "", $documento);
        }
        if ($tipo == "REINICIOINVENTARIO") {
            $documento = str_replace("ReIN", "", $documento);
        }
        //   $documento= $this->getIdentificador();
        RETURN $documento;
    }

    public function getNombreDocumento() {
        $tipo = strtoupper(trim($this->getTipo()));
        $motivo = strtoupper(trim($this->getMotivo()));
        $motivo = str_replace(" ", "", $motivo);
        $motivo = trim($motivo);
        $identificador = $this->getIdentificador();
        $valores = explode("-", $identificador);
        $documento = $valores[0];
        $documento = str_replace("ANU", "", $documento);
        $PREFI = substr($identificador, 0, 3);
        $nombre = '';
        if (($tipo == "SALIDA") && ($motivo == 'VENTA')) {
            $query = "select nombre from operacion where codigo ='" . $documento . "'";
            $con = Propel::getConnection();
            $stmt = $con->prepare($query);
            $resource = $stmt->execute();
            $result = $stmt->fetchAll(PDO::FETCH_ASSOC);
            if ($result) {
                $nombre = $result[0]['nombre'];
            }
        }
        if ($PREFI == 'ANU') {
            $query = "select nombre from operacion where codigo ='" . $documento . "'";
            $con = Propel::getConnection();
            $stmt = $con->prepare($query);
            $resource = $stmt->execute();
            $result = $stmt->fetchAll(PDO::FETCH_ASSOC);
            if ($result) {
                $nombre = $result[0]['nombre'];
            }
        }

        if (($tipo == "SALIDA") && ($motivo == 'SALIDA')) {
            $query = "select codigo, motivo, observaciones from salida_producto where codigo ='" . $documento . "'";
            $con = Propel::getConnection();
            $stmt = $con->prepare($query);
            $resource = $stmt->execute();
            $result = $stmt->fetchAll(PDO::FETCH_ASSOC);
            if ($result) {
                $nombre = $result[0]['observaciones'];
            }
        }
        if ($tipo == "INGRESO") {
            if ($motivo == "INGRESOINVENTARIO") {
                $documento = str_replace("INGRESO", "", $documento);
                $documento = str_replace("IN", "", $documento);
                $documento = trim($documento);
                $PREFIIN = substr($identificador, 0, 7);
                $query = "select  COALESCE(observaciones, CONCAT('Carga Ingreso ', id)) observaciones from ingreso_producto where id ='" . $documento . "'";
                if ($PREFIIN == 'INGRESO') {
                    $numero = (integer) $documento;
                    $query = "select  observaciones from ingreso_producto where numero_documento =" . $numero . "";
                }


                $con = Propel::getConnection();
                $stmt = $con->prepare($query);
                $resource = $stmt->execute();
                $result = $stmt->fetchAll(PDO::FETCH_ASSOC);
                if ($result) {
                    $nombre = $result[0]['observaciones'];
                }
            }
            if ($motivo == "REINICIOINVENTARIO") {
                $documento = str_replace("ReIN", "", $documento);
                $query = "select  observaciones from ingreso_producto where id ='" . $documento . "'";
                $con = Propel::getConnection();
                $stmt = $con->prepare($query);
                $resource = $stmt->execute();
                $result = $stmt->fetchAll(PDO::FETCH_ASSOC);
                if ($result) {
                    $nombre = $result[0]['observaciones'];
                }
            }
            if ($motivo == "DEVOLUCION") {
                $documento = str_replace("ReIN", "", $documento);
                $query = "select nombre  from orden_devolucion  where codigo='" . $documento . "'";
                $con = Propel::getConnection();
                $stmt = $con->prepare($query);
                $resource = $stmt->execute();
                $result = $stmt->fetchAll(PDO::FETCH_ASSOC);
                if ($result) {
                    $nombre = $result[0]['nombre'];
                }
            }
        }
//        if ($nombre=="") {
//        $nombre=$identificador." - ".$query;
//            
//        }

        return $nombre;
    }

    public function getVenta() {
        $tipo = strtoupper(trim($this->getTipo()));
        $motivo = strtoupper(trim($this->getMotivo()));
        $motivo = str_replace(" ", "", $motivo);
        $motivo = trim($motivo);
        $identificador = $this->getIdentificador();
        $valores = explode("-", $identificador);
        $documento = $valores[0];
        $documento = str_replace("ANU", "", $documento);
        $PREFI = substr($identificador, 0, 3);
        $nombre = '';
        if (($tipo == "SALIDA") && ($motivo == 'VENTA')) {
            $query = "select valor_unitario from operacion op inner join operacion_detalle de on op.id=de.operacion_id where op.codigo ='" . $documento . "'";
            $con = Propel::getConnection();
            $stmt = $con->prepare($query);
            $resource = $stmt->execute();
            $result = $stmt->fetchAll(PDO::FETCH_ASSOC);
            if ($result) {
                $valor_unitario= $this->getCantidad()* $result[0]['valor_unitario'];
            }
        }
        return $valor_unitario;
    }

}
