<?php

/**
 * Skeleton subclass for representing a row from the 'banco' table.
 *
 *
 *
 * This class was autogenerated by Propel 1.6.7 on:
 *
 * 01/22/20 20:47:20
 *
 * You should add additional methods to this class to meet the
 * application requirements.  This class will only be generated as
 * long as it does not already exist in the output directory.
 *
 * @package    propel.generator.lib.model
 */
class Banco extends BaseBanco {

    public function getHsaldoConciliado($fecha = "") {
        date_default_timezone_set("America/Guatemala");
        if ($fecha == "") {
            $fecha = date('Y-m-d');
        }
        $valor = '';
        $bancosaldo = SaldoBancoQuery::create()
                ->filterByBancoId($this->getId())
                ->filterByFecha($fecha)
                ->findOne();
        if ($bancosaldo) {
            $valor = $bancosaldo->getSaldoConciliado();
        }
        return $valor;
    }

    public function getHsaldoBanco($fecha = "") {
        date_default_timezone_set("America/Guatemala");
        if ($fecha == "") {
            $fecha = date('Y-m-d');
        }
        $valor = '';
        $bancosaldo = SaldoBancoQuery::create()
                ->filterByBancoId($this->getId())
                ->filterByFecha($fecha)
                ->findOne();
        if ($bancosaldo) {
            $valor = $bancosaldo->getSaldoBanco();
        }
        return $valor;
    }

    public function getHDiferencia($fecha = "") {
        date_default_timezone_set("America/Guatemala");
        if ($fecha == "") {
            $fecha = date('Y-m-d');
        }
        $valor = '';
        $bancosaldo = SaldoBancoQuery::create()
                ->filterByBancoId($this->getId())
                ->filterByFecha($fecha)
                ->findOne();
        if ($bancosaldo) {
            $valor = $bancosaldo->getDiferencia();
        }
        return $valor;
    }

     public function getHSaldoLibros($fecha = "") {
        date_default_timezone_set("America/Guatemala");
        if ($fecha == "") {
            $fecha = date('Y-m-d');
        }
        $cuenta = $this->getCuentaContable();        
        $valor = CuentaErpContablePeer::getSaldoFecha($fecha, $cuenta,false);
        
        
         $registros = MovimientoBancoQuery::create()
                ->filterByBancoId($this->getId())
                ->filterByUsuario("Migracion", Criteria::NOT_EQUAL)
                ->withColumn('sum(MovimientoBanco.Valor)', 'ValorTotal')
                ->count();
        if ($registros >0) {     
        if ($fecha >=date('Y-m-d')) {
           $valor= $this->getSaldoLibros();
         }
        }
       
        return $valor;
    }
    
    public function getHDepositoTransito($fecha = "") {
        date_default_timezone_set("America/Guatemala");
        if ($fecha == "") {
            $fecha = date('Y-m-d');
        }


        $valor = '';
        $bancosaldo = SaldoBancoQuery::create()
                ->filterByBancoId($this->getId())
                ->filterByFecha($fecha)
                ->findOne();
        if ($bancosaldo) {
            $valor = $bancosaldo->getDepositoTransito();
        }
if ($fecha >=date('Y-m-d')) {
            $valor= $this->getDepositoTransito(); 
        }
        return $valor;
    }

    public function getHNotasCreditoTransito($fecha = "") {
        date_default_timezone_set("America/Guatemala");
        if ($fecha == "") {
            $fecha = date('Y-m-d');
        }
        $valor = '';
        $bancosaldo = SaldoBancoQuery::create()
                ->filterByBancoId($this->getId())
                ->filterByFecha($fecha)
                ->findOne();
        if ($bancosaldo) {
            $valor = $bancosaldo->getNotaCredito();
        }
        if ($fecha >=date('Y-m-d')) {
            $valor= $this->getNotasCreditoTransito(); 
        }
        return $valor;
    }

    public function getHNotasChequesCircula($fecha = "") {
        date_default_timezone_set("America/Guatemala");
        if ($fecha == "") {
            $fecha = date('Y-m-d');
        }
        $valor = '';
        $bancosaldo = SaldoBancoQuery::create()
                ->filterByBancoId($this->getId())
                ->filterByFecha($fecha)
                ->findOne();
        if ($bancosaldo) {
            $valor = $bancosaldo->getChequesCircula();
        }
        if ($fecha >=date('Y-m-d')) {
            $valor= $this->getNotasChequesCircula();
        }
        return $valor;
    }

    public function getHNotasDebitoTransito($fecha = "") {
        date_default_timezone_set("America/Guatemala");
        if ($fecha == "") {
            $fecha = date('Y-m-d');
        }
        $valor = '';
        $bancosaldo = SaldoBancoQuery::create()
                ->filterByBancoId($this->getId())
                ->filterByFecha($fecha)
                ->findOne();
        if ($bancosaldo) {
            $valor = $bancosaldo->getNotaTransito();
        }
        if ($fecha >=date('Y-m-d')) {
            $valor= $this->getNotasDebitoTransito();
        }
        return $valor;
    }

    public function getSaldoLibros() {
//        $lista = CuentaBancoQuery::create()
//                ->useMovimientoBancoQuery()
//                ->filterByMedioPagoId(27, Criteria::NOT_EQUAL)
//                ->endUse()
//                ->filterByBancoId($this->getId())
//                ->withColumn('sum(CuentaBanco.Valor)', 'TotalGeneral')
//                ->findOne();
        $suma = 0;
//        if ($lista) {
//            $suma = $lista->getTotalGeneral();
//        }
        $movimiento = MovimientoBancoQuery::create()
                ->filterByBancoId($this->getId())
                //     ->filterByConfirmadoBanco(false)
                ->filterByUsuario("Migracion", Criteria::NOT_EQUAL)
                ->withColumn('sum(MovimientoBanco.Valor)', 'ValorTotal')
                ->findOne();

        $valorTra = 0;
        if ($movimiento) {
            $valorTra = $movimiento->getValorTotal();
        }
        $retorna = $suma + $valorTra;
     
        return $retorna;
    }

    public function getSaldoTransitoBanco() {
        $movimiento = MovimientoBancoQuery::create()
//                ->filterByUsuario("Migracion", Criteria::NOT_EQUAL)
//                 ->filterByMedioPagoId(27, Criteria::NOT_EQUAL)
                ->filterByBancoId($this->getId())
                ->filterByConfirmadoBanco(false)
                ->withColumn('sum(MovimientoBanco.Valor)', 'ValorTotal')
                ->findOne();

        $valorTra = 0;
        if ($movimiento) {
            $valorTra = $movimiento->getValorTotal();
        }
        return $valorTra;
    }

    public function getSaldoTransito() {
        $movimiento = MovimientoBancoQuery::create()
                ->filterByUsuario("Migracion", Criteria::NOT_EQUAL)
                ->filterByBancoId($this->getId())
                ->filterByConfirmadoBanco(false)
                ->withColumn('sum(MovimientoBanco.Valor)', 'ValorTotal')
                ->findOne();

        $valorTra = 0;
        if ($movimiento) {
            $valorTra = round($movimiento->getValorTotal(), 2);
        }
        return $valorTra;
    }

    public function getSaldoConfirmado() {
        $movimiento = MovimientoBancoQuery::create()
                ->filterByUsuario("Migracion", Criteria::NOT_EQUAL)
                ->filterByBancoId($this->getId())
                ->filterByConfirmadoBanco(false)
                ->filterByRevisado(true)
                ->withColumn('sum(MovimientoBanco.Valor)', 'ValorTotal')
                ->findOne();

        $valorTra = 0;
        if ($movimiento) {
            $valorTra = $movimiento->getValorTotal();
        }
        return $valorTra;
    }

    public function getSaldo() {
//        $lista = CuentaBancoQuery::create()                
//                ->filterByBancoId($this->getId())
//                ->withColumn('sum(CuentaBanco.Valor)', 'TotalGeneral')
//                ->findOne();
//        $suma = 0;
//        if ($lista) {
//            $suma = $lista->getTotalGeneral();
//        }
//        return $suma;

        $suma = 0;
//        if ($lista) {
//            $suma = $lista->getTotalGeneral();
//        }
        $movimiento = MovimientoBancoQuery::create()
                ->filterByBancoId($this->getId())
                //     ->filterByConfirmadoBanco(false)
                ->filterByUsuario("Migracion", Criteria::NOT_EQUAL)
                ->withColumn('sum(MovimientoBanco.Valor)', 'ValorTotal')
                ->findOne();

        $valorTra = 0;
        if ($movimiento) {
            $valorTra = $movimiento->getValorTotal();
        }
        $retorna = $suma + $valorTra;

      




        // SaldoLibros

        return $retorna;
    }

    public function getDepositoTransito($suma = 1, $fecha="") {
        if ($suma) {
            if ($this->getDolares()) {
                
                  $movimientos = MovimientoBancoQuery::create()
                    ->filterByTipo('Venta')
                    ->useMedioPagoQuery()
                    ->where("(MedioPago.nombre like  '%deposito%' or MedioPago.nombre like  '%credo%' or MedioPago.nombre like  '%visa%' )")
                    ->endUse()
                    ->filterByBancoId($this->getId())
                    ->filterByConfirmadoBanco(false)
                    //  ->filterByRevisado(false)
                    ->withColumn('sum(MovimientoBanco.Valor)', 'ValorTotal')
                    ->find();
            $retorna = 0;
          
            foreach($movimientos  as $registro ) {
                $valor = $registro->getValor();
                if ($registro->getTasaCambio()){
                $valor = $registro->getValor() /$registro->getTasaCambio();
                }
                $retorna = $retorna +$valor;
            }
            return $retorna;
                
            }
            
            
            $movimiento = MovimientoBancoQuery::create()
                    ->filterByTipo('Venta')
                    ->useMedioPagoQuery()
                    ->where("(MedioPago.nombre like  '%deposito%' or MedioPago.nombre like  '%credo%' or MedioPago.nombre like  '%visa%' )")
                    ->endUse()
                    ->filterByBancoId($this->getId())
                    ->filterByConfirmadoBanco(false)
                    //  ->filterByRevisado(false)
                    ->withColumn('sum(MovimientoBanco.Valor)', 'ValorTotal')
                    ->findOne();
            $retorna = 0;
            if ($movimiento->getValorTotal()) {
                if ($movimiento->getValorTotal()) {
                    $retorna = $movimiento->getValorTotal();
                }
                
            }
        } else {
            
            if ($fecha <> "") {
            $retorna = MovimientoBancoQuery::create()
                    ->filterByTipo('Venta')
                    ->useMedioPagoQuery()
                    ->where("(MedioPago.nombre like  '%deposito%' or MedioPago.nombre like  '%credo%' or MedioPago.nombre like  '%visa%' )")
                    ->endUse()
                    ->filterByBancoId($this->getId())
                    ->filterByConfirmadoBanco(false)
                        ->where("MovimientoBanco.FechaDocumento <='".$fecha."'")
                    //  ->filterByRevisado(false)
                    ->find();
            } else {
                  $retorna = MovimientoBancoQuery::create()
//                        ->filterByFechaDocumento()
                    ->filterByTipo('Venta')
                    ->useMedioPagoQuery()
                    ->where("(MedioPago.nombre like  '%deposito%' or MedioPago.nombre like  '%credo%' or MedioPago.nombre like  '%visa%' )")
                    ->endUse()
                    ->filterByBancoId($this->getId())
                    ->filterByConfirmadoBanco(false)
                
                    //  ->filterByRevisado(false)
                    ->find();  
            }
        }


//      $movimiento2 = MovimientoBancoQuery::create()
//                 ->filterByTipo('%deposito%')
//                ->filterByBancoId($this->getId())
//                ->filterByConfirmadoBanco(false)
//              //  ->filterByRevisado(false)
//                ->withColumn('sum(MovimientoBanco.Valor)', 'ValorTotal')
//                ->findOne();
//        $retorna2 = 0;
//        if ($movimiento2->getValorTotal()) {
//            if ($movimiento2->getValorTotal()) {
//                $retorna2 = $movimiento2->getValorTotal();
//            }
//        }
//        
//        $retornoTotal = $retorna-$retorna2;
//        

        return $retorna;
    }

    public function getNotasCreditoTransito($suma = 1, $fecha="") {
        $tiposl[] = 'Credito';
        $tiposl[] = 'TRANSFERENCIA';
        if ($suma) {
            
            
            if ($this->getDolares()) {
        
                   $movimientos = MovimientoBancoQuery::create()
                    ->filterByTipo($tiposl, Criteria::IN)
                    ->filterByBancoId($this->getId())
                    ->filterByConfirmadoBanco(false)
                    // ->filterByRevisado(false)
                  //  ->withColumn('sum(MovimientoBanco.Valor)', 'ValorTotal')
                    ->find();
                
                $retorna = 0;
            foreach($movimientos  as $registro ) {
                $valor = $registro->getValor();
                if ($registro->getTasaCambio()){
                $valor = $registro->getValor() /$registro->getTasaCambio();
                }
                $retorna = $retorna +$valor;
            }
            return $retorna;
                
            }
            $movimiento = MovimientoBancoQuery::create()
                    ->filterByTipo($tiposl, Criteria::IN)
                    ->filterByBancoId($this->getId())
                    ->filterByConfirmadoBanco(false)
                    // ->filterByRevisado(false)
                    ->withColumn('sum(MovimientoBanco.Valor)', 'ValorTotal')
                    ->findOne();
            $retorna = 0;
            if ($movimiento->getValorTotal()) {
                if ($movimiento->getValorTotal()) {
                    $retorna = $movimiento->getValorTotal();
                }
            }
        } else {
            $retorna = MovimientoBancoQuery::create()
                    ->filterByTipo($tiposl, Criteria::IN)
                    ->filterByBancoId($this->getId())
                    ->filterByConfirmadoBanco(false)
                    // ->filterByRevisado(false)
                    ->find();
            
            
              if ($fecha <> "") {
                   $retorna = MovimientoBancoQuery::create()
                    ->filterByTipo($tiposl, Criteria::IN)
                    ->filterByBancoId($this->getId())
                    ->filterByConfirmadoBanco(false)
                               ->where("MovimientoBanco.FechaDocumento <='".$fecha."'")
                    // ->filterByRevisado(false)
                    ->find();
            
            } else {
               $retorna = MovimientoBancoQuery::create()
                    ->filterByTipo($tiposl, Criteria::IN)
                    ->filterByBancoId($this->getId())
                    ->filterByConfirmadoBanco(false)
                    // ->filterByRevisado(false)
                    ->find();  
            }
        }
        return $retorna;
    }

    public function getNotasChequesCircula($suma = 1, $fecha="") {

        if ($suma) {
            
            if ($this->getDolares()) {
            
               $movimientos = MovimientoBancoQuery::create()
                    ->filterByTipo('Cheque')
                    ->filterByBancoId($this->getId())
                    ->filterByConfirmadoBanco(false)
                    //  ->filterByRevisado(false)
                  //  ->withColumn('sum(MovimientoBanco.Valor)', 'ValorTotal')
                    ->find();
            
                          $retorna = 0;
            foreach($movimientos  as $registro ) {
                $valor = $registro->getValor();
                if ($registro->getTasaCambio()){
                $valor = $registro->getValor() /$registro->getTasaCambio();
                }
                $retorna = $retorna +$valor;
            }
            return $retorna;
            }
            $movimiento = MovimientoBancoQuery::create()
                    ->filterByTipo('Cheque')
                    ->filterByBancoId($this->getId())
                    ->filterByConfirmadoBanco(false)
                    //  ->filterByRevisado(false)
                    ->withColumn('sum(MovimientoBanco.Valor)', 'ValorTotal')
                    ->findOne();
            $retorna = 0;
            if ($movimiento->getValorTotal()) {
                if ($movimiento->getValorTotal()) {
                    $retorna = $movimiento->getValorTotal();
                }
            }
        } else {
   
            
              if ($fecha <> "") {
                           $retorna = MovimientoBancoQuery::create()
                    ->filterByTipo('Cheque')
                                        ->where("MovimientoBanco.FechaDocumento <='".$fecha."'")
                    ->filterByBancoId($this->getId())
                    ->filterByConfirmadoBanco(false)
                    ->find();
               
            } else {
                         $retorna = MovimientoBancoQuery::create()
                    ->filterByTipo('Cheque')
                    ->filterByBancoId($this->getId())
                    ->filterByConfirmadoBanco(false)
                    ->find();
            }
        }
        return $retorna;
    }

    public function getNotasDebitoTransito($suma = 1, $fecha="") {
        $tipos[] = 'Debito';
        $tipos[] = 'Gasto';
        $tipos[] = 'Orden Compra';

        if ($suma) {
            if ($this->getDolares()) {
           
           $movimientos = MovimientoBancoQuery::create()
                    ->filterByTipo($tipos)
                    ->filterByBancoId($this->getId())
                    ->filterByConfirmadoBanco(false)
                    // ->filterByRevisado(false)
                    ->find();
            $retorna = 0;
            foreach ( $movimientos as $regi) {
                $valor = $regi->getValor()/$regi->getTasaCambio();
                $retorna = $valor+$retorna;
            } 
            return $retorna;
                
            } else {
            
            $movimiento = MovimientoBancoQuery::create()
                    ->filterByTipo($tipos)
                    ->filterByBancoId($this->getId())
                    ->filterByConfirmadoBanco(false)
                    // ->filterByRevisado(false)
                    ->withColumn('sum(MovimientoBanco.Valor)', 'ValorTotal')
                    ->findOne();
            $retorna = 0;
            if ($movimiento->getValorTotal()) {
                if ($movimiento->getValorTotal()) {
                    $retorna = $movimiento->getValorTotal();
                }
            }
            }
            
            
            
            
        } else {
       
            if ($fecha <> "") {
                     $retorna = MovimientoBancoQuery::create()
                    ->filterByTipo($tipos)
                    ->filterByBancoId($this->getId())
                    ->filterByConfirmadoBanco(false)
                    ->where("MovimientoBanco.FechaDocumento <='".$fecha."'")
                    // ->filterByRevisado(false)
                    ->find();
                 
            } else {
                    $retorna = MovimientoBancoQuery::create()
                    ->filterByTipo($tipos)
                    ->filterByBancoId($this->getId())
                    ->filterByConfirmadoBanco(false)
                    // ->filterByRevisado(false)
                    ->find(); 
            }
        }




        return $retorna;
    }

    public function getDepositoRegistrar() {

//            $movimiento = MovimientoBancoQuery::create()
//                ->filterByTipo('Venta')
//                ->useMedioPagoQuery()
//                ->filterByNombre('%deposito%')
//                ->endUse()
//                ->filterByBancoId($this->getId())
//                ->filterByConfirmadoBanco(false)
//                ->filterByRevisado(true)
//                ->withColumn('sum(MovimientoBanco.Valor)', 'ValorTotal')
//                ->findOne();
        $retorna = 0;
//        if ($movimiento->getValorTotal()) {
//            if ($movimiento->getValorTotal()) {
//                $retorna = $movimiento->getValorTotal();
//            }
//        }
        return $retorna;
    }

    public function getNotasRegistrar() {
        $retorna = 0;
        return $retorna;
    }

    public function getAjusteVarios() {
        $retorna = 0;
        return $retorna;
    }

    public function getChequesRegistrar() {
//            $movimiento = MovimientoBancoQuery::create()
//                  ->filterByTipoMovimiento('Cheque')
//                 ->filterByBancoId($this->getId())
//                ->filterByConfirmadoBanco(false)
//                ->filterByRevisado(true)
//                ->withColumn('sum(MovimientoBanco.Valor)', 'ValorTotal')
//                ->findOne();
        $retorna = 0;
//        if ($movimiento->getValorTotal()) {
//            if ($movimiento->getValorTotal()) {
//                $retorna = $movimiento->getValorTotal();
//            }
//        }
        return $retorna;
    }

    public function getDebitoRegistrar() {
//         $movimiento = MovimientoBancoQuery::create()
//                  ->filterByTipo('Debito')
//                 ->filterByBancoId($this->getId())
//                ->filterByConfirmadoBanco(false)
//                ->filterByRevisado(true)
//                ->withColumn('sum(MovimientoBanco.Valor)', 'ValorTotal')
//                ->findOne();
        $retorna = 0;
//        if ($movimiento->getValorTotal()) {
//            if ($movimiento->getValorTotal()) {
//                $retorna = $movimiento->getValorTotal();
//            }
//        }
        return $retorna;
    }

    public function save(PropelPDO $con = null) {
        $empresaId = UsuarioQuery::getEmpresaSeleccionada('Banco');
        if ($this->isNew()) {
            if ($empresaId) {
                $this->setEmpresaId($empresaId);
            }
            if (trim($this->getCodigo()) == "") {
                $tipo = $empresaId . 'BANK';
                $pre = $empresaId . 'BANK';
                $numero = 1;
                $busca = CorrelativoCodigoQuery::create()
                        ->filterByTipo($tipo)
                        ->findOne();
                if (!$busca) {
                    $busca = New CorrelativoCodigo();
                    $busca->setTipo($tipo);
                    $busca->setPrefijo($pre);
                    $busca->setNumeroAsginar($numero);
                    $busca->save();
                }
                $numero = $busca->getNumeroAsginar();
                $prefijo = $pre . $numero;
                if (strlen($numero) == 1) {
                    $prefijo = $pre . '0' . $numero;
                }
                if ($numero > 99) {
                    $prefijo = $pre . $numero;
                }
                $this->setCodigo($prefijo);
                $busca->setNumeroAsginar($numero + 1);
                $busca->save();
            }
        }
        parent::save($con);
    }

}
