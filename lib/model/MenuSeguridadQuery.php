<?php



/**
 * Skeleton subclass for performing query and update operations on the 'menu_seguridad' table.
 *
 *
 *
 * This class was autogenerated by Propel 1.6.7 on:
 *
 * 01/11/22 01:11:37
 *
 * You should add additional methods to this class to meet the
 * application requirements.  This class will only be generated as
 * long as it does not already exist in the output directory.
 *
 * @package    propel.generator.lib.model
 */
class MenuSeguridadQuery extends BaseMenuSeguridadQuery
{
    
    
      public static function Usuario() {
        $usuarioId = sfContext::getInstance()->getUser()->getAttribute('usuario', null, 'seguridad');
        $usuarioQ = UsuarioQuery::create()->findOneById($usuarioId);
        $emprea[$usuarioQ->getEmpresaId()] = $usuarioQ->getEmpresa()->getNombre();
        $UsuarioEmpresa = UsuarioEmpresaQuery::create()
                ->filterByUsuarioId($usuarioId)
                ->find();
        foreach ($UsuarioEmpresa as $registr) {
            $emprea[$registr->getEmpresaId()] = $registr->getEmpresa()->getNombre();
        }
//   echo "<pre>";
//   print_r($emprea);
//   die();
        return $emprea;
    }
    
    
    
        public static function TiendasInven() {
        $usuarioId = sfContext::getInstance()->getUser()->getAttribute('usuario', null, 'seguridad');
        $usuarioQ = UsuarioQuery::create()->findOneById($usuarioId);
        if ($usuarioQ->getTiendaId()) {
        $emprea[$usuarioQ->getTiendaId()] = $usuarioQ->getTienda()->getNombre();
        }
        $empresaId =sfContext::getInstance()->getUser()->getAttribute("empresa", null, 'seguridad');; // $usuarioQ->getTiendaId();
        $UsuarioEmpresa = TiendaQuery::create()
                ->filterByEmpresaId($empresaId)
                ->find();
        foreach ($UsuarioEmpresa as $registr) {
         
            $emprea[$registr->getId()] = $registr->getNombre();
         
        }
     //  $emprea[2] = "aaaaaaaaaaaaaaaaa";
//   echo "<pre>";
//   print_r($emprea);
//   die();
        return $emprea;
    }
    
    
    public static function Tiendas() {
        $usuarioId = sfContext::getInstance()->getUser()->getAttribute('usuario', null, 'seguridad');
        $usuarioQ = UsuarioQuery::create()->findOneById($usuarioId);
        if ($usuarioQ->getTiendaId()) {
        $emprea[$usuarioQ->getTiendaId()] = $usuarioQ->getTienda()->getNombre();
        }
        $empresaId =sfContext::getInstance()->getUser()->getAttribute("empresa", null, 'seguridad');; // $usuarioQ->getTiendaId();
        $UsuarioEmpresa = UsuarioTiendaQuery::create()
                ->useTiendaQuery()
                ->filterByEmpresaId($empresaId)
                ->endUse()
               ->filterByUsuarioId($usuarioId)
                ->find();
        foreach ($UsuarioEmpresa as $registr) {
            if ($empresaId==$registr->getTienda()->getEmpresaId()) {
            $emprea[$registr->getTiendaId()] = $registr->getTienda()->getNombre();
            }
        }
     //  $emprea[2] = "aaaaaaaaaaaaaaaaa";
//   echo "<pre>";
//   print_r($emprea);
//   die();
        return $emprea;
    }

    
    
    public static function Empresas() {
        $usuarioId = sfContext::getInstance()->getUser()->getAttribute('usuario', null, 'seguridad');
        $usuarioQ = UsuarioQuery::create()->findOneById($usuarioId);
        $emprea[$usuarioQ->getEmpresaId()] = $usuarioQ->getEmpresa()->getNombre();
        $UsuarioEmpresa = UsuarioEmpresaQuery::create()
                ->filterByUsuarioId($usuarioId)
                ->find();
        foreach ($UsuarioEmpresa as $registr) {
            $emprea[$registr->getEmpresaId()] = $registr->getEmpresa()->getNombre();
        }
        $empresas = EmpresaQuery::create()
                ->find();
        foreach ($empresas as $registr) {
            $emprea[$registr->getId()] = $registr->getNombre();
        }
//   echo "<pre>";
//   print_r($emprea);
//   die();
        return $emprea;
    }

    public static function Acceso() {
        $tipoUsu = strtoupper(sfContext::getInstance()->getUser()->getAttribute('usuario', null, 'tipo_usuario'));
        
        $tipoQue = PerfilQuery::create()->findOneById($tipoUsu);
        if ($tipoQue) {
            $tipoUsu=$tipoQue->getDescripcion();
        }
        $accesos = PerfilMenuQuery::create()
                ->usePerfilQuery()
               ->filterByDescripcion($tipoUsu)
                ->endUse()
                ->find();
        $menus['me'] = 'me';
        $modules[]="ME";
        $superiores[] = 0;
        
//              echo "<pre>";
//        print_r($accesos);
//        echo "</pre>";
//        
        foreach ($accesos as $reg) {
            $superior = MenuSeguridadQuery::create()->findOneById($reg->getMenuSeguridad()->getSuperior());
            $superior2 = MenuSeguridadQuery::create()->findOneById($superior->getId());
            if ($superior2) {
                if ($superior2->getSuperior()) {
             $superiores[] = $superior2->getSuperior();
            }
            }
            $superiores[] = $superior->getId();
            $menus[$reg->getMenuSeguridad()->getModulo()] = $reg->getMenuSeguridad()->getModulo();
            $modules[]=$reg->getMenuSeguridad()->getModulo();
        }
        $retorna['modules'] = $modules;
        $retorna['opciones'] = $menus;
        $retorna['superiores'] = $superiores;

//        echo " *****  ";
//        echo  $tipoUsu;
//        echo " *****  ";        
//        echo "<pre>";
//        print_r($retorna);
//        echo "</pre>";
//        die();
//////        
        
        return $retorna;
    }
}
