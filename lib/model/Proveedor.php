<?php

/**
 * Skeleton subclass for representing a row from the 'proveedor' table.
 *
 *
 *
 * This class was autogenerated by Propel 1.6.7 on:
 *
 * 03/21/21 04:53:31
 *
 * You should add additional methods to this class to meet the
 * application requirements.  This class will only be generated as
 * long as it does not already exist in the output directory.
 *
 * @package    propel.generator.lib.model
 */
class Proveedor extends BaseProveedor {

    static public function limpiatilddes($texto) {
        $texto = str_replace("á", "a", $texto);
        $texto = str_replace("é", "e", $texto);
        $texto = str_replace("í", "i", $texto);
        $texto = str_replace("ó", "o", $texto);
        $texto = str_replace("ú", "u", $texto);
        $texto = str_replace("Á", "A", $texto);
        $texto = str_replace("É", "E", $texto);
        $texto = str_replace("Í", "I", $texto);
        $texto = str_replace("Ó", "O", $texto);
        $texto = str_replace("Ú", "U", $texto);
        $texto = str_replace("(", "", $texto);
        $texto = str_replace(")", "", $texto);
        $texto = str_replace("|", "", $texto);
        $texto = str_replace("[", "", $texto);
        $texto = str_replace("]", "", $texto);
        return $texto;
    }

    static public function pobladatos($id) {
        $usuarioId = sfContext::getInstance()->getUser()->getAttribute('usuario', null, 'seguridad');
        $usuarioQue = UsuarioQuery::create()->findOneById($usuarioId);
        $empresaId = $usuarioQue->getEmpresaId();
        $lineaInicial = 1;
        header('Content-type: text/plain; charset=utf-8');
        $bitacora = BitacoraArchivoQuery::create()->findOneById($id);
        sfContext::getInstance()->getUser()->setAttribute('muestrabusqueda', 0, 'busqueda');
        $filename = $bitacora->getNombre();
        $inputFileName = sfConfig::get("sf_upload_dir") . DIRECTORY_SEPARATOR . 'cargas' . DIRECTORY_SEPARATOR . $filename;
        $objReader = new PHPExcel_Reader_Excel5();
        $objPHPExcel = $objReader->load($inputFileName);
        $sheetData = $objPHPExcel->getActiveSheet()->toArray(null, true, true, true);
        $contador = 0;
        $colFECHA = null;
        $colNO_AUTO = null;
        $colTIPODTE = null;
        $colSERIE = null;
        $colNIT_EMISOR = null;
        $colNombreEMISOR = null;
        $colMoneda = null;
        $colMOnto = 0;
        $colEstado = '';
        $colIVA = null;
        $colNODTE = null;
        $datos = null;
        $datosNO = null;
        $datosAnulado = null;

        $NUMERO = 0;
        $totalCorrecto = 0;
        foreach ($sheetData as $registro) {
            $ENCONTRADO = FALSE;
            $FECHA = '';
            $NO_AUTO = '';
            $TIPODTE = '';
            $SERIE = '';
            $NIT_EMISOR = '';
            $NombreEMISOR = '';
            $Moneda = '';
            $MOnto = 0;
            $Estado = '';
            $IVA = 0;
            $NoDTE = '';
            $valido = true;
            $contador++;
            $textoPendiente = '';
            $pendientes = null;
            $lin = $lineaInicial;
            $TIPO = '';
            $CODIGO = '';
            /// encabezado
            //   echo PlantillaCampoQuery::campo($empresaId, 'codigo_sku');
            if ($contador == $lineaInicial) {
                for ($i = 0; $i <= 30; $i++) {
                    $letra = CorrelativoCodigoQuery::numeroletra($i); //sfContext::getInstance()->getUser()->numeroletra($i);
                    $campo = trim(strtoupper(($registro[$letra])));
                    $campo = trim(strtoupper($campo));
                    $campo = Proveedor::limpiatilddes($campo);
                    $campo = ($campo);
                    $campo = trim(strtoupper($campo));
                    $campo = str_replace(" ", "", $campo); //                  
//                         echo $campo;
//                        echo " ------------- ";
                    switch ($campo) {
                        case 'FECHADEEMISION':
                            $colFECHA = $letra;
                            break;
                        case 'NUMERODEAUTORIZACION':
                            $colNO_AUTO = $letra;
                            break;
                        case 'TIPODEDTENOMBRE':
                            $colTIPODTE = $letra;
                            break;
                        case 'SERIE':
                            $colSERIE = $letra;
                            break;
                        case 'NITDELEMISOR':
                            $colNIT_EMISOR = $letra;
                            break;
                        case 'NOMBRECOMPLETODELEMISOR':
                            $colNombreEMISOR = $letra;
                            break;
                        case 'MONEDA':
                            $colMoneda = $letra;
                            break;
                        case 'MONTOGRANTOTAL':
                            $colMOnto = $letra;
                            break;
                        case 'ESTADO':
                            $colEstado = $letra;
                            break;
                        case 'IVAMONTODEESTEIMPUESTO':
                            $colIVA = $letra;
                            break;
                        case 'NUMERODELDTE':
                            $colNODTE = $letra;
                            break;
                    }
                }
                //     die();
            }

            $mensaje = '';

            if ($contador > $lineaInicial) {
                $NUMERO++;
                $CuentaID = null;
                if (array_key_exists($colFECHA, $registro)) {
                    $FECHA = trim(($registro[$colFECHA]));
                } else {
                    $valido = false;
                    $pendientes[] = 'Fecha de emisión';
                }
                if (array_key_exists($colNO_AUTO, $registro)) {
                    $NO_AUTO = trim(($registro[$colNO_AUTO]));
                } else {
                    $valido = false;
                    $pendientes[] = 'Número de Autorización';
                }
                if (array_key_exists($colTIPODTE, $registro)) {
                    $TIPODTE = trim(($registro[$colTIPODTE]));
                } else {
                    $valido = false;
                    $pendientes[] = 'Tipo de DTE (nombre)';
                }
                if (array_key_exists($colNIT_EMISOR, $registro)) {
                    $NIT_EMISOR = trim(($registro[$colNIT_EMISOR]));
                } else {
                    $valido = false;
                    $pendientes[] = 'NIT del emisor';
                }
                if (array_key_exists($colNombreEMISOR, $registro)) {
                    $NombreEMISOR = trim(($registro[$colNombreEMISOR]));
                } else {
                    $valido = false;
                    $pendientes[] = 'Nombre completo del emisor';
                }
                if (array_key_exists($colMoneda, $registro)) {
                    $Moneda = trim(($registro[$colMoneda]));
                } else {
                    $valido = false;
                    $pendientes[] = 'Moneda';
                }
                if (array_key_exists($colMOnto, $registro)) {
                    $MOnto = trim(($registro[$colMOnto]));
                } else {
                    $valido = false;
                    $pendientes[] = 'Monto (Gran Total)';
                }
                if (array_key_exists($colEstado, $registro)) {
                    $Estado = trim(($registro[$colEstado]));
                } else {
                    $valido = false;
                    $pendientes[] = 'Estado';
                }
                if (array_key_exists($colSERIE, $registro)) {
                    $SERIE = trim(($registro[$colSERIE]));
                } else {
                    $valido = false;
                    $pendientes[] = 'Serie';
                }

                if (array_key_exists($colNODTE, $registro)) {
                    $NoDTE = trim(($registro[$colNODTE]));
                } else {
                    $valido = false;
                    $pendientes[] = 'Número del DTE';
                }

                if (array_key_exists($colIVA, $registro)) {
                    $IVA = trim(($registro[$colIVA]));
                } else {
                    $valido = false;
                    $pendientes[] = ' IVA (monto de este impuesto';
                }
                if ($valido == true) {
                    $MOnto = trim(str_replace(",", "", $MOnto));
                    if (!is_numeric($MOnto)) {
                        $MOnto = 0;
                    }
                    $IVA = trim(str_replace(",", "", $IVA));
                    if (!is_numeric($IVA)) {
                        $IVA = 0;
                    }
                    $tipoRegi = '';
                    $validolI = 1;
                    $mensaje = " ";
                    $ordenPago = GastoQuery::create()
                            ->filterByDocumento('%' . $SERIE . "%" . $NoDTE . "%")
                            ->useProveedorQuery()
                            ->endUse()
                            ->findOne();
                      $ENCONTRADO = false;
                    $TOKEN = null;
                    $GASTOid = NULL;
                    $IDDETALLE = null;
                    $ordenProveedor = OrdenProveedorQuery::create()
                            ->filterByNoDocumento($NoDTE)
                            ->findOne();
                    $ordenId=null;
                    if ($ordenProveedor) {
                        $ordenId=$ordenProveedor->getId();
                        $ENCONTRADO=true;
                        $TOKEN = $ordenProveedor->getToken();
                        $CODIGO=$ordenProveedor->getCodigo();
//                        echo "<pre>";
//                        print_r($ordenProveedor);
//                        die();
                    }
                    
                  
                    
                    if ($ordenPago) {
                        $ENCONTRADO = true;
                        $GASTOid = $ordenPago->getId();
                        $CODIGO = $ordenPago->getCodigo();
                        $TIPO = 'Gasto';
                        $TOKEN = $ordenPago->getToken();
                    }
                    $gastoCajaDetalle = GastoCajaDetalleQuery::create()
                            ->filterBySerie($SERIE)
                            // ->filterByFactura($NoDTE)
                            ->findOne();
                    $gastoCajaId = null;
                    if ($gastoCajaDetalle) {
                        $ENCONTRADO = true;
                        $IDDETALLE = $gastoCajaDetalle->getId();             
                        $gastoCajaId = $gastoCajaDetalle->getGastoCajaId();
                        $CODIGO = "Caja".$gastoCajaDetalle->getGastoCaja()->getId();
                        $TIPO = 'Gasto Caja';
                    }
                    $FECHA = str_replace("-06:00", "", $FECHA);
                    $FECHASQL = str_replace("T", " ", $FECHA);
                    $FECHASQL = trim(substr($FECHASQL, 0, 10));
                   // $FECHASQL = str_replace("-", "", $FECHASQL);
                    $FECHA = explode("T", $FECHA);
                    $FECHAN = $FECHA[0];
                    $FECHAN = explode("-", $FECHAN);
                    $FECHAN = $FECHAN[2] . "/" . $FECHAN[1] . "/" . $FECHAN[0];
                    $HORA = $FECHA[1];
                    $HORA = substr($HORA, 0, 5);
                    $FECHAFORMATO = $FECHAN . " " . $HORA;
                    $lista['LINEA'] = $contador;
                    $lista['FECHA_SQL']=$FECHASQL;
                    $lista['FECHA'] = $FECHAFORMATO;
                    $lista['NO_AUTO'] = $NO_AUTO;
                    $lista['TIPO_DTE'] = $TIPODTE;
                    $lista['SERIE'] = $SERIE;
                    $lista['NODTE'] = $NoDTE;
                    $lista['NIT_EMISOR'] = $NIT_EMISOR;
                    $lista['NOMBRE_EMISOR'] = $NombreEMISOR;
                    $lista['MONEDA'] = $Moneda;
                    $lista['MONTO'] = $MOnto;
                    $lista['ESTADO'] = $Estado;
                    $lista['IVA'] = $IVA;
                    $lista['GASTO_ID'] = $GASTOid;
                    $lista['ORDEN_PROVEEDOR']=$ordenId;
                    $lista['TOKEN'] = $TOKEN;
                    $lista['GASTO_CAJA_ID'] = $gastoCajaId;
                    $lista['ENCONTRADO'] = $ENCONTRADO;
                    $lista['TIPO'] = $TIPO;
                    $lista['GASTO_DETALLE_ID'] = $IDDETALLE;
                    $lista['CODIGO'] = $CODIGO;
                    $lista['listaVenialink'] = '';
                    if ($ENCONTRADO) {
                        $datos[$NUMERO] = $lista;
                    } elseif (strtoupper(trim($Estado)) == "ANULADO") {
                        $datosAnulado[$NUMERO] = $lista;
                    } else {
                        $detalle = GastoCajaDetalleQuery::create()
                                ->filterByValor($MOnto)
                                ->useProveedorQuery()
                                ->filterByNit($NIT_EMISOR)
                                ->endUse()
                                ->select(array('GastoCajaDetalle.Id','GastoCajaDetalle.Fecha', 'GastoCajaDetalle.Valor', 'GastoCajaDetalle.Serie', 'GastoCajaDetalle.Factura'))
                                ->find();
                        $seleccion = null;
                        foreach ($detalle as $deta) {
                            $fechaV = $deta['GastoCajaDetalle.Fecha'];
                             $FechaOperacion = $fechaV;
                            $fechaVA = explode("/", $fechaV);
                            if (count($fechaV) >1) {
                            $FechaOperacion = $fechaVA[2] ."-". $fechaVA[1] ."-".$fechaVA[0];
                            }
                             $sele=null;
                              $sele['ID']=$deta['GastoCajaDetalle.Id'];
                             $sele['fecha']=$deta['GastoCajaDetalle.Fecha'];
                             $sele['valor']=$deta['GastoCajaDetalle.Valor'];
                             $sele['serie']=$deta['GastoCajaDetalle.Serie'];
                             $sele['no_dte']=$deta['GastoCajaDetalle.Factura'];
                             $sele['documento']=$sele['serie']."-".$sele['no_dte'];
                             $sele['tipo']='GastoCaja';
                            if ($FechaOperacion >= $FECHASQL) {
                                $seleccion[$sele['ID']] = $sele;
                            }
                        }
                        
                        $detalle = GastoQuery::create()
                            ->where("Gasto.Fecha >= '".$FECHASQL." 00:00'")
                             ->filterByValorTotal($MOnto)
                             ->useProveedorQuery()
                              ->filterByNit($NIT_EMISOR)
                             ->endUse()
                          //   ->select(array('Gasto.Fecha', 'Gasto.ValorTotal', 'Gasto.Documento'))
                           ->find();
                         foreach ($detalle as $deta) {
                             $documento =ltrim(trim($deta->getDocumento()));
                             $documento = str_replace("  ","",$documento);
                             $documento= str_replace("-"," ",$documento);
                             $valoreArray =explode(" ",$documento); 
                             $sele=null;
                             $sele['ID']=$deta->getId();
                             $sele['fecha']=$deta->getFecha('d/m/Y');
                             $sele['valor']=$deta->getValorTotal();
                             $sele['serie']= $valoreArray[0];
                             //$sele['no_dte']=$valoreArray[1];
                             $sele['documento']=$deta->getDocumento();
                             $sele['tipo']='Gasto';
                         $seleccion[$sele['ID']] = $sele;
                         }
                         
                         //***
                            $detalle = OrdenProveedorQuery::create()
                            ->where("OrdenProveedor.Fecha >= '".$FECHASQL." 00:00'")
                             ->filterByValorTotal($MOnto)
                             ->useProveedorQuery()
                              ->filterByNit($NIT_EMISOR)
                             ->endUse()
                          //   ->select(array('Gasto.Fecha', 'Gasto.ValorTotal', 'Gasto.Documento'))
                           ->find();
                         foreach ($detalle as $deta) {
                             $documento =ltrim(trim($deta->getNoDocumento()));
                          
                             $sele=null;
                             $sele['ID']=$deta->getId();
                             $sele['fecha']=$deta->getFecha('d/m/Y');
                             $sele['valor']=$deta->getValorTotal();
                             $sele['serie']= '';
                             //$sele['no_dte']=$valoreArray[1];
                             $sele['documento']=$deta->getNoDocumento();
                             $sele['tipo']='ORDENPROV';
                            $seleccion[$sele['ID']] = $sele;
                         }
                         
                         
                         //**
                         
                         
                        $lista['listaVenialink'] = $seleccion;
                        $datosNO[$NUMERO] = $lista;
                    }
                }
            }
        }
        $resultado['total'] = $totalCorrecto;
        $resultado['datos'] = $datos;
        $resultado['datosNO'] = $datosNO;
        $resultado['datosAnulado'] = $datosAnulado;
        $resultado['valido'] = $valido;
        $resultado['pendiente'] = $pendientes;
        if ($valido) {
            sfContext::getInstance()->getUser()->setAttribute('seledatosV', serialize($resultado), 'carga');
        }
        
//        echo "<pre>";
//        print_r($resultado);
//        die();
        return $resultado;
    }

    public function getSaldo() {
        $lista = CuentaProveedorQuery::create()
                ->withColumn('sum(CuentaProveedor.ValorTotal)', 'TotalGeneral')
                ->withColumn('sum(CuentaProveedor.ValorPagado)', 'TotalPagado')
                ->filterByProveedorId($this->getId())
                ->findOne();
        $saldo = 0;
        if ($lista) {
            $saldo = $lista->getTotalGeneral() - $lista->getTotalPagado();
        }
        return $saldo;
    }

    public function getDireccionCompleta() {
        $departamento = '';
        $municipio = '';
        $municipioQuery = MunicipioQuery::create()->findOneById($this->getMunicipioId());
        $deptoQuery = DepartamentoQuery::create()->findOneById($this->getDepartamentoId());
        if ($municipioQuery) {
            $municipio = $municipioQuery->getDescripcion();
        }
        if ($deptoQuery) {
            $departamento = $deptoQuery->getNombre();
        }

        $retorna = $this->getDireccion() . " " . $departamento . " " . $municipio;
        return $retorna;
    }

    public function save(PropelPDO $con = null) {
        $empresaId = UsuarioQuery::getEmpresaSeleccionada('Proveedor');
        if ($empresaId) {
            $this->setEmpresaId($empresaId);
        }
        //      if ($this->isNew()) {
        if (trim($this->getCodigo()) == "") {
            $tipo = 'PROV';
            $pre = $tipo;
            $numero = 1;
            $busca = CorrelativoCodigoQuery::create()
                    ->filterByTipo($tipo)
                    ->findOne();
            if (!$busca) {
                $busca = New CorrelativoCodigo();
                $busca->setTipo($tipo);
                $busca->setPrefijo($pre);
                $busca->setNumeroAsginar($numero);
                $busca->save();
            }
            $numero = $busca->getNumeroAsginar();
            $prefijo = $pre . $numero;
            if (strlen($numero) == 1) {
                $prefijo = $pre . '00' . $numero;
            }
            if (strlen($numero) == 2) {
                $prefijo = $pre . '0' . $numero;
            }
            $this->setCodigo($prefijo);
            $busca->setNumeroAsginar($numero + 1);
            $busca->save();
        }
        //   }
        parent::save($con);
    }

}
