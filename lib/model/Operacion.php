<?php

/**
 * Skeleton subclass for representing a row from the 'operacion' table.
 *
 *
 *
 * This class was autogenerated by Propel 1.6.7 on:
 *
 * 01/11/22 01:11:36
 *
 * You should add additional methods to this class to meet the
 * application requirements.  This class will only be generated as
 * long as it does not already exist in the output directory.
 *
 * @package    propel.generator.lib.model
 */
class Operacion extends BaseOperacion {


      public function getRecibo() {
        $listablack[]='CONTRA ENTREGA';
        $listablack[]='CXC COBRAR';
        $listablack[]='CHEQUE PREFECHADO';
        $listablack[]='CONTRAENTREGA'; 
                  
          $operacionPago = OperacionPagoQuery::create()
                  ->filterByTipo($listablack, Criteria::NOT_IN)
                 ->filterByOperacionId($this->getId())
                  ->orderByFechaCreo('Desc')
                  ->findOne();
          $retorna='';
      if ($operacionPago) {
          $retorna = $operacionPago->getCodigo();
      }
          return $retorna;
      }
      
      
            public function getFechaRecibo() {
               $listablack[]='CONTRA ENTREGA';
        $listablack[]='CXC COBRAR';
        $listablack[]='CHEQUE PREFECHADO';
        $listablack[]='CONTRAENTREGA'; 
          $operacionPago = OperacionPagoQuery::create()
                 ->filterByOperacionId($this->getId())
 ->filterByTipo($listablack, Criteria::NOT_IN)
                  ->orderByFechaCreo('Desc')
                  ->findOne();
          $retorna='';
      if ($operacionPago) {
          $retorna = $operacionPago->getFechaCreo('d/m/Y');
      }
          return $retorna;
      }
    
      public function getNota() {
          $retorna ="";
          $notaCredito = NotaCreditoQuery::create()
                  ->filterByTipoNota('CLIENTE')
                  ->filterByDocumento($this->getCodigo())
                  ->findOne();
          if ($notaCredito) {
              $retorna = $notaCredito->getCodigo();
          }
          return $retorna;
      }   
      public function getVuelto() {
        $operacionDetalle = OperacionPagoQuery::create()
                     ->filterByOperacionId($this->getId())
                ->find();
        $total = 0;
        foreach ($operacionDetalle as $detalle) {
                $total = $total + $detalle->getVuelto();
        }

        return $total;
    }

    public function getImpuestoHotel() {
        $operacionDetalle = OperacionDetalleQuery::create()
                ->filterByServicioId(0, Criteria::GREATER_EQUAL)
                ->filterByOperacionId($this->getId())
                ->find();
        $total = 0;
        foreach ($operacionDetalle as $detalle) {
            if ($detalle->getServicio()->getImpuestoHotelero()) {
                $valorImpuesto = ($detalle->getValorTotal() / 1.22) * (10 / 100);
                $total = $total + $valorImpuesto;
            }
        }

        return $total;
    }

    public function getUUID() {

        $return = $this->getFaceFirma();
        return $return;
    }

    public function getFeelEstado() {

        $return = $this->getFaceEstado();
        return $return;
    }

    public function getFeelSerie() {

        $return = $this->getFaceSerieFactura();
        return $return;
    }

    public function getFeelNumero() {

        $return = $this->getFaceNumeroFactura();
        return $return;
    }

    public function getFeelContigencia() {

        $return = $this->getFaceReferencia();

        return $return;
    }

    static public function FacturaFel($operaId) {
        $OPERACION = OperacionQuery::create()->findOneById($operaId);


//echo        $OPERACION->getTienda()->getCodigo();
//die();
        //**  INICIO TEST
        if ($OPERACION->getTienda()->getCodigo() == 'TEST') {
            $ERROR = '';
            $CONTIGENCIA = '';
            $FECHA = date('Y-m-d');
            $SERIE = 'PRUEBAS';
            $UUID = substr(sha1($SERIE . date('Ymdis')), 0, 20);
            $NUMERO = rand(999, 9999);

            $returna['ERROR'] = $ERROR; // = '';
            $returna['CONTIGENCIA'] = $CONTIGENCIA; // = '';
            $returna['FECHA'] = $FECHA; // = '';
            $returna['SERIE'] = $SERIE; // = '';
            $returna['NUMERO'] = $NUMERO; // = '';
            $returna['UUID'] = $UUID; // = ''

            $OPERACION->setFaceError($ERROR);
            $OPERACION->setFaceReferencia($CONTIGENCIA);
            $OPERACION->setFaceSerieFactura($SERIE);
            $OPERACION->setFaceFirma($UUID);
            $OPERACION->setFaceNumeroFactura($NUMERO);


            $returna['CONTIGENCIA'] = '';
            $returna['ERROR'] = '';
            $OPERACION->setFaceEstado("FIRMADO");
            $OPERACION->setFaceError('');
            $OPERACION->setFaceReferencia('');
            $OPERACION->save();
            return $returna;
        }
// * FOM TEST

        $NIT = $OPERACION->getNit();
        $NIT = str_replace("-", "", $NIT);
        $NIT = str_replace(".", "", $NIT);
        $NIT = str_replace("/", "", $NIT);
        $NIT = trim($NIT);
        $NIT = strtoupper($NIT);
        // $NIT='38321696';

        $OPERACION->getTienda()->getNit();
        $EMPRESAnit = EmpresaQuery::create()->findOneByTelefono($OPERACION->getTienda()->getNit());
        $dt['emisor_clave'] = $OPERACION->getEmpresa()->getFeelToken(); // '694B2B49CF96EF5BCF7F18B764A4533A';
        $dt['emisor_codigo'] = $OPERACION->getEmpresa()->getFeelNombre(); // 'DEMOPRUEBASTGC';
        //******ASI ESTA CLINICA FRANCESA Y VENTA MAQUINA
        $emisor_codigo = $OPERACION->getEmpresa()->getTelefono();
        ///***        
//        if ($OPERACION->getEmpresa()->getTelefono() == "11700288K") {
//            $emisor_codigo = "96468084_DEMO";
//        }
//        if ($OPERACION->getEmpresa()->getTelefono() == "87240793") {
//            $emisor_codigo = "87240793PRO";
//        }       

        $emisor_codigo = $OPERACION->getEmpresa()->getFeelUsuario();
        $dt['emisor_codigo'] = $emisor_codigo; // 'DEMOPRUEBASTGC';
        $dt['nit_consulta'] = $NIT;
        $json_code = json_encode($dt);
        $username = $OPERACION->getEmpresa()->getFeelUsuario(); //  '630001';
        $password = $OPERACION->getEmpresa()->getFeelLlave(); // 'kuHag&xo9?w22pr#ka-A';

        if ($EMPRESAnit) {
            $dt['emisor_clave'] = $EMPRESAnit->getFeelToken(); // '694B2B49CF96EF5BCF7F18B764A4533A';
            $dt['emisor_codigo'] = $EMPRESAnit->getFeelNombre(); // 'DEMOPRUEBASTGC';
            $emisor_codigo = $EMPRESAnit->getFeelUsuario();
            $dt['emisor_codigo'] = $emisor_codigo; // 'DEMOPRUEBASTGC';
            $dt['nit_consulta'] = $NIT;
            $json_code = json_encode($dt);
            $username = $EMPRESAnit->getFeelUsuario(); //  '630001';
            $password = $EMPRESAnit->getFeelLlave(); // 'kuHag&xo9?w22pr#ka-A';
        }

//   echo "<pre>";
//   print_r($dt);
//   die();

        $base64 = base64_encode($username . ":" . $password);

        if ($NIT <> 'CF') {
            $curl = curl_init();
            curl_setopt_array($curl, array(
                CURLOPT_URL => 'https://consultareceptores.feel.com.gt/rest/action',
                CURLOPT_RETURNTRANSFER => true,
                CURLOPT_ENCODING => '',
                CURLOPT_MAXREDIRS => 10,
                CURLOPT_TIMEOUT => 0,
                CURLOPT_FOLLOWLOCATION => true,
                CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                CURLOPT_CUSTOMREQUEST => 'POST',
                CURLOPT_POSTFIELDS => $json_code,
                CURLOPT_HTTPHEADER => array(
                    'Content-Type: application/json',
                    'Authorization: Basic ' . $base64
                ),
            ));

            $response = curl_exec($curl);
            curl_close($curl);
            $results = json_decode($response, true);
            if ($OPERACION->getFecha('Y-m-d') == '2028-11-28') {
                echo "https://consultareceptores.feel.com.gt/rest/action";
                echo "<br>";
                echo "<br>";
                echo "Username--> " . $username;
                echo "<br>";
//
                echo "Pass--> " . $password;
//        
                echo "<br>";
//        
                echo "<br>";
                echo $base64;
                echo "<pre>";
                echo "valroes enviados <br>";
                echo $json_code;
                echo "</pre>";
                echo "repsuesta <br>";

                echo "<pre>";
                print_r($results);
                die();
            }
            $mensaje = trim($results['mensaje']);
            if ($mensaje <> "") {
                $returna['ERROR'] = $mensaje; // = '';
                $returna['CONTIGENCIA'] = ''; // = '';
                $returna['FECHA'] = ''; // = '';
                $returna['SERIE'] = ''; // = '';
                $returna['NUMERO'] = ''; // = '';
                $returna['UUID'] = ''; // = '';
                $OPERACION->setFaceEstado("ERROR NIT");
                $OPERACION->setFaceError($mensaje);
                $OPERACION->save();
                //   return $returna;
            }
        }
        $operacionDetalle = OperacionDetalleQuery::create()
                ->filterByOperacionId($operaId)
                // ->setLimit(1)
                ->find();
        //**** para clinica y la maquina
        $CODIGO_EMPRESA = (int) $OPERACION->getTienda()->getCodigoEstablecimiento();
        $CODIGO_ESTABLECIMIENTO = "00001";
        //****


        $CODIGO_ESTABLECIMIENTO = $OPERACION->getTienda()->getCodigoEstablecimiento();
        $CODIGO_EMPRESA = (int) $OPERACION->getEmpresa()->getNomenclatura(); // ->getCodigoEstablecimiento();
        if ($EMPRESAnit) {
            $CODIGO_EMPRESA = (int) $EMPRESAnit->getNomenclatura(); // ->getCodigoEstablecimiento(); 
        }

        $fecha = $OPERACION->getFecha('Ymd H:i:m') . ".112";


        $Docentry = $operaId;
        if (strlen($operaId) == 1) {
            $Docentry = "1900" . $operaId;
        }
        if (strlen($operaId) == 2) {
            $Docentry = "190" . $operaId;
        }
        if (strlen($operaId) == 3) {
            $Docentry = "1900" . $operaId;
        }

        $Docentry = (int) $Docentry;
        $dataH["Addid"] = $NIT;
        $dataH["Address"] = "CIUDAD";
        $dataH["Canceled"] = "N";
        $dataH["CardCode"] = 'NA';
        $dataH["CardCodeType"] = 1;
        $dataH["CardName"] = $OPERACION->getNombre();
        $dataH["CmpCode"] = $CODIGO_EMPRESA;
        $dataH["DiscPrcnt"] = 0.0;
        $dataH["DiscSum"] = 0.0;
        $dataH["DocCur"] = "QTZ";
        $dataH["DocDate"] = $fecha;
        $dataH["DocDueDate"] = null;
        $dataH["DocEntry"] = $Docentry;
        $dataH["DocNum"] = 0;
        $dataH["DocStatus"] = "C";
        $dataH["DocTotal"] = $OPERACION->getValorTotal();
        $dataH["DocType"] = 1;
        $dataH["DspCode"] = 1;
        $dataH["FatherCard"] = $NIT;
        $dataH["ListNum"] = 1;
        $dataH["LoyaltyClientId"] = "";
        $dataH["Mail"] = "";
        $dataH["Obs"] = "";
        $dataH["Packaging"] = "N";
        $dataH["PaidToDate"] = null;
        $dataH["Phone"] = "";
        $dataH["Printed"] = "N";
        $dataH["Ref1"] = "";
        $dataH["Ref2"] = "";
        $dataH["Ref3"] = "";
        $dataH["Ref4"] = "";
        $dataH["Shift"] = "1";
        $dataH["ShiftDate"] = $OPERACION->getFecha('Ymd'); //  "20230822";
        $dataH["ShippingAddress"] = "";
        $dataH["SlpCode"] = -1;
        $dataH["StationId"] = 1;
        $dataH["TblCode"] = 0;
        $dataH["TipAmount"] = 0.0;
        $dataH["ToPay"] = null;
        $dataH["U_FEL_Numero"] = "";
        $dataH["U_FEL_Serie"] = "";
        $dataH["UserId"] = 'manager';
        $dataH["VatPercent"] = 0.0;
        $dataH["VatSum"] = 0.0;
        $dataH["WhsCode"] = $CODIGO_ESTABLECIMIENTO;

        $orden = 1;

        $GRAN_TOTAL=0;
        foreach ($operacionDetalle as $detalle) {
            $codigoPr = $orden . "_" . $detalle->getCodigo();
            //        $codigoPr='1000087922';
            $tipo = 'B';
            $hospedaje = 0;
            if ($detalle->getServicioId()) {
                $tipo = 'S';
                if ($detalle->getServicio()->getImpuestoHotelero()) {
                    $tempo = $detalle->getValorTotal() / 1.22;
                    $hospedaje = $tempo * (10 / 100);
                }
            }
            $hospedaje = round($hospedaje, 2);
            $orden++;

            $data = null;
            $data["AddId"] = null;
            $data["AltDescription"] = "";
            $data["CardName"] = null;
            $data["CmpCode"] = $CODIGO_EMPRESA;
            $data["CmplmntType"] = null;
            $data["Confirm"] = null;
            $data["Cost"] = null;
            $data["CostingCode"] = null;
            $data["Currency"] = "QTZ";
            $data["DiscCode"] = 0;
            $data["DiscPrcnt"] = 0.0;
            $data["DiscSum"] = 0.0;
            $data["DiscUser"] = null;
            $data["DocDate"] = $fecha;
            $data["DocEntry"] = $Docentry;
            $data["EventCode"] = 0;
            $data["ExpCode"] = 0;
            $data["ExpDocDate"] = null;
            $data["ExpDocSerie"] = null;
            $data["ExpDocto"] = null;
            $data["FromWhsCod"] = "00001";
            $data["FromWhsName"] = null;
            $data["FuelId"] = "";
            if ($hospedaje > 0) {
                $data["FuelId"] = "H";
            }
            $producto = $detalle->getDetalle();
            $producto = str_replace('"', "", $producto);
            $producto = str_replace('-', "", $producto);
            $producto = str_replace('/', "", $producto);

            $data["FuelQty"] = 0.0;
            $data["FuelTax"] = $hospedaje;
            $data["IUomCode"] = "UNIDAD";
            $data["IUomEntry"] = 1;
            $data["InvntItem"] = "Y";
            $data["ItemCode"] = $codigoPr;
            $data["ItemName"] = $producto;
            $data["KitchenOrder"] = "Y";
            $data["LineNum"] = $orden;
            $data["LineStatus"] = "NORMAL";
            $data["LineTotal"] = round($detalle->getValorUnitario(),2) * $detalle->getCantidad();//$detalle->getValorTotal();
    $GRAN_TOTAL=(round($detalle->getValorUnitario(),2) * $detalle->getCantidad()) +$GRAN_TOTAL;
            $data["ManSerNum"] = "N";
            $data["MonitorId"] = 1;
            $data["NumPerSale"] = 1.0;
            $data["Obs"] = "";
            $data["Orden"] = $orden;
            $data["OrderIndex"] = 0;
            $data["PrdStdCst"] = null;
            $data["Price"] = 0.0;
            $data["PriceAfVAT"] = round($detalle->getValorUnitario(),2);
            $data["Quantity"] = $detalle->getCantidad();
            $data["Ref1"] = "";
            $data["SUomCode"] = "UNIDAD";
            $data["SUomEntry"] = 1;
            $data["SlpCode"] = -1;
            $data["SlpName"] = "-Ningun empleado del departamento";
            $data["StoredPrice"] = 0.0;
            $data["TotalCost"] = null;
            $data["TreeType"] = "N";
            $data["Type"] = "I";
            $data["VatPrcnt"] = 0.0;
            $data["VatSum"] = 0.0;
            $data["VatType"] = $tipo;
            $data["WhsCode"] = $CODIGO_ESTABLECIMIENTO;
            $data["ok"] = null;
            $data["show"] = true;
            $data["temp"] = null;
            $json['Detail'][] = $data;
        }
        $username = $OPERACION->getEmpresa()->getFeelUsuario(); //  '630001';
        $password = $OPERACION->getEmpresa()->getFeelLlave(); // 'kuHag&xo9?w22pr#ka-A';
        if ($EMPRESAnit) {
            $username = $EMPRESAnit->getFeelUsuario(); //  '630001';
            $password = $EMPRESAnit->getFeelLlave(); // 'kuHag&xo9?w22pr#ka-A';  
        }

        $base64 = base64_encode($username . ":" . $password);

        $TEXTLOG = "usuario " . $username . " pass " . $password;
        $TEXTLOG .= " -----   END POINT  http://23.99.129.238/Dev/Document/UploadDocumentExt ";

       $dataH["DocTotal"] = 
                 
//        echo $TEXTLOG;
//        die();
        $json['Header'] = $dataH;
        $json_code = json_encode($json);
        $texto = $TEXTLOG . "  ---------------------- ";
        $texto .= $json_code;
        $texto .= "\n";


        $curl = curl_init();
        curl_setopt_array($curl, array(
            CURLOPT_URL => 'http://23.99.129.238/Dev/Document/UploadDocumentExt',
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_ENCODING => '',
            CURLOPT_MAXREDIRS => 10,
            CURLOPT_TIMEOUT => 0,
            CURLOPT_FOLLOWLOCATION => true,
            CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
            CURLOPT_CUSTOMREQUEST => 'POST',
            CURLOPT_POSTFIELDS => $json_code,
            CURLOPT_HTTPHEADER => array(
                'Content-Type: application/json',
                'Authorization: Basic ' . $base64
            ),
        ));
        $ERROR = "error";
        $info = curl_getinfo($curl);
        $info = json_encode($info);

        $response = curl_exec($curl);
        $texto .= "<BR> > ESTA ES LA RESPUESTA " . $response . " ESTE ES EL LOG DE CONSUMO  -->> -------------------- " . $info;
  
        $ruta = sfConfig::get("sf_upload_dir") . DIRECTORY_SEPARATOR . "logj.txt";
        $fh = fopen($ruta, 'w');
        fwrite($fh, $json_code);
        fclose($fh);

        
        
        
        $ruta = sfConfig::get("sf_upload_dir") . DIRECTORY_SEPARATOR . "logf.txt";
        $fh = fopen($ruta, 'w');
        fwrite($fh, $texto);
        fclose($fh);

        curl_close($curl);
        $resultad = json_decode($response);
        $ERROR = '';
        $CONTIGENCIA = '';
        $FECHA = '';
        $SERIE = '';
        $NUMERO = '';
        $UUID = '';
        $DocEntry = '';
        $Fecha_Cert = '';

//        echo "<pre>";
//        print_r(($response));
//        die();
//////        
        if ($resultad) {
            $ERROR = "";
            if (isset($resultad->Status)) {
                $estatus = $resultad->Status;
            }
            if (isset($resultad->status)) {
                $estatus = $resultad->status;
            }

            if (!$estatus) {
                $ERROR = serialize($resultad->Informacion);
            }
            if ($estatus) {
                $DATA = json_decode($resultad->Data);
                if (isset($resultad->errors)) {
                    $ERROR = serialize($resultad->errors);
                }

                if (isset($DATA->DocEntry)) {
                    $DocEntry = $DATA->DocEntry;
                }
                if (isset($DATA->Contingencia)) {
                    $CONTIGENCIA = $DATA->Contingencia;
                }


                if (isset($DATA->Fecha_Cert)) {
                    $Fecha_Cert = $DATA->Fecha_Cert;
                }
                if (isset($DATA->Serie)) {
                    $SERIE = $DATA->Serie;
                }
                if (isset($DATA->Numero)) {
                    $NUMERO = $DATA->Numero;
                }
                if (isset($DATA->UUID)) {
                    $UUID = $DATA->UUID;
                }
            }
        }
        $ERROR = substr($ERROR, 0, 400);
        $returna['ERROR'] = $ERROR; // = '';
        $returna['CONTIGENCIA'] = $CONTIGENCIA; // = '';
        $returna['FECHA'] = $FECHA; // = '';
        $returna['SERIE'] = $SERIE; // = '';
        $returna['NUMERO'] = $NUMERO; // = '';
        $returna['UUID'] = $UUID; // = '';

        $OPERACION->setDocentry($DocEntry);
        $OPERACION->setFaceError($ERROR);
        $OPERACION->setFaceReferencia($CONTIGENCIA);
        $OPERACION->setFaceSerieFactura($SERIE);
        $OPERACION->setFaceFirma($UUID);
        $OPERACION->setFaceNumeroFactura($NUMERO);
        $OPERACION->setCodigoFactura($Fecha_Cert);

        if ($ERROR) {
            $OPERACION->setFaceEstado("ERROR");
        }
        if ($CONTIGENCIA) {
            $OPERACION->setFaceEstado("CONTIGENCIA");
        }
        if ($UUID) {
            $returna['CONTIGENCIA'] = '';
            $returna['ERROR'] = '';
            $OPERACION->setFaceEstado("FIRMADO");
            $OPERACION->setFaceError('');
            $OPERACION->setFaceReferencia('');
        }

        $OPERACION->save();
        return $returna;
    }

    static public function NotaFel($operaId) {
        $OPERACION = OperacionQuery::create()->findOneById($operaId);
        $NIT = $OPERACION->getNit();
        $NIT = str_replace("-", "", $NIT);
        $NIT = str_replace(".", "", $NIT);
        $NIT = trim($NIT);
        $NIT = strtoupper($NIT);
        // $NIT='38321696';

        $dt['emisor_clave'] = $OPERACION->getEmpresa()->getFeelToken(); // '694B2B49CF96EF5BCF7F18B764A4533A';
        $dt['emisor_codigo'] = $OPERACION->getEmpresa()->getFeelNombre(); // 'DEMOPRUEBASTGC';
        $dt['nit_consulta'] = $NIT;
        $json_code = json_encode($dt);
        $username = $OPERACION->getEmpresa()->getFeelUsuario(); //  '630001';
        $password = $OPERACION->getEmpresa()->getFeelLlave(); //  'kuHag&xo9?w22pr#ka-A';

        $EMPRESAnit = EmpresaQuery::create()->findOneByTelefono($OPERACION->getTienda()->getNit());
        if ($EMPRESAnit) {
            $dt['emisor_clave'] = $EMPRESAnit->getFeelToken(); // '694B2B49CF96EF5BCF7F18B764A4533A';
            $dt['emisor_codigo'] = $EMPRESAnit->getFeelNombre(); // 'DEMOPRUEBASTGC';
            $dt['nit_consulta'] = $NIT;
            $json_code = json_encode($dt);
            $username = $EMPRESAnit->getFeelUsuario(); //  '630001';
            $password = $EMPRESAnit->getFeelLlave(); //  'kuHag&xo9?w22pr#ka-A';
        }


        $base64 = base64_encode($username . ":" . $password);
//        $curl = curl_init();
//        curl_setopt_array($curl, array(
//            CURLOPT_URL => 'https://consultareceptores.feel.com.gt/rest/action',
//            CURLOPT_RETURNTRANSFER => true,
//            CURLOPT_ENCODING => '',
//            CURLOPT_MAXREDIRS => 10,
//            CURLOPT_TIMEOUT => 0,
//            CURLOPT_FOLLOWLOCATION => true,
//            CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
//            CURLOPT_CUSTOMREQUEST => 'POST',
//            CURLOPT_POSTFIELDS => $json_code,
//            CURLOPT_HTTPHEADER => array(
//                'Content-Type: application/json',
//                'Authorization: Basic ' . $base64
//            ),
//        ));
//
//      
//        
//        $response = curl_exec($curl);
//        curl_close($curl);
//        $results = json_decode($response, true);
//        $mensaje = trim($results['mensaje']);
//         echo '<pre>';
//        print_r($response);
//        die();
//        if ($mensaje <> "") {
//            $returna['ERROR'] = $mensaje; // = '';
//            $returna['CONTIGENCIA'] = ''; // = '';
//            $returna['FECHA'] = ''; // = '';
//            $returna['SERIE'] = ''; // = '';
//            $returna['NUMERO'] = ''; // = '';
//            $returna['UUID'] = ''; // = '';
//            $OPERACION->setFaceEstado("ERROR NIT");
//            $OPERACION->setFaceError($mensaje);
//            $OPERACION->save();
//            return $returna;
//        }
        $operacionDetalle = OperacionDetalleQuery::create()
                ->filterByOperacionId($operaId)
                ->find();
        //** para CLINICA Y LA MAQUINA
        $CODIGO_EMPRESA = (int) $OPERACION->getTienda()->getCodigoEstablecimiento();
        $CODIGO_ESTABLECIMIENTO = "00001";
        ///****

        $CODIGO_ESTABLECIMIENTO = $OPERACION->getTienda()->getCodigoEstablecimiento();
        $CODIGO_EMPRESA = (int) $OPERACION->getEmpresa()->getNomenclatura(); // ->getCodigoEstablecimiento();

        if ($EMPRESAnit) {
            $CODIGO_EMPRESA = (int) $EMPRESAnit->getNomenclatura(); // ->getCodigoEstablecimiento(); 
        }


        $fecha = $OPERACION->getFecha('Ymd H:i:m') . ".112";
        $Docentry = $operaId;
        if (strlen($operaId) == 1) {
            $Docentry = "1000" . $operaId;
        }
        if (strlen($operaId) == 2) {
            $Docentry = "100" . $operaId;
        }
        if (strlen($operaId) == 3) {
            $Docentry = "1000" . $operaId;
        }

        $Docentry = (int) $Docentry;
        $dataH["Addid"] = $NIT;
        $dataH["Address"] = "CIUDAD";
        $dataH["Canceled"] = "N";
        $dataH["CardCode"] = 'NA';
        $dataH["CardCodeType"] = 1;
        $dataH["CardName"] = $OPERACION->getNombre();
        $dataH["CmpCode"] = $CODIGO_EMPRESA;
        $dataH["DiscPrcnt"] = 0.0;
        $dataH["DiscSum"] = 0.0;
        $dataH["DocCur"] = "QTZ";
        $dataH["DocDate"] = $fecha;
        $dataH["DocDueDate"] = null;
        $dataH["DocEntry"] = $Docentry;
        $dataH["DocNum"] = 0;
        $dataH["DocStatus"] = "C";
        $dataH["DocTotal"] = $OPERACION->getValorTotal();
        $dataH["DocType"] = 5;
        $dataH["DspCode"] = 1;
        $dataH["FatherCard"] = $OPERACION->getNit();
        $dataH["ListNum"] = 1;
        $dataH["LoyaltyClientId"] = "";
        $dataH["Mail"] = "";
        $dataH["Obs"] = "";
        $dataH["Packaging"] = "N";
        $dataH["PaidToDate"] = null;
        $dataH["Phone"] = "";
        $dataH["Printed"] = "N";
        $dataH["Ref1"] = $OPERACION->getDocentry();
        $dataH["Ref2"] = "";
        $dataH["Ref3"] = "";
        $dataH["Ref4"] = "";
        $dataH["Shift"] = "1";
        $dataH["ShiftDate"] = $OPERACION->getFecha('Ymd'); //  "20230822";
        $dataH["ShippingAddress"] = "";
        $dataH["SlpCode"] = -1;
        $dataH["StationId"] = 1;
        $dataH["TblCode"] = 0;
        $dataH["TipAmount"] = 0.0;
        $dataH["ToPay"] = null;
        $dataH["U_FEL_Numero"] = "";
        $dataH["U_FEL_Serie"] = "";
        $dataH["UserId"] = 'manager';
        $dataH["VatPercent"] = 0.0;
        $dataH["VatSum"] = 0.0;
        $dataH["WhsCode"] = $CODIGO_ESTABLECIMIENTO;

        $orden = 1;

        foreach ($operacionDetalle as $detalle) {
            $codigoPr = $orden . "_" . $detalle->getCodigo();
            //        $codigoPr='1000087922';
            $tipo = 'B';
            if ($detalle->getServicioId()) {
                $tipo = 'S';
            }
            $orden++;
            $data = null;
            $data["AddId"] = null;
            $data["AltDescription"] = "";
            $data["CardName"] = null;
            $data["CmpCode"] = $CODIGO_EMPRESA;
            $data["CmplmntType"] = null;
            $data["Confirm"] = null;
            $data["Cost"] = null;
            $data["CostingCode"] = null;
            $data["Currency"] = "QTZ";
            $data["DiscCode"] = 0;
            $data["DiscPrcnt"] = 0.0;
            $data["DiscSum"] = 0.0;
            $data["DiscUser"] = null;
            $data["DocDate"] = $fecha;
            $data["DocEntry"] = $Docentry;
            $data["EventCode"] = 0;
            $data["ExpCode"] = 0;
            $data["ExpDocDate"] = null;
            $data["ExpDocSerie"] = null;
            $data["ExpDocto"] = null;
            $data["FromWhsCod"] = "00001";
            $data["FromWhsName"] = null;
            $data["FuelId"] = "";
            $data["FuelQty"] = 0.0;
            $data["FuelTax"] = 0.0;
            $data["IUomCode"] = "UNIDAD";
            $data["IUomEntry"] = 1;
            $data["InvntItem"] = "Y";
            $data["ItemCode"] = $codigoPr;
            $data["ItemName"] = $detalle->getDetalle();
            $data["KitchenOrder"] = "Y";
            $data["LineNum"] = $orden;
            $data["LineStatus"] = "NORMAL";
            $data["LineTotal"] = $detalle->getValorTotal();
            $data["ManSerNum"] = "N";
            $data["MonitorId"] = 1;
            $data["NumPerSale"] = 1.0;
            $data["Obs"] = "";
            $data["Orden"] = $orden;
            $data["OrderIndex"] = 0;
            $data["PrdStdCst"] = null;
            $data["Price"] = 0.0;
            $data["PriceAfVAT"] =round( $detalle->getValorUnitario(),2);
            $data["Quantity"] = $detalle->getCantidad();
            $data["Ref1"] = $OPERACION->getDocentry();
            $data["SUomCode"] = "UNIDAD";
            $data["SUomEntry"] = 1;
            $data["SlpCode"] = -1;
            $data["SlpName"] = "-Ningun empleado del departamento";
            $data["StoredPrice"] = 0.0;
            $data["TotalCost"] = null;
            $data["TreeType"] = "N";
            $data["Type"] = "I";
            $data["VatPrcnt"] = 0.0;
            $data["VatSum"] = 0.0;
            $data["VatType"] = $tipo;
            $data["WhsCode"] = $CODIGO_ESTABLECIMIENTO;
            $data["ok"] = null;
            $data["show"] = true;
            $data["temp"] = null;
            $json['Detail'][] = $data;
        }
        $json['Header'] = $dataH;
        $json_code = json_encode($json);
        $texto = $json_code;
        $texto .= "\n";

        $username = $OPERACION->getEmpresa()->getFeelUsuario(); //  '630001';
        $password = $OPERACION->getEmpresa()->getFeelLlave(); //  'kuHag&xo9?w22pr#ka-A';
        if ($EMPRESAnit) {
            $username = $EMPRESAnit->getFeelUsuario(); //  '630001';
            $password = $EMPRESAnit->getFeelLlave(); // 'kuHag&xo9?w22pr#ka-A';  
        }

        $base64 = base64_encode($username . ":" . $password);

        $curl = curl_init();
        curl_setopt_array($curl, array(
            CURLOPT_URL => 'http://23.99.129.238/Dev/Document/UploadDocumentExt',
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_ENCODING => '',
            CURLOPT_MAXREDIRS => 10,
            CURLOPT_TIMEOUT => 0,
            CURLOPT_FOLLOWLOCATION => true,
            CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
            CURLOPT_CUSTOMREQUEST => 'POST',
            CURLOPT_POSTFIELDS => $json_code,
            CURLOPT_HTTPHEADER => array(
                'Content-Type: application/json',
                'Authorization: Basic ' . $base64
            ),
        ));

        $response = curl_exec($curl);
        $texto .= $response;
        $ruta = sfConfig::get("sf_upload_dir") . DIRECTORY_SEPARATOR . "logfelNOTA.txt";
        $fh = fopen($ruta, 'w');
        fwrite($fh, $texto);
        fclose($fh);

        curl_close($curl);
        $resultad = json_decode($response);
        $ERROR = 'NO SE PROCESO';
        $CONTIGENCIA = '';
        $FECHA = '';
        $SERIE = '';
        $NUMERO = '';
        $UUID = '';
        $DocEntry = '';
//
//        echo "<pre>";
//        print_r(($resultad));
//        die();
////        
        if ($resultad) {
            if (isset($resultad->Status)) {
                $estatus = $resultad->Status;
            }
            if (isset($resultad->status)) {
                $estatus = $resultad->status;
            }

            if (!$estatus) {
                $ERROR = serialize($resultad->Informacion);
            }
            if ($estatus) {
                $DATA = json_decode($resultad->Data);
                if (isset($resultad->errors)) {
                    $ERROR = serialize($resultad->errors);
                }

                if (isset($DATA->DocEntry)) {
                    $DocEntry = $DATA->DocEntry;
                }
                if (isset($DATA->Contingencia)) {
                    $CONTIGENCIA = $DATA->Contingencia;
                }
                if (isset($DATA->Fecha_Cert)) {
                    $FECHA = $DATA->Fecha_Cert;
                }
                if (isset($DATA->Serie)) {
                    $SERIE = $DATA->Serie;
                }
                if (isset($DATA->Numero)) {
                    $NUMERO = $DATA->Numero;
                }
                if (isset($DATA->UUID)) {
                    $UUID = $DATA->UUID;
                }
            }
        }
        $ERROR = substr($ERROR, 0, 400);
        $returna['Status'] = false;
        $returna['ERROR'] = $ERROR; // = '';
        $returna['CONTIGENCIA'] = $CONTIGENCIA; // = '';
        $returna['FECHA'] = $FECHA; // = '';
        $returna['SERIE'] = $SERIE; // = '';
        $returna['NUMERO'] = $NUMERO; // = '';
        $returna['UUID'] = $UUID; // = '';

        $OPERACION->setAnulaFaceFechaEmision($FECHA);
        $OPERACION->setAnulaDocentry($DocEntry);
        $OPERACION->setFaceError($ERROR);
        $OPERACION->setAnulaFaceReferencia($CONTIGENCIA);
        $OPERACION->setAnulaFaceSerieFactura($SERIE);
        $OPERACION->setAnulaFaceFirma($UUID);
        $OPERACION->setAnulaFaceNumeroFactura($NUMERO);
        if ($ERROR) {
            $OPERACION->setFaceEstado("ERROR");
        }
        if ($CONTIGENCIA) {
            $OPERACION->setFaceEstado("CONTIGENCIA");
        }
        if ($UUID) {
            $returna['CONTIGENCIA'] = '';
            $returna['ERROR'] = '';
            $returna['Status'] = true;
            $OPERACION->setFaceEstado("FIRMADONOTA");
            $OPERACION->setFaceError('');
            $OPERACION->setFaceReferencia('');
        }

        $OPERACION->save();
        return $returna;
    }

    public function getToken() {
        $return = '';
        $cotiza = OrdenCotizacionQuery::create()->findOneByCodigo($this->getCodigo());
        if ($cotiza) {
            $return = $cotiza->getToken();
        }
        return $return;
    }

    public function save(PropelPDO $con = null) {
        $empresaId = UsuarioQuery::getEmpresaSeleccionada('Operacion');

        if ($this->isNew()) {
            if ($empresaId) {
                $this->setEmpresaId($empresaId);
            }
            if (trim($this->getCodigo()) == "") {
                $tipo = $empresaId . 'OPE';
                $pre = $empresaId . 'OPE';
                $numero = 1;
                $busca = CorrelativoCodigoQuery::create()
                        ->filterByTipo($tipo)
                        ->findOne();
                if (!$busca) {
                    $busca = New CorrelativoCodigo();
                    $busca->setTipo($tipo);
                    $busca->setPrefijo($pre);
                    $busca->setNumeroAsginar($numero);
                    $busca->save();
                }
                $numero = $busca->getNumeroAsginar();
                $numero = $busca->getNumeroAsginar();
                $prefijo = $pre . $numero;
                if (strlen($numero) == 1) {
                    $prefijo = $pre . '0' . $numero;
                }
                if ($numero > 99) {
                    $prefijo = $pre . $numero;
                }
                $this->setCodigo($prefijo);
                $busca->setNumeroAsginar($numero + 1);
                $busca->save();
            }
        }

        parent::save($con);
    }

    public function getValorPrefechado() {
        $return = 0;
        $listaN[] = 'CHEQUE PREFECHADO';
        $listaN[] = 'CHEQUEPREFECHADO';
        $prefechado = OperacionPagoQuery::create()
                        ->withColumn('sum(OperacionPago.Valor)', 'ValorCheque')
                        ->filterByTipo($listaN, Criteria::IN)
                        ->filterByOperacionId($this->getId())->findOne();
        if ($prefechado) {
            $return = $prefechado->getValorCheque();
        }


        return $return;
    }

}
