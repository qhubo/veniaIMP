<?php

/**
 * Skeleton subclass for representing a row from the 'usuario_report' table.
 *
 *
 *
 * This class was autogenerated by Propel 1.6.7 on:
 *
 * 10/12/23 06:27:39
 *
 * You should add additional methods to this class to meet the
 * application requirements.  This class will only be generated as
 * long as it does not already exist in the output directory.
 *
 * @package    propel.generator.lib.model
 */
class UsuarioReport extends BaseUsuarioReport {

    static public function marcaAgua($original) {


        $arrImage = explode('/', $original);

        $nombreImagen = $arrImage[count($arrImage) - 1];
        $destino = str_replace($nombreImagen, "WM" . $nombreImagen, $original);
//echo $destino;
//die();
        # obtener la imagen
        //  $original = "images\guatemala.png";
# buscar el formato de la imagen mediante su extensión
        for ($i = strlen($original) - 1; $i > 0; $i--) {
            if (substr($original, $i, 1) == ".") {
                $tipo = substr($original, $i + 1);
                break;
            }
        }
# tamaño del original extraido del array devuelto por getimagesize
        $tamano = getimagesize($original);
        $orig_Ancho = $tamano[0];
        $orig_Alto = $tamano[1];
# estableceremos un margen en blanco alrededor de la imagen de 10 pixels
# igual por los cuatro lados
        $borde = 1;
        $Ancho = $orig_Ancho + 2 * $borde;
        $Alto = $orig_Alto + 2 * $borde;
# creamos la imagen segun el formato original
        switch ($tipo) {
            case "jpg":
                $importada = imagecreatefromjpeg($original);
                break;
            case "png":
                $importada = imagecreatefrompng($original);
                break;
            case "gif":
                $importada = imagecreatefromgif($original);
                break;
        }

# creamos una imagen nueva, un color de fondo y la rellenamos con él
        $im_base = imagecreatetruecolor($Ancho, $Alto);
//        $fondo = imagecolorAllocate($im_base, 235, 235, 245);
        $fondo = imagecolorAllocate($im_base, 255, 255, 255);
        //$fondo = imagecolorAllocate($im_base, 235, 235, 255);
        imagefill($im_base, 0, 0, $fondo);
# superponemos la imagen importada posicionandola y aplicandole
# una trasmparencia de 50
        imagecopymerge($im_base, $importada, $borde, $borde,
                0, 0, $orig_Ancho, $orig_Alto, 30);

        $orig_Ancho = $orig_Ancho / 4;
        $orig_Alto = $orig_Alto / 4;
        $orig_Ancho = (int) $orig_Ancho;
        $orig_Alto = (int) $orig_Alto;

        $returna['ancho'] = $orig_Ancho;
        $returna['alto'] = $orig_Alto;
        $returna['destino'] = '';
        $resultado = imagejpeg($im_base, $destino);
        if ($resultado) {
            $returna['destino'] = $destino;
        }
        //  ImageDestroy();
        return $returna;
    }

    static public function PDefault($tamanoPapel, $orientacion, $PosicionLogo, $UNA_LINEA, $tamanoLogo) {

        $medidas = '';
        $ocultaLogo = false;
        $anchoTotal = 10;
        $altoTotal = 10;

        // HORIZONTAL (L)  vertical (P)
        if ($tamanoPapel == 'Letter') {
            if ($orientacion == 'L') {
                // carta horizontal
                $maxAncho = '290';
                $maxAlto = '190';
                $anchoTotal = 300;
                $altoTotal = 210;
            }
            if ($orientacion == "P") {
                // carta vertical
                $maxAncho = '215';
                $maxAlto = '255';
                $anchoTotal = 215;
                $altoTotal = 299;
            }
        }


        if ($tamanoPapel == 'Legal') {
            if ($orientacion == 'L') {
                //  oficio   horizontal
                $maxAncho = '350';
                $maxAlto = '185';
                $anchoTotal = 298;
                $altoTotal = 215;
            }
            if ($orientacion == "P") {
                //  oficio  vertical
                $maxAncho = '215';
                $maxAlto = '322';

                $anchoTotal = 215;
                $altoTotal = 298;
            }
        }
        if ($tamanoPapel == 'A3') {
            if ($orientacion == 'L') {
                //     $orientacion = 'L'; // horizontal
                //   $tamanoPapel = 'A3';
                $maxAncho = '420';
                $maxAlto = '255';
                $anchoTotal = 420;
                $altoTotal = 305;
            }
            if ($orientacion == "P") {
                //    $orientacion = 'P'; // vertical
                //  $tamanoPapel = 'A3';
                $maxAncho = '285';
                $maxAlto = '380';
                $anchoTotal = 305;
                $altoTotal = 420;
            }
        }

        if ($tamanoPapel == 'A4') {
            if ($orientacion == 'L') {
                //   $orientacion = 'L'; // horizontal
                //  $tamanoPapel = 'A4';
                $maxAncho = '290';
                $maxAlto = '170';

                $anchoTotal = 300;
                $altoTotal = 210;
            }
            if ($orientacion == "P") {
                //   $orientacion = 'P'; // VERTICAL
                //  $tamanoPapel = 'A4';
                $maxAlto = '270';
                $maxAncho = '210';
                $anchoTotal = 210;
                $altoTotal = 300;
            }
        }

        if ($tamanoPapel == 'A5') {
            if ($orientacion == 'L') {
                //  $orientacion = 'L'; // horizontal
                //      $tamanoPapel = 'A5';
                $maxAncho = '210';
                $maxAlto = '120';
                $anchoTotal = 220;
                $altoTotal = 150;
            }
            if ($orientacion == "P") {
                //  $orientacion = 'P'; // VERTICAL
                //    $tamanoPapel = 'A5';
                $maxAncho = '145';
                $maxAlto = '180';
                $anchoTotal = 150;
                $altoTotal = 220;
            }
        }
        if ($tamanoPapel == 'A5V') {
            $maxAncho = '210';
            $maxAlto = '120';
            $anchoTotal = 220;
            $altoTotal = 150;
        }
        if ($tamanoPapel == 'A5H') {
            $maxAncho = '210';
            $maxAlto = '120';
            $anchoTotal = 220;
            $altoTotal = 150;
        }
//        echo $tamanoPapel;
//        die();
        if ($tamanoPapel == 'MediaCarta') {
            if ($orientacion == 'L') {
                $maxAncho = '245';
                $maxAlto = '220';
                $medidas = array($maxAncho, $maxAlto); // Ajustar aqui segun los milimetros necesarios;
                $maxAncho = $maxAncho - 30;
                $maxAlto = $maxAlto - 30;
                $anchoTotal = 245;
                $altoTotal = 250;
            }
            if ($orientacion == 'P') {
                $maxAlto = '245';
                $maxAncho = '220';
                $medidas = array($maxAncho, $maxAlto); // Ajustar aqui segun los milimetros necesarios;
                $maxAncho = $maxAncho - 20;
                $maxAlto = $maxAlto - 30;
                $anchoTotal = 250;
                $altoTotal = 245;
            }
        }

        //**  LOGO TAMANIO  UBICACION
        //  CARTA  VERTICAL      
        if ($PosicionLogo == 'SUPERIOR-IZQUIERDO') {
            $pos = 1;
            $y = 2; // SUPERIOR
            $x = 1;  //IZQUIERDA
        }
        if ($PosicionLogo == 'SUPERIOR-CENTRO') {
            $pos = 2;
            $y = 8; // SUPERIOR
            $x = (int) ($maxAncho - $tamanoLogo) / 2; // CENTRA
            if ($UNA_LINEA) {
                $ocultaLogo = true;
            }
        }
        if ($PosicionLogo == 'SUPERIOR-DERECHO') {
            $pos = 3;
            $y = 0; // SUPERIOR
            $x = $maxAncho - $tamanoLogo - 5; //;  //DERECHO
        }
        if ($PosicionLogo == 'CENTRO-IZQUIERDO') {
            $pos = 1;
            $y = (int) $maxAlto / 2; // CENTRO
            $x = 5;  //IZQUIERDA
        }
        if ($PosicionLogo == 'CENTRO-CENTRO') {
            $pos = 2;
            $y = (int) $maxAlto / 2; // CENTRO
            $x = (int) ($maxAncho - $tamanoLogo) / 2; // CENTRA
        }
        if ($PosicionLogo == 'CENTRO-DERECHO') {
            $pos = 3;
            $y = (int) $maxAlto / 2; // CENTRO
            $x = (int) ($maxAncho - $tamanoLogo) / 2; // CENTRA
        }
        if ($PosicionLogo == 'INFERIOR-IZQUIERDO') {
            $pos = 1;
            $y = $maxAlto; // INFERIOR
            $x = 5;  //IZQUIERDA
        }
        if ($PosicionLogo == 'INFERIOR-CENTRO') {
            $pos = 2;
            $y = $maxAlto; // INFERIOR
            $x = (int) ($maxAncho - $tamanoLogo) / 2; // CENTRA
        }
        if ($PosicionLogo == 'INFERIOR-DERECHO') {
            $pos = 3;
            $y = $maxAlto; // INFERIOR
            $x = $maxAncho - $tamanoLogo - 5; //;  //DERECHO
        }

        $return['medidas'] = $medidas;
        $return['ocultaLogo'] = $ocultaLogo;
        $return['maxAncho'] = $maxAncho;
        $return['maxAlto'] = $maxAlto;

        $return['anchoTotal'] = $anchoTotal;
        $return['altoTotal'] = $altoTotal;
        $return['pos'] = $pos;
        $return['y'] = $y;
        $return['x'] = $x;
        return $return;
    }

    static public function PValoresDefault($operacion,$nombreE=null) {

        $EMPRESAnit= EmpresaQuery::create()->findOneByTelefono($operacion->getTienda()->getNit());
        date_default_timezone_set("America/Guatemala");

        $return['GENERALES']['CodigoMoneda'] = 'GTQ';
        $return['GENERALES']['FechaHoraEmision'] = $operacion->getFecha('d/m/Y H:i:s');
        $return['GENERALES']['FechaHoraCertifica'] = '';
        if ($operacion->getCodigoFactura()) {
            $fechahora = explode(" ", $operacion->getCodigoFactura());
            $hora = $fechahora[1];
            $anio = substr($fechahora[0], 0, 4);
            $mes = substr($fechahora[0], 4, 2);
            $dia = substr($fechahora[0], 6, 2);
            $return['GENERALES']['FechaHoraCertifica'] = $dia . "/" . $mes . "/" . $anio . " " . $hora;
        }
        $return['GENERALES']['Tipo'] = 'FACT';
        if ($operacion->getFaceEstado() == "FIRMADONOTA") {
            $return['GENERALES']['Tipo'] = 'NCRE';
        }
        $return['GENERALES']['CodigoEscenario'] = 1;
        $return['TipoFrase']['TipoFrase'] = 1;
        $return['EMISOR']['AfiliacionIVA'] = 'GEN';
        $return['EMISOR']['CodigoEstablecimiento'] = $operacion->getTienda()->getCodigoEstablecimiento();
        $return['EMISOR']['CorreoEmisor'] = '';
        $return['EMISOR']['NombreEmisor'] = $operacion->getTienda()->getNombreComercial(); //> TANGRAM
        $return['EMISOR']['NombreComercial'] = $operacion->getEmpresa()->getNombre(); //  ILLUM, SOCIEDAD ANONIMA
        $return['EMISOR']['NITEmisor'] = $operacion->getEmpresa()->getTelefono();
        $return['EMISOR']['DireccionEmisor']['Direccion']['Direccion'] = $operacion->getEmpresa()->getDireccion();
   
        if ($EMPRESAnit) {
        $return['EMISOR']['NombreComercial'] = $EMPRESAnit->getNombre(); //  ILLUM, SOCIEDAD ANONIMA
        $return['EMISOR']['NITEmisor'] = $EMPRESAnit->getTelefono();
        $return['EMISOR']['DireccionEmisor']['Direccion']['Direccion'] = $EMPRESAnit->getDireccion();
       
        }
 
        
        $return['EMISOR']['DireccionEmisor']['Direccion']['CodigoPostal'] = 1;
        $return['EMISOR']['DireccionEmisor']['Direccion']['Municipio'] = 'Guatemala';
        $return['EMISOR']['DireccionEmisor']['Direccion']['Departamento'] = 'GUATEMALA';
        $return['EMISOR']['DireccionEmisor']['Direccion']['Pais'] = 'GT';
        $return['RECEPTOR']['CorreoReceptor'] = '';
        $return['RECEPTOR']['IDReceptor'] = $operacion->getNit();
        $return['RECEPTOR']['NombreReceptor'] = $operacion->getNombre();

        $return['Certificacion']['NITCertificador'] = '12521337';
        $return['Certificacion']['NombreCertificador'] = 'INFILE, S.A.';
        
        $return['Certificacion']['FechaHoraCertificacion'] = date('d/m/Y H:i:s');

        $return['CertificacionF']['Numero'] = $operacion->getFaceNumeroFactura();
        $return['CertificacionF']['Serie'] = $operacion->getFaceSerieFactura();
        $return['Certificacion']['NumeroAutorizacion'] = $operacion->getFaceFirma();
        $return['CertificacionF']['Serie'] = $operacion->getFaceSerieFactura();
            $return['CertificacionF']['anulaNumero'] = ""; //$operacion->getAnulaFaceNumeroFactura();
        $return['CertificacionF']['anulaSerie'] =""; // $operacion->getAnulaFaceSerieFactura();
        $return['Certificacion']['anulaNumeroAutorizacion'] =""; // $operacion->getAnulaFaceFirma();
        $return['CertificacionF']['anulaSerie'] = ""; // $operacion->getAnulaFaceSerieFactura(); 

        if ($operacion->getFaceEstado() == "FIRMADONOTA") {
       $return['CertificacionF']['Numero'] = $operacion->getAnulaFaceNumeroFactura();
        $return['CertificacionF']['Serie'] = $operacion->getAnulaFaceSerieFactura();
        $return['Certificacion']['NumeroAutorizacion'] = $operacion->getAnulaFaceFirma();
        $return['CertificacionF']['Serie'] =  $operacion->getAnulaFaceSerieFactura(); 
         $return['CertificacionF']['anulaNumero'] = $operacion->getFaceNumeroFactura();
        $return['CertificacionF']['anulaSerie'] =$operacion->getFaceSerieFactura();
        $return['Certificacion']['anulaNumeroAutorizacion'] =$operacion->getFaceFirma();
        $return['CertificacionF']['anulaSerie'] =  $operacion->getFaceSerieFactura(); 

        }
        
                if ($operacion->getFaceEstado() == "FIRMADO") {
                    if ($operacion->getAnulado()) {
       $return['CertificacionF']['Numero'] = $operacion->getAnulaFaceNumeroFactura();
        $return['CertificacionF']['Serie'] = $operacion->getAnulaFaceSerieFactura();
        $return['Certificacion']['NumeroAutorizacion'] = $operacion->getAnulaFaceFirma();
        $return['CertificacionF']['Serie'] =  $operacion->getAnulaFaceSerieFactura(); 
         $return['CertificacionF']['anulaNumero'] = $operacion->getFaceNumeroFactura();
        $return['CertificacionF']['anulaSerie'] =$operacion->getFaceSerieFactura();
        $return['Certificacion']['anulaNumeroAutorizacion'] =$operacion->getFaceFirma();
        $return['CertificacionF']['anulaSerie'] =  $operacion->getFaceSerieFactura(); 
                    }
        }
        
        

        $operacionDetalle = OperacionDetalleQuery::create()
                ->filterByOperacionId($operacion->getId())
                ->find();
        
        $can = 0;
        foreach ($operacionDetalle as $detalle) {
            $can++;

            $producto = null;
            $producto['BienOServicio'] = 'B';
            if ($detalle->getServicioId()) {
                $producto['BienOServicio'] = 'S';
            }
            $producto['NumeroLinea'] = $can;
            $producto['Cantidad'] = $detalle->getCantidad();
            $producto['Descripcion'] = $detalle->getCodigo() . " " . $detalle->getDetalle();
            $producto['PrecioUnitario'] = $detalle->getValorUnitario();
            $producto['Precio'] = $detalle->getValorTotal();
            $producto['Descuento'] = 0;
            $producto['OtrosDescuento'] = 0;
            $return['lineas'][] = $producto;
        }
        $return['GENERALES']['Tipo'] = 'FACT';
        $return['GENERALES']['CodigoEscenario'] = 1;
        $codigoEscenario=trim($operacion->getEmpresa()->getNomenclatura());
                 if ($EMPRESAnit) {
        $codigoEscenario=trim($EMPRESAnit->getNomenclatura());           
                 }
        if ($codigoEscenario) {
         $return['GENERALES']['CodigoEscenario'] = $codigoEscenario;  /// POR EMPRESA
        }
        //       $return = UsuarioReportQuery::lecturaPDF($rutaxml);
        $tipoDOc = $return['GENERALES']['Tipo'];
        switch ($tipoDOc) {
            case "FACT":
                $return['GENERALES']['Tipo'] = "Factura ";
                   if ( strtoupper($nombreE)=="IMPORTADORAINFINIT") {
                    $return['GENERALES']['Tipo'] = "Factura Cambiaria libre de protesto ";  
                  }
                break;
            case "FCAM":
                $return['GENERALES']['Tipo'] = "Factura Cambiaria";
                   if ($nombreE=="IMPORTADORAINFINIT") {
                    $return['GENERALES']['Tipo'] = "Factura Cambiaria libre de protesto ";  
                  }
                break;
            case "FPEQ":
                $return['GENERALES']['Tipo'] = " Factura Pequeño Contribuyente";
                break;
            case "FCAP":
                $return['GENERALES']['Tipo'] = " Factura Cambiaria Pequeño Contribuyente ";
                break;
            case "FESP":
                $return['GENERALES']['Tipo'] = "Factura Especial";
                break;
            case "NABN":
                $return['GENERALES']['Tipo'] = "Nota de Abono ";
                break;
            case "RDON":
                $return['GENERALES']['Tipo'] = "Recibo por donación ";
                break;
            case "RECI":
                $return['GENERALES']['Tipo'] = "Recibo";
                break;
            case "NDEB":
                $return['GENERALES']['Tipo'] = "Nota de Débito";
                break;
            case "NCRE":
                $return['GENERALES']['Tipo'] = "Nota de Crédito";
                break;
            case "FACA":
                $return['GENERALES']['Tipo'] = " Factura Contribuyente Agropecuario";
                break;
            case "FCCA":
                $return['GENERALES']['Tipo'] = "Factura Cambiaria Contribuyente Agropecuario";
                break;
            case "FAPE":
                $return['GENERALES']['Tipo'] = "Factura Pequeño Contribuyente Régimen Electrónico";
                break;
            case "FCPE":
                $return['GENERALES']['Tipo'] = "Factura Cambiaria Pequeño Contribuyente Régimen Electrónico";
                break;
            case "FAAE":
                $return['GENERALES']['Tipo'] = "Factura Contribuyente Agropecuario Régimen Electrónico Especial";
                break;
        }
        $tipoEscenario = $return['GENERALES']['CodigoEscenario'];
        switch ($tipoEscenario) {
            case "1":
                $return['GENERALES']['LEYENDA'] = "Sujeto a pagos trimestrales ISR ";
                break;
            case "2":
                $return['GENERALES']['LEYENDA'] = "Sujeto a retención definitiva ISR";
                break;
            case "3":
                $return['GENERALES']['LEYENDA'] = "Sujeto a pago directo ISR";
                break;
            case "3":
                $return['GENERALES']['LEYENDA'] = "Exento del ISR";
                break;
        }


//        echo "<pre>";
//        print_r($return);
//        die();



        RETURN $return;
    }

}
