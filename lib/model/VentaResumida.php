<?php

/**
 * Skeleton subclass for representing a row from the 'venta_resumida' table.
 *
 *
 *
 * This class was autogenerated by Propel 1.6.7 on:
 *
 * 06/01/22 22:34:35
 *
 * You should add additional methods to this class to meet the
 * application requirements.  This class will only be generated as
 * long as it does not already exist in the output directory.
 *
 * @package    propel.generator.lib.model
 */
class VentaResumida extends BaseVentaResumida {

        public function getConfirmada() {
            
            $retorna =false;
            $partidaQ = PartidaQuery::create()->findOneById($this->getPartidaNo());
           if ($partidaQ) {
               $retorna=$partidaQ->getConfirmada();
           }
           return $retorna;
            
        }
    public function getValorCuota($cuota) {
        $valor = 0;
        $id = 0;
        $busqueQ = VentaResumidaLineaQuery::create()
                ->filterByVentaResumidaId($this->getId())
                ->filterByNumeroCuotas($cuota)
                ->findOne();

        if ($busqueQ) {
            $valor = $busqueQ->getTotalLinea();
            $id = $busqueQ->getId();
        }
        $retorna['valor'] = $valor;
        $retorna['id'] = $id;
        return $retorna;
    }

    public function getValorDeposito() {

        $return = $this->getTotal() - $this->getComision() - $this->getIva() - $this->getRetencion();
        return $return;
    }

    static public function valores($medioPagoQ, $valor) {
        $comision = ($medioPagoQ->getComision() * $valor) / 100;
        $comision = round($comision / 1.12, 4);
        ///*** VALIDAR si no hay comision Como sacar el IVA
        $iva = 0;
        if ($comision > 0) {
            $iva = round($comision * 0.12, 4);
        }
        $retencion = 0;
        if ($medioPagoQ->getRetieneIsr()) {
            $retencion = round($valor / 1.12 * 0.12 * 0.15, 4);
        }
        $valor = round($valor, 2);
        $comision = round($comision, 2);
        $iva = round($iva, 2);

        $retencion = round($retencion, 2);

        $TotalDeposito = $valor - $comision - $iva - $retencion;
        $returna = $comision . "|" . $iva . "|" . $retencion . "|" . $TotalDeposito;
        return $returna;
    }

    public function save(PropelPDO $con = null) {
        $empresaId = UsuarioQuery::getEmpresaSeleccionada('VentaResumida');

        if ($this->isNew()) {
            if ($empresaId) {
                $this->setEmpresaId($empresaId);
            }
        }

        parent::save($con);
    }
    
    
    static public  function datos($fecha, $tiendaId) {
        $operaciones = PartidaDetalleQuery::create();
        $operaciones->usePartidaQuery();
//        $operaciones->withColumn('sum(PartidaDetalle.Haber)', 'TotalHaber');
//        $operaciones->withColumn('sum(PartidaDetalle.Debe)', 'TotalDebe');
//        $operaciones->withColumn('max(Partida.TiendaId)', 'MaxNumero');
        $operaciones->where("Partida.Tipo = 'Venta Resumida'");
   //     $operaciones->where("Partida.Confirmada=1");
        $operaciones->where("Partida.TiendaId = '" . $tiendaId . "'");
        $operaciones->where("Partida.FechaContable = '" . $fecha . "'");
        $operaciones->orderByPartidaId();
//        $operaciones->groupBy('Partida.FechaContable');
//        $operaciones->groupBy('PartidaDetalle.CuentaContable');
//        $operaciones->groupBy('PartidaDetalle.Detalle');
        $operaciones = $operaciones->find();

        return $operaciones;
    }

 static public  function datosAgrupado($fecha, $tiendaId) {
        $operaciones = PartidaDetalleQuery::create();
        $operaciones->usePartidaQuery();
        $operaciones->withColumn('sum(PartidaDetalle.Haber)', 'TotalHaber');
        $operaciones->withColumn('sum(PartidaDetalle.Debe)', 'TotalDebe');
        $operaciones->withColumn('max(Partida.TiendaId)', 'MaxNumero');
        $operaciones->where("Partida.Tipo = 'Venta Resumida'");
    //    $operaciones->where("Partida.Confirmada=1");
        $operaciones->where("Partida.TiendaId = '" . $tiendaId . "'");
        $operaciones->where("Partida.FechaContable = '" . $fecha . "'");
        $operaciones->orderByPartidaId();
        $operaciones->groupBy('Partida.FechaContable');
        $operaciones->groupBy('PartidaDetalle.CuentaContable');
        $operaciones->groupBy('PartidaDetalle.Detalle');
        $operaciones = $operaciones->find();

        return $operaciones;
    }

}
