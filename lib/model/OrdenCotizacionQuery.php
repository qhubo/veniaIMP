<?php

/**
 * Skeleton subclass for performing query and update operations on the 'orden_cotizacion' table.
 *
 *
 *
 * This class was autogenerated by Propel 1.6.7 on:
 *
 * 01/31/22 22:53:48
 *
 * You should add additional methods to this class to meet the
 * application requirements.  This class will only be generated as
 * long as it does not already exist in the output directory.
 *
 * @package    propel.generator.lib.model
 */
class OrdenCotizacionQuery extends BaseOrdenCotizacionQuery {

    public function __construct($dbName = 'propel', $modelName = 'OrdenCotizacion', $modelAlias = null) {
        parent::__construct($dbName, $modelName, $modelAlias);
        $empresa_id = UsuarioQuery::getEmpresaSeleccionada('OrdenCotizacion');
        $filtra = sfContext::getInstance()->getUser()->getAttribute('usuario', null, 'filtra_empresa');
        $filtra = true;
        if ($filtra) {
            if ($empresa_id) {
                $this->filterByEmpresaId($empresa_id);
            }
        }
    }

    static public function ProcesaAuto($cotizacion) {
          error_reporting(-1);
        date_default_timezone_set("America/Guatemala");
        // **** CREACION DE OPERACION 
        $operacion = OperacionQuery::create()->findOneByCodigo($cotizacion->getCodigo());
        if (!$operacion) {
            $operacion = new Operacion();
            $operacion->setCodigo($cotizacion->getCodigo());
            $operacion->save();
        }
        $tiendaQ = TiendaQuery::create()->findOneById($cotizacion->getTiendaId());
        if (!$tiendaQ) {
            $tiendaQ = TiendaQuery::create()->findOne();
        }
        $operacion->setCodigoEstablecimiento($tiendaQ->getCodigoEstablecimiento());
        $operacion->setFecha(date('Y-m-d H:i:s'));
        $operacion->setTipo("Cotizacion");
        $operacion->setEstatus('Procesada');
        $operacion->setObservaciones($cotizacion->getComentario());
        $operacion->setNombre($cotizacion->getNombre());
        $operacion->setUsuario(sfContext::getInstance()->getUser()->getAttribute('usuarioNombre', null, 'seguridad'));
        $operacion->setNit($cotizacion->getNit());
        $operacion->setCorreo($cotizacion->getCorreo());
        $operacion->setValorTotal($cotizacion->getValorTotal());
        $operacion->setIva($cotizacion->getIva());
        $operacion->setSubTotal($cotizacion->getSubTotal());
        $operacion->setTiendaId($cotizacion->getTiendaId());
        $operacion->setObservaciones($cotizacion->getComentario());
        $operacion->setRecetarioId($cotizacion->getRecetarioId());
        $operacion->setPesoTotal($cotizacion->getPesoTotal());
        $operacion->setCantidadTotalCaja($cotizacion->getCantidadTotalCaja());

        if ($cotizacion->getClienteId()) {
            $operacion->setClienteId($cotizacion->getClienteId());
        }
        $operacion->save();
        /// ** FIN CREACION
        $ordenDetalle = OrdenCotizacionDetalleQuery::create()
                ->filterByOrdenCotizacionId($cotizacion->getId())
                ->find();
        $bodegaId = $operacion->getTiendaId();
        $empresaId = $operacion->getEmpresaId();
        foreach ($ordenDetalle as $regi) {
            //** CREACION DE LINEA
            $detalle = new OperacionDetalle();
            $detalle->setServicioId($regi->getServicioId());
            $detalle->setCodigo($regi->getCodigo());
            $detalle->setOperacionId($operacion->getId());
            $detalle->setProductoId($regi->getProductoId());
            $detalle->setDetalle($regi->getDetalle());
            $detalle->setValorUnitario($regi->getValorUnitario());
            $detalle->setValorTotal($regi->getValorTotal());
            $detalle->setTotalIva($regi->getTotalIva());
            $detalle->setCantidad($regi->getCantidad());
            $detalle->setCostoUnitario($regi->getCostoUnitario());
            $detalle->save();
            $regi = $detalle;
            $productoQuery = ProductoQuery::create()->findOneById($regi->getProductoId());
            if ($productoQuery) {
                $clave = $productoQuery->getId();
                $valoresIVa = ParametroQuery::ObtenerIva($regi->getValorTotal(), false);
                ProductoMovimientoQuery::Salida($clave, $regi->getCantidad(), 'VENTA', $operacion->getTiendaId(), $operacion->getCodigo() . "-" . $regi->getId(), null, $valoresIVa);
                ProductoExistenciaQuery::Resta($clave, $regi->getCantidad(), $bodegaId);
                $ListaProductos = ProductoExistenciaQuery::create()
                        ->filterByEmpresaId($empresaId)
                        ->filterByProductoId($clave)
                        ->withColumn('sum(ProductoExistencia.Cantidad)', 'ValorTotal')
                        ->findOne();
                $nuevaExistencia = $ListaProductos->getValorTotal();
                $productoQuery->setExistencia($nuevaExistencia);
                $productoQuery->save();
            }
            // ** FIN LINEA
        }
        BitacoraDocumento::grabacion('Cotizacion', $cotizacion->getCodigo(), 'Finalizacion', "Cotizacion Finalizada");

        $PROCESADO = false;
        $ubicacionesPro = OrdenUbicacionQuery::create()
                ->filterByProcesado(false)
                ->filterByOrdenCotizacionId($cotizacion->getId())
                ->find();
        foreach ($ubicacionesPro as $lista) {
            $ubicacActual = ProductoUbicacionQuery::create()
                    ->filterByUbicacion($lista->getUbicacionId())
                    ->filterByProductoId($lista->getProductoId())
                    ->filterByTiendaId($lista->getTiendaId())
                    ->findOne();
            if ($ubicacActual) {
                $PROCESADO = true;
                $existeActual = $ubicacActual->getCantidad();
                $nuevaCantidad = $existeActual - $lista->getCantidad();
                $ubicacActual->setCantidad($nuevaCantidad);
                $ubicacActual->save();
            }
            $lista->setProcesado(true);
            $lista->save();
        }


        if (!$PROCESADO) {
            foreach ($ordenDetalle as $regi) {
                $cantidad = $regi->getCantidad();
                for ($i = 1; $i <= $cantidad; $i++) {
                    $ubicacioActual = ProductoUbicacionQuery::create()
                            ->filterByProductoId($regi->getProductoId())
                            ->filterByCantidad(0, Criteria::GREATER_THAN)
                            ->filterByTiendaId($cotizacion->getTiendaId())
                            ->findOne();
                    if ($ubicacioActual) {
                        $cantidadAct = $ubicacioActual->getCantidad()-1;
                        $ubicacioActual->setCantidad($cantidadAct);
                        $ubicacioActual->save();
                    }
                }
            }
        }

// if (!$operacion->getPartidaNo()) {
//           OrdenCotizacionQuery::partidaInventario($operacion);
//           
//           $cotizacion->setPartidaNo($operacion->getPartidaNo());
//           $cotizacion->save();
        // }
        return $operacion->getId();
    }

    static public function partidaVenta($operacion) {
        //    $ordenProveedor = OrdenProveedorQuery::create()->findOneByCodigo($codigo);
        $operacionDetalle = OperacionDetalleQuery::create()
                ->filterByOperacionId($operacion->getId())
                ->useProductoQuery()
                ->useTipoAparatoQuery()
                ->endUse()
                ->endUse()
                ->groupBy('TipoAparato.CuentaContable')
                ->withColumn('sum(OperacionDetalle.Cantidad)', 'TotalCantidad')
                ->withColumn('sum(OperacionDetalle.ValorTotal)', 'TotalGeneral')
                ->find();
        $TOTALIVA = 0;
        $VALORtotal = $operacion->getValorTotal();

        $partidaQ = new Partida();
        $partidaQ->setFechaContable($operacion->getFecha('Y-m-d'));
        $partidaQ->setUsuario($operacion->getUsuario());
        $partidaQ->setTipo('Venta');
        $partidaQ->setCodigo($operacion->getCodigo());
        $partidaQ->setValor($VALORtotal);
        $partidaQ->setTiendaId($operacion->getTiendaId());
        $partidaQ->save();


        $opercionPago = OperacionPagoQuery::create()
                ->withColumn('sum(OperacionPago.Valor)', 'TotalGeneral')
                ->filterByOperacionId($operacion->getId())
                ->groupByTipo()
                ->find();
        $valorPago = 0;
        foreach ($opercionPago as $regi) {
            $cuentaContable ='';
            $ban = '';
            $valorPago = $valorPago + $regi->getTotalGeneral();
            $MEDIP = MedioPagoQuery::create()->findOneByNombre($regi->getTipo());
            if ($MEDIP) {
                $cuentaQ = CuentaErpContableQuery::create()->findOneByCuentaContable($MEDIP->getCuentaContable());
                if ($cuentaQ) {
                    $cuentaContable = $cuentaQ->getCuentaContable();
                    $nombreCuenta = $cuentaQ->getNombre();
                }
            }
            if ($regi->getBancoId()) {
                $ban = substr($regi->getBanco()->getNombre(), 4);
            }
            if (!$cuentaContable) {
                $cuentaPartida = Partida::busca("VENTA " . $regi->getTipo() . " " . $ban, 0, 2);
                $cuentaContable = $cuentaPartida['cuenta'];
                $nombreCuenta = $cuentaPartida['nombre'];
            }
            $partidaLinea = new PartidaDetalle();
            $partidaLinea->setPartidaId($partidaQ->getId());
            $partidaLinea->setDetalle($nombreCuenta);
            $partidaLinea->setCuentaContable($cuentaContable);
            $partidaLinea->setDebe($regi->getTotalGeneral());
            $partidaLinea->setHaber(0);
            $partidaLinea->setGrupo("VENTA " . $regi->getTipo() . " " . $ban);
            $partidaLinea->save();
            $operacion->setPartidaNo($partidaQ->getId());
            $operacion->save();
        }
        $valorCredito = $VALORtotal - $valorPago;
        if ($valorCredito > 0) {
            //** VENTA AL CREDITO
            $cuentaPartida = Partida::busca("CLIENTES POR COBRAR", 0, 2);
            $cuentaContable = $cuentaPartida['cuenta'];
            $nombreCuenta = $cuentaPartida['nombre'];
            $partidaLinea = new PartidaDetalle();
            $partidaLinea->setPartidaId($partidaQ->getId());
            $partidaLinea->setDetalle($nombreCuenta);
            $partidaLinea->setCuentaContable($cuentaContable);
            $partidaLinea->setDebe($operacion->getValorTotal());
            $partidaLinea->setHaber(0);
            $partidaLinea->setGrupo("CLIENTES POR COBRAR");
            $partidaLinea->save();
            $operacion->setPartidaNo($partidaQ->getId());
            $operacion->save();
//            $operacionPago = new OperacionPago();
//            $operacionPago->setOperacionId($operacion->getId());
//            $operacionPago->setTipo('CXC COBRAR');
//            $operacionPago->setValor($operacion->getValorTotal());
//            $operacionPago->setFechaCreo(date('Y-m-d'));
//            $operacionPago->setPartidaNo($partidaQ->getId());
//            $operacionPago->setFechaDocumento(date('Y-m-d'));
//            $operacionPago->save();
        }

        $COSTO_VENTA = 0;
        $detalle = OperacionDetalleQuery::create()->filterByProductoId(null, Criteria::NOT_EQUAL)->filterByOperacionId($operacion->getId())->find();
        foreach ($detalle as $regi) {
            $COSTO_VENTA = $COSTO_VENTA + ($regi->getProducto()->getCostoProveedor() * $regi->getCantidad());
        }




        /// PRODUCTOS
        foreach ($operacionDetalle as $registro) {
            //$cuenContable = ($registro->getProducto()->getTipoAparato()->getCuentaContable());
            if ($registro->getProductoId()) {
                $grupo = "VENTAS Producto " . $registro->getProducto()->getTipoAparato()->getCodigo();
                $cuentaPartida = Partida::busca($grupo, 1, 1);
                $cuentaContable = $cuentaPartida['cuenta'];
                $nombreCuenta = $cuentaPartida['nombre'];
            }
//$nombreCuenta = Partida::cuenta($cuentaContable);
            $valoresIva = ParametroQuery::ObtenerIva($registro->getTotalGeneral(), false);
            $valor = $valoresIva['VALOR_SIN_IVA'];
            $TOTALIVA = $valoresIva['IVA'] + $TOTALIVA;
            $VALORtotal = $registro->getTotalGeneral() + $VALORtotal;
            $partidaLinea = new PartidaDetalle();
            $partidaLinea->setPartidaId($partidaQ->getId());
            $partidaLinea->setDetalle($nombreCuenta);
            $partidaLinea->setCuentaContable($cuentaContable);
            $partidaLinea->setDebe(0);
            $partidaLinea->setHaber($valor);
            $partidaLinea->setTipo(1);
            $partidaLinea->setGrupo("VENTAS Producto " . $registro->getProducto()->getTipoAparato()->getCodigo());
            $partidaLinea->save();
        }
        // SERVICIOS
        $operacionDetalle = OperacionDetalleQuery::create()
                ->filterByOperacionId($operacion->getId())
                ->filterByServicioId(null, Criteria::NOT_EQUAL)
                ->find();
        foreach ($operacionDetalle as $registro) {
            if ($registro->getServicioId()) {
                $cuentaContableQ = CuentaErpContableQuery::create()->findOneByCuentaContable($registro->getServicio()->getCuentaContable());
                if ($cuentaContableQ) {
                    $cuentaContable = $cuentaContableQ->getCuentaContable();
                    $nombreCuenta = $cuentaContableQ->getNombre();
                }
                $grupo = "Servicio " . $registro->getServicio()->getCodigo();
                if (!$cuentaContableQ) {
                    $cuentaPartida = Partida::busca($grupo, 1, 1);
                    $cuentaContable = $cuentaPartida['cuenta'];
                    $nombreCuenta = $cuentaPartida['nombre'];
                }
            }
            $valoresIva = ParametroQuery::ObtenerIva($registro->getValorTotal(), false);
            $valor = $valoresIva['VALOR_SIN_IVA']-$operacion->getImpuestoHotel();
            $TOTALIVA = $valoresIva['IVA'] + $TOTALIVA;
            $VALORtotal = $registro->getValorTotal() + $VALORtotal;
            $partidaLinea = new PartidaDetalle();
            $partidaLinea->setPartidaId($partidaQ->getId());
            $partidaLinea->setDetalle($nombreCuenta);
            $partidaLinea->setCuentaContable($cuentaContable);
            $partidaLinea->setDebe(0);
            $partidaLinea->setHaber($valor);
            $partidaLinea->setTipo(1);
            $partidaLinea->setGrupo($grupo);
            $partidaLinea->save();
        }
        /// FIN DE SERVICIOS
//        $cuentaContable = '1.1.4.1.001';
//        $nombreCuenta = Partida::cuenta($cuentaContable);
        if ($operacion->getImpuestoHotel()>0) {
        $cuentaPartida = Partida::busca("IMPUESTO HOTEL", 0, 2);
        $cuentaContable = $cuentaPartida['cuenta'];
        $nombreCuenta = $cuentaPartida['nombre'];
        $partidaLinea = new PartidaDetalle();
        $partidaLinea->setPartidaId($partidaQ->getId());
        $partidaLinea->setDetalle($nombreCuenta);
        $partidaLinea->setCuentaContable($cuentaContable);
        $partidaLinea->setDebe(0);
        $partidaLinea->setHaber($operacion->getImpuestoHotel());
        $partidaLinea->setGrupo("IMPUESTO HOTEL");
        $partidaLinea->save();
        }
        
            $cuentaPartida = Partida::busca("IVA CREDITO", 0, 2);
        $cuentaContable = $cuentaPartida['cuenta'];
        $nombreCuenta = $cuentaPartida['nombre'];
        $partidaLinea = new PartidaDetalle();
        $partidaLinea->setPartidaId($partidaQ->getId());
        $partidaLinea->setDetalle($nombreCuenta);
        $partidaLinea->setCuentaContable($cuentaContable);
        $partidaLinea->setDebe(0);
        $partidaLinea->setHaber($TOTALIVA);
        $partidaLinea->setGrupo("IVA CREDITO");
        $partidaLinea->save();
        
        
        
        

        if ($COSTO_VENTA > 0) {
            $cuentaPartida = Partida::busca("COSTO VENTA", 0, 2);
            $cuentaContable = $cuentaPartida['cuenta'];
            $nombreCuenta = $cuentaPartida['nombre'];
            $partidaLinea = new PartidaDetalle();
            $partidaLinea->setPartidaId($partidaQ->getId());
            $partidaLinea->setDetalle($nombreCuenta);
            $partidaLinea->setCuentaContable($cuentaContable);
            $partidaLinea->setDebe($COSTO_VENTA);
            $partidaLinea->setHaber(0);
            $partidaLinea->setGrupo("COSTO VENTA");
            $partidaLinea->save();
            $cuentaPartida = Partida::busca("INVENTARIO", 0, 2);
            $cuentaContable = $cuentaPartida['cuenta'];
            $nombreCuenta = $cuentaPartida['nombre'];
            $partidaLinea = new PartidaDetalle();
            $partidaLinea->setPartidaId($partidaQ->getId());
            $partidaLinea->setDetalle($nombreCuenta);
            $partidaLinea->setCuentaContable($cuentaContable);
            $partidaLinea->setDebe(0);
            $partidaLinea->setHaber($COSTO_VENTA);
            $partidaLinea->setGrupo("INVENTARIO");
            $partidaLinea->save();
        }

//        $cuentaContable = '2.1.1.2.001';
//        $nombreCuenta = Partida::cuenta($cuentaContable);
    }

}
