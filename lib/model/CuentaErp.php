<?php

/**
 * Skeleton subclass for representing a row from the 'cuenta_erp' table.
 *
 *
 *
 * This class was autogenerated by Propel 1.6.7 on:
 *
 * 01/11/22 01:11:38
 *
 * You should add additional methods to this class to meet the
 * application requirements.  This class will only be generated as
 * long as it does not already exist in the output directory.
 *
 * @package    propel.generator.lib.model
 */
class CuentaErp extends BaseCuentaErp {

    static public function pobladatosPartida($id, $todas = false) {

        $usuarioId = sfContext::getInstance()->getUser()->getAttribute('usuario', null, 'seguridad');
        $usuarioQue = UsuarioQuery::create()->findOneById($usuarioId);
        $empresaId = $usuarioQue->getEmpresaId();
        $lineaInicial = 2;

        header('Content-type: text/plain; charset=utf-8');
        $bitacora = BitacoraArchivoQuery::create()->findOneById($id);
        sfContext::getInstance()->getUser()->setAttribute('muestrabusqueda', 0, 'busqueda');
        $filename = $bitacora->getNombre();
        $inputFileName = sfConfig::get("sf_upload_dir") . DIRECTORY_SEPARATOR . 'cargas' . DIRECTORY_SEPARATOR . $filename;
        $objReader = new PHPExcel_Reader_Excel5();
        $objPHPExcel = $objReader->load($inputFileName);
        $sheetData = $objPHPExcel->getActiveSheet()->toArray(null, true, true, true);
        $contador = 0;

        $colFECHA = null;
        $colCUENTA = null;
        $colDOCUMENTO = null;
        $colDESCRIPCION = null;
        $colDEBE = null;
        $colHABER = null;
        $colASIENTO = null;
        $colTIPO = null;
        $colNUMERO = null;
        $colDETALLE = null;
        $datosGrupo = null;
//        echo "<pre>";
//        print_r($sheetData);
//        die();
        $listaId = null;
        $NUMERO = 0;
        foreach ($sheetData as $registro) {
            $lista = null;
            $listaOrdenda = null;
            $FECHA = null;
            $CUENTA = null;
            $DOCUMENTO = null;
            $DESCRIPCION = null;
            $DEBE = null;
            $HABER = null;

            $TIPO = null;
            $NUMERO = null;
            $DETALLE = null;

            $ASIENTO = NULL;
            $valido = true;
            $contador++;
            $textoPendiente = '';
            $pendientes = null;
            $lin = $lineaInicial;
            /// encabezado
            //   echo PlantillaCampoQuery::campo($empresaId, 'codigo_sku');
            if ($contador == $lineaInicial) {
                for ($i = 0; $i <= 10; $i++) {
                    $letra = CorrelativoCodigoQuery::numeroletra($i); //sfContext::getInstance()->getUser()->numeroletra($i);
                    $campo = trim(strtoupper(($registro[$letra])));
                    $campo = ($campo);
//                    $campo = ProveedorPeer::limpiatil($campo);
                    $campo = trim(strtoupper($campo));
                    $campo = str_replace(" ", "", $campo); //                  
//                         echo $campo;
//                        echo " ------------- ";
                    switch ($campo) {
                        case 'FECHA':
                            $colFECHA = $letra;
                            break;
                        case 'CUENTA':
                            $colCUENTA = $letra;
                            break;
                        case 'DOCUMENTO':
                            $colDOCUMENTO = $letra;
                            break;
                        case 'DEBE':
                            $colDEBE = $letra;
                            break;
                        case 'DESCRIPCION':
                            $colDESCRIPCION = $letra;
                            break;
                        case 'HABER':
                            $colHABER = $letra;
                            break;
                        case 'ASIENTO':
                            $colASIENTO = $letra;
                            break;
                        case 'TIPO':
                            $colTIPO = $letra;
                            break;
                        case 'NUMERO':
                            $colNUMERO = $letra;
                            break;
                        case 'DETALLE':
                            $colDETALLE = $letra;
                            break;
                    }
                }
                //     die();
            }

            $mensaje = '';

            if ($contador > $lineaInicial) {
                $NUMERO++;
                $CuentaID = null;
                if (array_key_exists($colFECHA, $registro)) {
                    $FECHA = trim($registro[$colFECHA]);
                    $FECHA=trim(str_replace("'", "", $FECHA));
//                    echo $FECHA;
//                            die();
                    $valoresFecha = explode("/", $FECHA);
                    $dia =(int) $valoresFecha[0];
                    
                    if ($dia <10) {
                        $dia = '0'.$dia;
                    }
                    $FECHA =  $valoresFecha[2] . "-" . $valoresFecha[1] . "-" . $dia;
//                    
//                    echo $FECHA;
//                    die();
                } else {
                    $valido = false;
                    $pendientes[] = 'FECHA';
                }

                if (array_key_exists($colCUENTA, $registro)) {
                    $CUENTA = trim(($registro[$colCUENTA]));
                } else {
                    $valido = false;
                    $pendientes[] = 'CUENTA';
                }

                if (array_key_exists($colDOCUMENTO, $registro)) {
                    $DOCUMENTO = trim($registro[$colDOCUMENTO]);
                } else {
                    $valido = false;
                    $pendientes[] = 'DOCUMENTO';
                }
                if (array_key_exists($colDEBE, $registro)) {
                    $DEBE = trim(($registro[$colDEBE]));
                } else {
                    $valido = false;
                    $pendientes[] = 'DEBE';
                }
                if (array_key_exists($colHABER, $registro)) {
                    $HABER = trim(($registro[$colHABER]));
                } else {
                    $valido = false;
                    $pendientes[] = 'HABER';
                }

//                if (array_key_exists($colDESCRIPCION, $registro)) {
//                    $DESCRIPCION = trim(($registro[$colDESCRIPCION]));
//                } else {
//                    $valido = false;
//                    $pendientes[] = 'DESCRIPCION';
//                }

                if (array_key_exists($colASIENTO, $registro)) {
                    $ASIENTO = trim(($registro[$colASIENTO]));
                } else {
                   
                    
                    $valido = false;
                    $pendientes[] = 'ASIENTO';
                        
                   
                }

                if ($todas) {
                    if (array_key_exists($colTIPO, $registro)) {
                        $TIPO = trim(($registro[$colTIPO]));
                    } else {
                        $valido = false;
                        $pendientes[] = 'TIPO';
                    }


                    if (array_key_exists($colNUMERO, $registro)) {
                        $NUMERO = trim(($registro[$colNUMERO]));
                    } else {
                        
                        if ($ASIENTO) {
                       $colNUMERO =$colASIENTO;
                        $NUMERO = trim(($registro[$colNUMERO]));
                        } 
                        if (!$ASIENTO) {
                        $valido = false;
                        $pendientes[] = 'NUMERO';
                        }
                    }


                    if (array_key_exists($colDETALLE, $registro)) {
                        $DETALLE = trim(($registro[$colDETALLE]));
                    } else {
                        $valido = false;
                        $pendientes[] = 'DETALLE';
                    }
                }


                if ($valido == true) {

                    $validolI = TRUE;
                    $mensaje = " ";
                    $cuentaErp = CuentaErpContableQuery::create()->findOneByCuentaContable($CUENTA);

                    //        echo $CUENTA."<br>";
                    $lista['LINEA'] = $contador;
                 //   if ($cuentaErp) {
                        $DEBE = str_replace(",", "", $DEBE);
                        $HABER = str_replace(",", "", $HABER);
                        $saldo = $DEBE + $HABER;
                        if ($saldo > 0) {
                            $listaId[$ASIENTO] = $ASIENTO;
                            $lista['FECHA'] = $FECHA;
                            //  $lista['EXISTE'] = PartidaQuery::create()->filterByCodigo($ASIENTO)->count();
                            $lista['CUENTA'] = $CUENTA;
                            $lista['DOCUMENTO'] = $DOCUMENTO;
                            $lista['ASIENTO'] = $ASIENTO;
                            if ($cuentaErp) {
                                $lista['ID'] = $cuentaErp->getId();
                            } else {
                                $lista['ID'] = null;
                            }
                            $lista['DEBE'] = $DEBE;
                            $lista['HABER'] = $HABER;
                            $lista['TIPO'] = $TIPO;
                            $lista['NUMERO'] = $NUMERO;
                            $lista['DETALLE'] = $DETALLE;
                            $lista['DESCRIPCION'] = $DESCRIPCION;
                            IF ($cuentaErp) {
                            $lista['DESCRIPCION'] = $cuentaErp->getNombre();
                                
                            }
                            $lista['MENSAJE'] = $mensaje;
                            $lista['VALIDO'] = $validolI;
                            //  if ($contador <  44555) {
                            $datos[] = $lista;
                            $datosGrupo[$ASIENTO][] = $lista;
                            // }
                        }
                 //   }
                }
            }
        }

        $resultado['datosAgrupado'] = $datosGrupo;
        $resultado['datos'] = $datos;
        $resultado['valido'] = $valido;
        $resultado['pendiente'] = $pendientes;
        $resultado['lista'] = $listaId;
//        echo "<pre>";
//        print_r($resultado);
//        die();

        return $resultado;
    }

    public function save(PropelPDO $con = null) {
        $empresaId = UsuarioQuery::getEmpresaSeleccionada('CuentaErp');

        if ($this->isNew()) {
            if ($empresaId) {
                $this->setEmpresaId($empresaId);
            }
            if (trim($this->getCodigo()) == "") {
                $tipo = $empresaId . 'CTV';
                $pre = $empresaId . 'CTV';
                $numero = 1;
                $busca = CorrelativoCodigoQuery::create()
                        ->filterByTipo($tipo)
                        ->findOne();
                if (!$busca) {
                    $busca = New CorrelativoCodigo();
                    $busca->setTipo($tipo);
                    $busca->setPrefijo($pre);
                    $busca->setNumeroAsginar($numero);
                    $busca->save();
                }
                $numero = $busca->getNumeroAsginar();
                $numero = $busca->getNumeroAsginar();
                $prefijo = $pre . $numero;
                if (strlen($numero) == 1) {
                    $prefijo = $pre . '0' . $numero;
                }
                if ($numero > 99) {
                    $prefijo = $pre . $numero;
                }
                $this->setCodigo($prefijo);
                $busca->setNumeroAsginar($numero + 1);
                $busca->save();
            }
        }
        $triger = sfContext::getInstance()->getUser()->getAttribute('activa', null, 'triger');
        if ($triger <> 3) {
            $this->setStatus(0);
        }
        parent::save($con);
    }



}
