<?php

/**
 * Skeleton subclass for representing a row from the 'parametro' table.
 *
 *
 *
 * This class was autogenerated by Propel 1.6.7 on:
 *
 * 01/11/22 01:11:37
 *
 * You should add additional methods to this class to meet the
 * application requirements.  This class will only be generated as
 * long as it does not already exist in the output directory.
 *
 * @package    propel.generator.lib.model
 */
class Parametro extends BaseParametro {

    
        static public function xml_to_array($texto) {
            $xml = '<?xml version="1.0" encoding="UTF-8" ?>
<rss>' . $texto . '
</rss>';
        $texto = simplexml_load_string($xml);
        $lista = null;
        foreach ($texto as $regi) {
            $dt = null;
            foreach ($regi->attributes() as $a => $b) {

                $dt[$a] = (string) $b;
            }
            $lista[] = $dt;
        }
        return $lista;
        }
        
        
    static public function ProximoFechaPago($fecha, $dias, $diaPago = 5) {


        $nuevaFecha = date("Y-m-d", strtotime($fecha . "+ " . $dias . " days"));
        $diaSemana2 = date("w", strtotime($fecha . "+ " . $dias . " days"));
//        echo "Fecha  " . $fecha;
//        echo "<br>";
//        echo "dias " . $dias;
//        echo "<br>";
//        echo "nueva fecha " . $nuevaFecha;
//        echo "<br>";
//        echo "dia de la semana " . $diaSemana2;
//        echo "<HR>";

        if ($diaSemana2 <> $diaPago) {
            $diasSuma = $dias + 1;  // 0
            $nuevaFecha = date("Y-m-d", strtotime($fecha . "+ " . $diasSuma . " days"));
            $diaSemana2 = date("w", strtotime($fecha . "+ " . $diasSuma . " days"));
//        echo "Fecha  " . $fecha;
//        echo "<br>";
//        echo "dias " . $diasSuma;
//        echo "<br>";
//        echo "nueva fecha " . $nuevaFecha;
//        echo "<br>";
//        echo "dia de la semana " . $diaSemana2;
//        echo "<HR>";
        }
        if ($diaSemana2 <> $diaPago) {
            $diasSuma = $dias + 2;  //1
            $nuevaFecha = date("Y-m-d", strtotime($fecha . "+ " . $diasSuma . " days"));
            $diaSemana2 = date("w", strtotime($fecha . "+ " . $diasSuma . " days"));
//        echo "Fecha  " . $fecha;
//        echo "<br>";
//        echo "dias " . $diasSuma;
//        echo "<br>";
//        echo "nueva fecha " . $nuevaFecha;
//        echo "<br>";
//        echo "dia de la semana " . $diaSemana2;
//        echo "<HR>";
        }
        if ($diaSemana2 <> $diaPago) {
            $diasSuma = $dias + 3;  //2
            $nuevaFecha = date("Y-m-d", strtotime($fecha . "+ " . $diasSuma . " days"));
            $diaSemana2 = date("w", strtotime($fecha . "+ " . $diasSuma . " days"));
//        echo "Fecha  " . $fecha;
//        echo "<br>";
//        echo "dias " . $diasSuma;
//        echo "<br>";
//        echo "nueva fecha " . $nuevaFecha;
//        echo "<br>";
//        echo "dia de la semana " . $diaSemana2;
//        echo "<HR>";
        }
        if ($diaSemana2 <> $diaPago) {
            $diasSuma = $dias + 4;  //3
            $nuevaFecha = date("Y-m-d", strtotime($fecha . "+ " . $diasSuma . " days"));
            $diaSemana2 = date("w", strtotime($fecha . "+ " . $diasSuma . " days"));
//        echo "Fecha  " . $fecha;
//        echo "<br>";
//        echo "dias " . $diasSuma;
//        echo "<br>";
//        echo "nueva fecha " . $nuevaFecha;
//        echo "<br>";
//        echo "dia de la semana " . $diaSemana2;
//        echo "<HR>";
        }
        if ($diaSemana2 <> $diaPago) {
            $diasSuma = $dias + 5;  //4
            $nuevaFecha = date("Y-m-d", strtotime($fecha . "+ " . $diasSuma . " days"));
            $diaSemana2 = date("w", strtotime($fecha . "+ " . $diasSuma . " days"));
//        echo "Fecha  " . $fecha;
//        echo "<br>";
//        echo "dias " . $diasSuma;
//        echo "<br>";
//        echo "nueva fecha " . $nuevaFecha;
//        echo "<br>";
//        echo "dia de la semana " . $diaSemana2;
//        echo "<HR>";
        }
        if ($diaSemana2 <> $diaPago) {
            $diasSuma = $dias + 6;  // 5
            $nuevaFecha = date("Y-m-d", strtotime($fecha . "+ " . $diasSuma . " days"));
            $diaSemana2 = date("w", strtotime($fecha . "+ " . $diasSuma . " days"));
//        echo "Fecha  " . $fecha;
//        echo "<br>";
//        echo "dias " . $diasSuma;
//        echo "<br>";
//        echo "nueva fecha " . $nuevaFecha;
//        echo "<br>";
//        echo "dia de la semana " . $diaSemana2;
//        echo "<HR>";
        }
        if ($diaSemana2 <> $diaPago) {
            $diasSuma = $dias + 7;  //6
            $nuevaFecha = date("Y-m-d", strtotime($fecha . "+ " . $diasSuma . " days"));
            $diaSemana2 = date("w", strtotime($fecha . "+ " . $diasSuma . " days"));
//        echo "Fecha  " . $fecha;
//        echo "<br>";
//        echo "dias " . $diasSuma;
//        echo "<br>";
//        echo "nueva fecha " . $nuevaFecha;
//        echo "<br>";
//        echo "dia de la semana " . $diaSemana2;
//        echo "<HR>";
        }

        return $nuevaFecha;
    }

    static public function formato($valor, $moneda = true) {
        $valor = number_format((float) ($valor), 2, '.', ',');
        $empresaId = sfContext::getInstance()->getUser()->getAttribute("empresa", null, 'seguridad');
        $empreaq = EmpresaQuery::create()->findOneById($empresaId);
        if ($moneda) {
            if ($empreaq) {
                $valor = "<strong>" . $empreaq->getMonedaQ() . "</strong>&nbsp;" . $valor;
            }
        }
        return $valor;
    }

    static public function ValorCampo($Campoid, $tipo, $opera) {
        $valor = '';
        $query = ValorUsuarioQuery::create()
                ->filterByCampoUsuarioId($Campoid)
                ->filterByTipoDocumento($tipo)
                ->filterByNoDocumento($opera)
                ->findOne();
        if ($query) {
            $valor = $query->getValor();
        }
        return $valor;
    }

    static public function valormes($mes) {
        $mes = (int) $mes;
        $data[1] = 'Enero';
        $data[2] = 'Febrero';
        $data[3] = 'Marzo';
        $data[4] = 'Abril';
        $data[5] = 'Mayo';
        $data[6] = 'Junio';
        $data[7] = 'Julio';
        $data[8] = 'Agosto';
        $data[9] = 'Septiembre';
        $data[10] = 'Octubre';
        $data[11] = 'Noviembre';
        $data[12] = 'Diciembre';
        return $data[$mes];
    }

    static public function CabeceraPartida($PARTIDAaPERTURA) {
        ////  PARTIDA APERTURA CABECERA
        $PARTIDASMES = PartidaQuery::create()
                ->filterByConfirmada(true)
                ->filterByCodigo($PARTIDAaPERTURA)
                ->groupByMes()
                ->groupByAno()
                ->find();
        foreach ($PARTIDASMES as $registro) {
            $fechaContable = $registro->getFechaContable('Y-m-01');
            $cierre = date("01-m-Y", strtotime($fechaContable . "+ 1 month"));
            $fechaFin = date("Y-m-d", strtotime($cierre . "- 1 days"));
            $mes = $registro->getFechaContable('m');
            $ano = $registro->getAno();
            $asientoAPERTURA = $ano . "000" . $mes;
            $partidaAgrupada = PartidaAgrupaQuery::create()->findOneByCodigo($asientoAPERTURA);
            if (!$partidaAgrupada) {
                $partidaAgrupada = new PartidaAgrupa();
                $partidaAgrupada->setCodigo($asientoAPERTURA);
                $partidaAgrupada->setRevisado(false);
            }
            $partidaAgrupada->setFechaContable($fechaContable);
            $partidaAgrupada->setDetalle("Apertura" . " " . $ano);
            $partidaAgrupada->save();
        }
        /// FIN PARTIDA APERTURA CABECERA
        /// INICIO PARTIDA CABECERA
        $PARTIDASMES = PartidaQuery::create()
                ->filterByConfirmada(true)
                ->filterByCodigo($PARTIDAaPERTURA, Criteria::NOT_IN)
                ->groupByMes()
                ->groupByAno()
                ->find();
        foreach ($PARTIDASMES as $registro) {
            $fechaContable = $registro->getFechaContable('Y-m-01');
            $cierre = date("01-m-Y", strtotime($fechaContable . "+ 1 month"));
            $fechaFin = date("Y-m-d", strtotime($cierre . "- 1 days"));
            $mes = $registro->getFechaContable('m');
            $ano = $registro->getAno();
            $asiento = $ano . "000" . $mes;
            $asiento = $asiento + 1;
                      $empresaId = sfContext::getInstance()->getUser()->getAttribute("empresa", null, 'seguridad');
      
            $partidaAgrupada = PartidaAgrupaQuery::create()->findOneByCodigo($asiento);
            if (!$partidaAgrupada) {
                $partidaAgrupada = new PartidaAgrupa();
                $partidaAgrupada->setCodigo($asiento);
                $partidaAgrupada->setRevisado(false);
            }
            $partidaAgrupada->setEmpresaId($empresaId);
            $partidaAgrupada->setMes($mes);
            $partidaAgrupada->setAno($ano);
            $partidaAgrupada->setFechaContable($fechaFin);
            $partidaAgrupada->setDetalle("Movimientos " . Parametro::valormes($mes) . " " . $ano);
            $partidaAgrupada->save();
        }
        // FIN  PARTIDA APERTURA
        return $asientoAPERTURA;
    }

    static public function PartidaAgrupaApertura($asientoAPERTURA, $PARTIDAaPERTURA) {
        /// DETALLE  DE  PARTIDA APERTURA 
        $partidaAgrupa = PartidaAgrupaQuery::create()
                ->filterByCodigo($asientoAPERTURA)
                ->filterByRevisado(false)
                ->find();
        foreach ($partidaAgrupa as $agrupa) {
            $mes = (int) $agrupa->getFechaContable('m');
            $ano = (int) $agrupa->getFechaContable('Y');
            $agrupaID = $agrupa->getId();
            $partidaQuer = PartidaQuery::create()
                    ->filterByConfirmada(true)
                    ->filterByCodigo($PARTIDAaPERTURA)
                    ->filterByMes($mes)
                    ->filterByAno($ano)
                    ->select(array('Id'))
                    ->find();
            $listaID = null;
            $listaID[] = 0;
            foreach ($partidaQuer as $partida) {
                $listaID[] = (int) $partida;
            }

//            echo "<pre>";
//            print_r($listaID);
//            echo "<pre>";
            $PartidasLinea = PartidaDetalleQuery::create()
                    ->usePartidaQuery()
                    ->filterById($listaID, Criteria::IN)
                    ->endUse()
                    ->withColumn('count(PartidaDetalle.Id)', 'Cantidad')
                    ->withColumn('sum(PartidaDetalle.Haber)', 'TotalHaber')
                    ->withColumn('sum(PartidaDetalle.Debe)', 'TotalDebe')
                    ->groupByCuentaContable()
                    ->find();

            foreach ($PartidasLinea as $linea) {
                $totalHaber = round($linea->getTotalHaber(), 2);
                $totalDebe = round($linea->getTotalDebe(), 2);
                $cuenta = $linea->getCuentaContable();
                $detalle = $linea->getDetalle();
                $cantidad = $linea->getCantidad();
//                echo "<strong>" . $cantidad . "</strong> " . $agrupa->getCodigo() . " -->  " . $cuenta . " " . $totalHaber . " -->  " . $totalDebe;
//                echo "<br>";
//                $GRANtotal_DEBE=0;
//                $GRANtotal_HABER=0;
//           $resta = $totalDebe-$totalHaber;
//           if ($resta >0) {
//               $GRANtotal_DEBE=$resta;
//           }
//           if ($resta <0) {
//               $GRANtotal_HABER=$resta*-1;
//           }
                $partidaLinea = PartidaAgrupaLineaQuery::create()
                        ->filterByCuentaContable($cuenta)
                        ->filterByPartidaAgrupaId($agrupaID)
                        ->findOne();
                if (!$partidaLinea) {
                    $partidaLinea = new PartidaAgrupaLinea();
                    $partidaLinea->setCuentaContable($cuenta);
                    $partidaLinea->setPartidaAgrupaId($agrupaID);
                }
                $partidaLinea->setDetalle($detalle);
                $partidaLinea->setCantidad($cantidad);
                $partidaLinea->setDebe($totalDebe);
                $partidaLinea->setHaber($totalHaber);
                $partidaLinea->save();
            }
//            $agrupa->setRevisado(true);
            //          $agrupa->save();
        }
        /// ** FIN PARTIDA CABECERA        
    }

    static public function PartidaAgrupaDetalle($asientoAPERTURA, $PARTIDAaPERTURA, $MES_N = 0, $ANO_N = 0) {
        /// PARTIDA CABECERA        
        $partidaAgrupa = PartidaAgrupaQuery::create()
                ->filterByCodigo($asientoAPERTURA, Criteria::NOT_EQUAL)
                ->filterByRevisado(false)
                ->find();
        if (($MES_N > 0) && ($ANO_N > 0)) {
            $partidaAgrupa = PartidaAgrupaQuery::create()
                    ->filterByCodigo($asientoAPERTURA, Criteria::NOT_EQUAL)
                    ->filterByRevisado(false)
                    ->filterByMes($MES_N)
                    ->filterByAno($ANO_N)
                    ->find();
        }


        foreach ($partidaAgrupa as $agrupa) {
            $mes = (int) $agrupa->getFechaContable('m');
            $ano = (int) $agrupa->getFechaContable('Y');
            $agrupaID = $agrupa->getId();
            $partidaQuer = PartidaQuery::create()
                    ->filterByConfirmada(true)
                    ->filterByCodigo($PARTIDAaPERTURA, Criteria::NOT_EQUAL)
                    ->filterByMes($mes)
                    ->filterByAno($ano)
                    ->select(array('Id'))
                    ->find();
            $listaID = null;
            $listaID[] = 0;
            foreach ($partidaQuer as $partida) {
                $listaID[] = (int) $partida;
            }
//            echo "<pre>";
//            print_r($listaID);
//            echo "<pre>";
            $PartidasLinea = PartidaDetalleQuery::create()
                    ->usePartidaQuery()
                    ->filterById($listaID, Criteria::IN)
                    ->endUse()
                    ->withColumn('count(PartidaDetalle.Id)', 'Cantidad')
                    ->withColumn('sum(PartidaDetalle.Haber)', 'TotalHaber')
                    ->withColumn('sum(PartidaDetalle.Debe)', 'TotalDebe')
                    ->groupByCuentaContable()
                    ->find();
            foreach ($PartidasLinea as $linea) {
                $totalHaber = round($linea->getTotalHaber(), 2);
                $totalDebe = round($linea->getTotalDebe(), 2);
                $cuenta = $linea->getCuentaContable();
                $detalle = $linea->getDetalle();
                $cantidad = $linea->getCantidad();
//                echo "<strong>" . $cantidad . "</strong> " . $agrupa->getCodigo() . " -->  " . $cuenta . " " . $totalHaber . " -->  " . $totalDebe;
//                echo "<br>";
                $partidaLinea = PartidaAgrupaLineaQuery::create()
                        ->filterByCuentaContable($cuenta)
                        ->filterByPartidaAgrupaId($agrupaID)
                        ->findOne();
                if (!$partidaLinea) {
                    $partidaLinea = new PartidaAgrupaLinea();
                    $partidaLinea->setCuentaContable($cuenta);
                    $partidaLinea->setPartidaAgrupaId($agrupaID);
                }

                $GRANtotal_DEBE = 0;
                $GRANtotal_HABER = 0;
                $resta = $totalDebe - $totalHaber;
                if ($resta > 0) {
                    $GRANtotal_DEBE = $resta;
                }
                if ($resta < 0) {
                    $GRANtotal_HABER = $resta * -1;
                }
                $GRANtotal_DEBE = round($GRANtotal_DEBE, 2);
                $GRANtotal_HABER = round($GRANtotal_HABER, 2);

                
                $partidaLinea->setDetalle($detalle);
                $partidaLinea->setCantidad($cantidad);
                $partidaLinea->setDebe($GRANtotal_DEBE);
                $partidaLinea->setHaber($GRANtotal_HABER);
                $partidaLinea->save();
            }
//            $agrupa->setRevisado(true);
            //          $agrupa->save();
        }
        return count($listaID);
    }

}
