<?php

/**
 * Skeleton subclass for representing a row from the 'gasto' table.
 *
 *
 *
 * This class was autogenerated by Propel 1.6.7 on:
 *
 * 01/25/22 02:38:53
 *
 * You should add additional methods to this class to meet the
 * application requirements.  This class will only be generated as
 * long as it does not already exist in the output directory.
 *
 * @package    propel.generator.lib.model
 */
class Gasto extends BaseGasto {

    static public function pobladatos($id) {
        $usuarioId = sfContext::getInstance()->getUser()->getAttribute('usuario', null, 'seguridad');
        $usuarioQue = UsuarioQuery::create()->findOneById($usuarioId);
        $empresaId = $usuarioQue->getEmpresaId();
        $lineaInicial = 2;
        header('Content-type: text/plain; charset=utf-8');
        $bitacora = BitacoraArchivoQuery::create()->findOneById($id);
        sfContext::getInstance()->getUser()->setAttribute('muestrabusqueda', 0, 'busqueda');
        $filename = $bitacora->getNombre();
        $inputFileName = sfConfig::get("sf_upload_dir") . DIRECTORY_SEPARATOR . 'cargas' . DIRECTORY_SEPARATOR . $filename;
        $objReader = new PHPExcel_Reader_Excel5();
        $objPHPExcel = $objReader->load($inputFileName);
        $sheetData = $objPHPExcel->getActiveSheet()->toArray(null, true, true, true);
        $contador = 0;

        $colSERIE = null;
        $colFACTURA = null;
        $colFECHA = null;
        $colDESCRIPCION = null;
        $colCODIGO_PROVEEDOR = null;
        $colPROVEEDOR = null;
        $colCUENTA = null;
        $colNOMBRE_CUENTA = null;
        $colVALOR = null;
        $colaplica_iva = null;
        $colretiene_isr = null;
        $colexento_isr = null;
        $colIDP = null;
//        echo "<pre>";
//        print_r($sheetData);

        $NUMERO = 0;
        $totalCorrecto = 0;
        foreach ($sheetData as $registro) {
            $lista = null;
            $IDP = null;
            $FECHA = null;
            $SERIE = null;
            $FACTURA = null;
            $DESCRIPCION = null;
            $CODIGO_PROVEEOR = null;
            $PROVEEDOR = null;
            $CUENTA = NULL;
            $NOMBRECUENTA = NULL;
            $aplica_iva = null;
            $retiene_isr = null;
            $exento_isr = null;
            $VALOR = 0;
            $valido = true;
            $contador++;
            $textoPendiente = '';
            $pendientes = null;
            $lin = $lineaInicial;

            /// encabezado
            //   echo PlantillaCampoQuery::campo($empresaId, 'codigo_sku');
            if ($contador == $lineaInicial) {
                for ($i = 0; $i <= 14; $i++) {
                    $letra = CorrelativoCodigoQuery::numeroletra($i); //sfContext::getInstance()->getUser()->numeroletra($i);
                    $campo = trim(strtoupper(($registro[$letra])));
                    $campo = ($campo);
//                    $campo = ProveedorPeer::limpiatil($campo);
                    $campo = trim(strtoupper($campo));
                    $campo = str_replace(" ", "", $campo); //                  
//                         echo $campo;
//                        echo " ------------- ";
                    switch ($campo) {
                        case 'SERIE':
                            $colSERIE = $letra;
                            break;
                        case 'FACTURA':
                            $colFACTURA = $letra;
                            break;
                        case 'FECHA':
                            $colFECHA = $letra;
                            break;
                        case 'DESCRIPCION':
                            $colDESCRIPCION = $letra;
                            break;
                        case 'CODIGOPROVEEDOR':
                            $colCODIGO_PROVEEDOR = $letra;
                            break;
                        case 'PROVEEDOR':
                            $colPROVEEDOR = $letra;
                            break;
                        case 'CUENTA':
                            $colCUENTA = $letra;
                            break;
                        case 'NOMBRECUENTA':
                            $colNOMBRE_CUENTA = $letra;
                            break;
                        case 'VALOR':
                            $colVALOR = $letra;
                            break;
                        case 'APLICAIVA':
                            $colaplica_iva = $letra;
                            break;
                        case 'RETIENEIVA':
                            $colretiene_isr = $letra;
                            break;
                        case 'EXENTOISR':
                            $colexento_isr = $letra;
                            break;
                        case 'IDP':
                            $colIDP = $letra;
                            break;
                    }
                }
                //     die();
            }

            $mensaje = '';

            if ($contador > $lineaInicial) {
                $NUMERO++;
                $CuentaID = null;
                if (array_key_exists($colSERIE, $registro)) {
                    $SERIE = trim(($registro[$colSERIE]));
                } else {
                    $valido = false;
                    $pendientes[] = 'SERIE';
                }
                if (array_key_exists($colFACTURA, $registro)) {
                    $FACTURA = trim(($registro[$colFACTURA]));
                } else {
                    $valido = false;
                    $pendientes[] = 'FACTURA';
                }
                if (array_key_exists($colFECHA, $registro)) {
                    $FECHA = trim(($registro[$colFECHA]));
                } else {
                    $valido = false;
                    $pendientes[] = 'FECHA';
                }
                if (array_key_exists($colDESCRIPCION, $registro)) {
                    $DESCRIPCION = trim(($registro[$colDESCRIPCION]));
                } else {
                    $valido = false;
                    $pendientes[] = 'DESCRIPCION';
                }
                if (array_key_exists($colCODIGO_PROVEEDOR, $registro)) {
                    $CODIGO_PROVEEOR = trim(($registro[$colCODIGO_PROVEEDOR]));
                } else {
                    $valido = false;
                    $pendientes[] = 'CODIGO PROVEEDOR';
                }
                if (array_key_exists($colPROVEEDOR, $registro)) {
                    $PROVEEDOR = trim(($registro[$colPROVEEDOR]));
                } else {
                    $valido = false;
                    $pendientes[] = 'PROVEEDOR';
                }
                if (array_key_exists($colCUENTA, $registro)) {
                    $CUENTA = trim(($registro[$colCUENTA]));
                } else {
                    $valido = false;
                    $pendientes[] = 'CUENTA';
                }
                if (array_key_exists($colNOMBRE_CUENTA, $registro)) {
                    $NOMBRECUENTA = trim(($registro[$colNOMBRE_CUENTA]));
                } else {
                    $valido = false;
                    $pendientes[] = 'NOMBRE CUENTA';
                }
                if (array_key_exists($colVALOR, $registro)) {
                    $VALOR = trim(($registro[$colVALOR]));
                } else {
                    $valido = false;
                    $pendientes[] = 'VALOR';
                }

                if (array_key_exists($colexento_isr, $registro)) {
                    $exento_isr = trim(($registro[$colexento_isr]));
                } else {
                    $valido = false;
                    $pendientes[] = 'EXENTO ISR';
                }

                if (array_key_exists($colaplica_iva, $registro)) {
                    $aplica_iva = trim(($registro[$colaplica_iva]));
                } else {
                    $valido = false;
                    $pendientes[] = 'APLICA IVA';
                }

                if (array_key_exists($colretiene_isr, $registro)) {
                    $retiene_isr = trim(($registro[$colretiene_isr]));
                } else {
                    $valido = false;
                    $pendientes[] = 'RETIENE IVA';
                }

                if (array_key_exists($colIDP, $registro)) {
                    $IDP = trim(($registro[$colIDP]));
                } else {
                    $valido = false;
                    $pendientes[] = 'IDP';
                }



                if ($valido == true) {
                    $VALOR = trim(str_replace(",", "", $VALOR));
                    if (!is_numeric($VALOR)) {
                        $VALOR = 0;
                    }

                    $IDP = trim(str_replace(",", "", $IDP));
                    if (!is_numeric($IDP)) {
                        $IDP = 0;
                    }


                    $excento = false;
                    $retieneISR = false;
                    $excentoIsr = false;

                    if ($aplica_iva <> "1") {
                        $excento = true;
                    }
                    if ($retiene_isr == "1") {
                        $retieneISR = true;
                    }
                    if ($exento_isr == "1") {
                        $excentoIsr = true;
                    }


                    $tipoRegi = '';
                    $validolI = 1;
                    $mensaje = " ";
                    $cuentaErp = CuentaErpContableQuery::create()->findOneByCuentaContable($CUENTA);
                    $queryPro = ProveedorQuery::create()->findOneByCodigo($CODIGO_PROVEEOR);


                    $lista['LINEA'] = $contador;
                    $lista['PROVEEDORID'] = NULL;
                    //    if ($cuentaErp) {
                    $lista['SERIE'] = $SERIE;
                    //  $lista['EXISTE'] = PartidaQuery::create()->filterByCodigo($ASIENTO)->count();
                    $lista['FACTURA'] = $FACTURA;
                    $lista['FECHA'] = $FECHA;
                    $lista['DESCRIPCION'] = $DESCRIPCION;
                    $lista['CODIGO_PROVEEDOR'] = $CODIGO_PROVEEOR;
                    if ($queryPro) {
                        $tipoRegi = $queryPro->getRegimenIsr();
                        $lista['PROVEEDOR'] = $queryPro->getNombre();
                        $lista['PROVEEDORID'] = $queryPro->getId();
                    }

                    if (!$queryPro) {
                        $lista['DESCRIPCION'] = '';
                        $lista['CODIGO_PROVEEDOR'] = '';
//                    $validolI=0;
//                    $lista['PROVEEDOR'] = "<font color='red' size='-2'> *CODIGO PROVEEDOR NO EXISTE** </font>".$PROVEEDOR;
                    }
                    $lista['CUENTA'] = $CUENTA;
                    $lista['NOMBRE_CUENTA'] = $NOMBRECUENTA;
                    if ($cuentaErp) {
                        $lista['NOMBRE_CUENTA'] = $cuentaErp->getNombre();
                    }
                    if (!$cuentaErp) {
                        $lista['NOMBRE_CUENTA'] = "*<font color='red' size='-2'> NUMERO DE CUENTA NO EXISTE**  </font>" . $NOMBRECUENTA;
                        $validolI = 0;
                    }
                    if ($validolI == 1) {
                        $totalCorrecto = $totalCorrecto + $VALOR;
                    }
//                     $retieneISR = true, $excentoIsr=false
//                             echo $CODIGO_PROVEEOR." ".$tipoRegi;
//                             echo "<br>";
                    $valoresIva = ParametroQuery::ObtenerIva($VALOR , $excento, $retieneISR, $excentoIsr, $tipoRegi, false, $IDP);

                    $lista['VALOR'] = $VALOR;
                    $lista['IVA'] = $valoresIva['IVA'];
                    $lista['VALOR_ISR'] = $valoresIva['VALOR_ISR'];
                    $lista['VALOR_RETIENE_IVA'] = $valoresIva['VALOR_RETIENE_IVA'];
                    $lista['VALOR'] = $VALOR;
                    $lista['VALOR'] = $VALOR;
                    $lista['VALOR'] = $VALOR;
                    $lista['APLICA_IVA'] = true;
                    if ($aplica_iva <> "1") {
                        $lista['APLICA_IVA'] = false;
                    }
                    $lista['EXENTO_ISR'] = $excentoIsr;
                    $lista['RETIENE_ISR'] = $retieneISR;
                    $lista['IDP'] = $IDP;
                    $lista['VALIDO'] = $validolI;

                    $datos[$NUMERO] = $lista;
                }
            }
        }


//    
        $resultado['total'] = $totalCorrecto;
        $resultado['datos'] = $datos;
        $resultado['valido'] = $valido;
        $resultado['pendiente'] = $pendientes;
        if ($valido) {
            sfContext::getInstance()->getUser()->setAttribute('seledatos', serialize($datos), 'carga');
        }
//        echo "<pre>";
//print_r($resultado);
//echo "</pre>";
//die();
        return $resultado;
    }

    public function getConcepto() {
        $retorna = '';
        $gastoDeta = GastoDetalleQuery::create()
                ->filterByGastoId($this->getId())
                ->find();
        $lis = null;
        foreach ($gastoDeta as $deta) {
            $lis[] = $deta->getConcepto();
        }

        if ($lis) {
            $retorna = implode(",", $lis);
        }
 $codi= strtoupper(substr($this->getCodigo(),0,4));
        if ($codi=='CAJA') {
       
             
            $gastoId = $this->getDocumento();
            $gastoId = trim(str_replace("GastoTienda", "", $gastoId));
                 $gastoCaja = GastoCajaQuery::create()->findOneById($gastoId);
                 $retorna ="GASTOS VARIOS ";
            if ($gastoCaja) {
                 $retorna ="GASTOS VARIOS ".$gastoCaja->getTienda()->getNombre();
                $retorna  .=" ".$gastoCaja->getConcepto()." ".$gastoCaja->getObservaciones();
            }
            
        }
        
        return $retorna;
    }

    public function save(PropelPDO $con = null) {
        $empresaId = UsuarioQuery::getEmpresaSeleccionada('Gasto');

        if ($this->isNew()) {
            if ($empresaId) {
                $this->setEmpresaId($empresaId);
            }
            if (trim($this->getCodigo()) == "") {
                $tipo = $empresaId . 'GGA';
                $pre = $empresaId . 'GGA';
                $numero = 1;
                $busca = CorrelativoCodigoQuery::create()
                        ->filterByTipo($tipo)
                        ->findOne();
                if (!$busca) {
                    $busca = New CorrelativoCodigo();
                    $busca->setTipo($tipo);
                    $busca->setPrefijo($pre);
                    $busca->setNumeroAsginar($numero);
                    $busca->save();
                }
                $numero = $busca->getNumeroAsginar();
                $numero = $busca->getNumeroAsginar();
                $prefijo = $pre . $numero;
                if (strlen($numero) == 1) {
                    $prefijo = $pre . '0' . $numero;
                }
                if ($numero > 99) {
                    $prefijo = $pre . $numero;
                }
                $this->setCodigo($prefijo);
                $busca->setNumeroAsginar($numero + 1);
                $busca->save();
            }
        }
        $this->setExcento(false);
        if (!$this->getAplicaIva()) {
            $this->setExcento(true);
        }

        parent::save($con);
    }

    public function getDetalle() {
        $return = $this->getObservaciones();

        if (trim($return) == "") {
            $opetalle = GastoDetalleQuery::create()->findOneByGastoId($this->getId());
            if ($opetalle) {
                $return = $opetalle->getConcepto();
            }
        }
        return $return;
    }

}
